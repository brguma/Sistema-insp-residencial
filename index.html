<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Inspe√ß√£o Residencial - v3.3 (Drive Pr√©-Configurado)</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Theme Color -->
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Inspe√ß√£o">
    
    <!-- Icons -->
    <link rel="icon" type="image/svg+xml" href="icon.svg">
    <link rel="apple-touch-icon" href="icon.svg">
    <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png">
    <link rel="apple-touch-icon" sizes="512x512" href="icon-512.png">
    <link rel="mask-icon" href="icon.svg" color="#667eea">
    <!-- Google Drive API Scripts -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <!-- jsPDF para gera√ß√£o de PDFs (mantido para compatibilidade) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- JSZip para gera√ß√£o de documentos DOCX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <!-- docx.js para gera√ß√£o de documentos DOCX - usando vers√£o est√°vel -->
    <script src="https://unpkg.com/docx@7.8.2/build/index.js"></script>
    <script>
        // Aguardar carregamento da biblioteca e verificar se est√° dispon√≠vel
        window.addEventListener('load', function() {
            setTimeout(function() {
                if (typeof docx !== 'undefined') {
                    console.log('‚úÖ Biblioteca docx carregada:', docx);
                } else {
                    console.warn('‚ö†Ô∏è Biblioteca docx n√£o encontrada ap√≥s carregamento');
                }
            }, 1000);
        });
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideIn 0.3s;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #333;
            margin-bottom: 10px;
        }

        .modal-options {
            display: grid;
            gap: 15px;
        }

        .option-card {
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .option-card:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .option-card h3 {
            color: #667eea;
            margin-bottom: 5px;
        }

        .option-card p {
            color: #666;
            font-size: 14px;
        }

        .inspection-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .inspection-item {
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .inspection-item:hover {
            background: #f8f9ff;
            border-color: #667eea;
        }

        .inspection-item.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .inspection-item-date {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .inspection-item-address {
            font-size: 14px;
            opacity: 0.8;
        }

        /* Info Icon Styles */
        .info-icon {
            display: inline-block;
            width: 18px;
            height: 18px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 18px;
            font-size: 12px;
            font-weight: bold;
            cursor: help;
            margin-left: 5px;
            position: relative;
        }

        .info-icon:hover {
            background: #764ba2;
        }

        .tooltip {
            display: none;
            position: absolute;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 13px;
            white-space: nowrap;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #333;
        }

        .info-icon:hover .tooltip {
            display: block;
        }

        /* Main Menu */
        .main-menu {
            padding: 30px;
            display: none;
        }

        .main-menu.active {
            display: block;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .menu-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .menu-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .menu-card i {
            font-size: 48px;
            margin-bottom: 15px;
            display: block;
        }

        .menu-card h3 {
            font-size: 18px;
            margin-bottom: 8px;
        }

        .menu-card p {
            font-size: 14px;
            opacity: 0.9;
        }

        /* Form Styles */
        .inspection-form {
            padding: 30px;
            display: none;
        }

        .inspection-form.active {
            display: block;
        }

        .form-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .form-section h3 {
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .inspection-type-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .badge-inicial {
            background: #4CAF50;
            color: white;
        }

        .badge-completa {
            background: #FF9800;
            color: white;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group input:disabled,
        .form-group select:disabled {
            background: #f0f0f0;
            cursor: not-allowed;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        /* Checklist Styles */
        .checklist-section {
            margin-bottom: 25px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }

        .checklist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .checklist-header h4 {
            color: #333;
            font-size: 18px;
        }

        .checklist-item {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            padding: 12px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            transition: background 0.3s;
        }

        .checklist-item:hover {
            background: #e9ecef;
        }

        .checklist-item-label {
            flex: 1;
            margin-right: 20px;
            color: #555;
            display: flex;
            align-items: center;
        }

        .checklist-options {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .check-option {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .check-option input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .check-option label {
            cursor: pointer;
            font-size: 14px;
            color: #666;
        }

        .observation-field {
            margin-top: 10px;
            display: none;
        }

        .observation-field.active {
            display: block;
        }

        .observation-field textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            resize: vertical;
            min-height: 60px;
        }

        /* Occurrence Items */
        .occurrence-item {
            padding: 15px;
            background: #f8f9ff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .occurrence-item:not(:first-child) {
            margin-top: 15px;
        }

        .occurrence-item textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            resize: vertical;
            min-height: 60px;
        }

        /* Photo Section */
        .photo-section {
            margin-top: 15px;
            padding: 15px;
            background: #fff;
            border: 2px dashed #667eea;
            border-radius: 8px;
            display: none;
        }

        .photo-section.active {
            display: block;
        }

        .photo-upload-area {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .photo-upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .photo-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .photo-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
        }

        .photo-item img {
            width: 100%;
            height: 100px;
            object-fit: cover;
        }

        .photo-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255,0,0,0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
        }

        /* Buttons */
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Login Screen */
        .login-screen {
            padding: 50px 30px;
            text-align: center;
        }

        .login-screen.active {
            display: block;
        }

        .login-btn {
            background: white;
            color: #667eea;
            padding: 15px 40px;
            border: 2px solid #667eea;
            border-radius: 30px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .login-btn:hover {
            background: #667eea;
            color: white;
            transform: scale(1.05);
        }

        /* Settings Screen */
        .settings-screen {
            padding: 30px;
            display: none;
        }

        .settings-screen.active {
            display: block;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #667eea;
        }

        .settings-header h2 {
            color: #333;
            font-size: 24px;
        }

        .settings-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
            overflow-x: auto;
        }

        .settings-tab {
            padding: 12px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .settings-tab:hover {
            color: #667eea;
            background: #f8f9ff;
        }

        .settings-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .settings-content {
            display: none;
        }

        .settings-content.active {
            display: block;
        }

        .settings-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .settings-group h3 {
            color: #333;
            font-size: 18px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-item-info {
            flex: 1;
        }

        .settings-item-title {
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-bottom: 3px;
        }

        .settings-item-desc {
            font-size: 12px;
            color: #666;
        }

        .settings-item-control {
            margin-left: 20px;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: #667eea;
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        /* Select and Input in Settings */
        .settings-select,
        .settings-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            min-width: 150px;
        }

        .settings-select:focus,
        .settings-input:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        /* Connection Status */
        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #28a745;
        }

        .status-dot.disconnected {
            background: #dc3545;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .info-card {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .info-card h4 {
            color: #1976d2;
            margin-bottom: 5px;
        }

        .info-card p {
            color: #555;
            font-size: 14px;
            margin: 5px 0;
        }

        /* Tutorial Overlay */
        .tutorial-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .tutorial-overlay.active {
            display: flex;
        }

        .tutorial-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .tutorial-step {
            display: none;
        }

        .tutorial-step.active {
            display: block;
        }

        .tutorial-step h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .tutorial-step img {
            max-width: 100%;
            border-radius: 8px;
            margin: 15px 0;
        }

        .tutorial-progress {
            display: flex;
            gap: 5px;
            margin: 20px 0;
        }

        .tutorial-progress-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ddd;
        }

        .tutorial-progress-dot.active {
            background: #667eea;
        }

        .tutorial-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        /* Modal de escolha de foto (C√¢mera ou Galeria) */
        .photo-choice-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            animation: fadeIn 0.3s;
        }

        .photo-choice-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .photo-choice-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .photo-choice-content h3 {
            margin-bottom: 25px;
            color: #333;
            font-size: 20px;
        }

        .photo-choice-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .photo-choice-btn {
            padding: 18px;
            border: 2px solid #667eea;
            border-radius: 10px;
            background: white;
            color: #667eea;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .photo-choice-btn:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .photo-choice-btn.cancel {
            border-color: #6c757d;
            color: #6c757d;
            margin-top: 10px;
        }

        .photo-choice-btn.cancel:hover {
            background: #6c757d;
            color: white;
        }

        /* Modal da c√¢mera */
        .camera-modal {
            display: none;
            position: fixed;
            z-index: 2100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.95);
            animation: fadeIn 0.3s;
        }

        .camera-modal.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .camera-container {
            width: 100%;
            max-width: 500px;
            position: relative;
            background: #000;
            border-radius: 15px;
            overflow: hidden;
        }

        .camera-video {
            width: 100%;
            height: auto;
            display: block;
            /* C√¢mera traseira n√£o precisa espelhar */
        }

        .camera-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            padding: 30px 20px;
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .camera-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 4px solid white;
            background: rgba(255,255,255,0.3);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            transition: all 0.3s;
        }

        .camera-btn:hover {
            background: rgba(255,255,255,0.5);
            transform: scale(1.1);
        }

        .camera-btn.capture {
            background: white;
            width: 80px;
            height: 80px;
        }

        .camera-btn.close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: rgba(255,0,0,0.7);
            border: 2px solid white;
            font-size: 24px;
        }

        .camera-preview {
            display: none;
            width: 100%;
            max-width: 500px;
            position: relative;
            background: #000;
            border-radius: 15px;
            overflow: hidden;
        }

        .camera-preview.active {
            display: block;
        }

        .camera-preview img {
            width: 100%;
            height: auto;
            display: block;
            /* Imagem salva est√° correta (n√£o espelhada) */
        }

        .camera-preview-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            padding: 30px 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .camera-preview-btn {
            padding: 12px 20px;
            border: 2px solid white;
            border-radius: 25px;
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .camera-preview-btn:hover {
            background: white;
            color: #333;
        }

        .camera-preview-btn.use {
            background: #28a745;
            border-color: #28a745;
        }

        .camera-preview-btn.use:hover {
            background: #218838;
            border-color: #218838;
        }
    </style>
</head>
<body>
    <!-- Modal de escolha: C√¢mera ou Galeria -->
    <div id="photoChoiceModal" class="photo-choice-modal">
        <div class="photo-choice-content">
            <h3>üì∏ Como deseja adicionar a foto?</h3>
            <div class="photo-choice-buttons">
                <button class="photo-choice-btn" onclick="openCamera()">
                    üì∑ Tirar Foto
                </button>
                <button class="photo-choice-btn" onclick="openGallery()">
                    üñºÔ∏è Escolher da Galeria
                </button>
                <button class="photo-choice-btn cancel" onclick="closePhotoChoiceModal(true)">
                    ‚úñÔ∏è Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal da C√¢mera -->
    <div id="cameraModal" class="camera-modal">
        <div class="camera-container" id="cameraContainer">
            <button class="camera-btn close" onclick="closeCamera()" title="Fechar">√ó</button>
            <video id="cameraVideo" class="camera-video" autoplay playsinline></video>
            <div class="camera-controls">
                <button class="camera-btn capture" onclick="capturePhoto()" title="Tirar Foto">
                    üì∏
                </button>
            </div>
        </div>
        <div class="camera-preview" id="cameraPreview">
            <img id="capturedPhoto" alt="Foto capturada">
            <div class="camera-preview-controls">
                <button class="camera-preview-btn" onclick="retakePhoto()">üîÑ Tirar Outra</button>
                <button class="camera-preview-btn" onclick="cancelPhoto()">‚úñÔ∏è Cancelar</button>
                <button class="camera-preview-btn use" onclick="useCapturedPhoto()">‚úÖ Usar Esta Foto</button>
            </div>
        </div>
    </div>

    <!-- Input oculto para galeria -->
    <input type="file" id="galleryInput" accept="image/*" multiple style="display: none;">

    <div class="container">
        <div class="header">
            <h1>üè† Sistema de Inspe√ß√£o Residencial</h1>
            <p>Gerenciamento Completo de Vistorias</p>
            <p id="onlineStatus" style="font-size: 12px; margin-top: 5px; opacity: 0.9;">
                <span id="onlineIndicator">üü¢</span> <span id="onlineText">Online</span>
            </p>
        </div>

        <!-- Login Screen -->
        <div id="loginScreen" class="login-screen active">
            <div style="margin-bottom: 30px;">
                <h2 style="color: #333; margin-bottom: 10px;">üè† Sistema de Inspe√ß√£o Residencial</h2>
                <p style="color: #666;">Fa√ßa login para acessar o sistema</p>
            </div>
            
            <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #4CAF50;">
                <p style="color: #2e7d32; font-size: 13px; margin: 0; text-align: center;">
                    ‚úÖ <b>Sistema Sincronizado com Google Drive</b><br/>
                    Todas as inspe√ß√µes s√£o salvas automaticamente na nuvem
                </p>
            </div>
            
            <div style="background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Usu√°rio:</label>
                    <input type="text" id="loginUsername" placeholder="Digite seu usu√°rio" 
                           style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;"
                           onkeypress="if(event.key==='Enter') document.getElementById('loginPassword').focus()">
                </div>
                
                <div style="margin-bottom: 25px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Senha:</label>
                    <input type="password" id="loginPassword" placeholder="Digite sua senha" 
                           style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;"
                           onkeypress="if(event.key==='Enter') attemptLogin()">
                </div>
                
                <button onclick="attemptLogin()" 
                        style="width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.2s;"
                        onmouseover="this.style.transform='translateY(-2px)'" 
                        onmouseout="this.style.transform='translateY(0)'">
                    üîê Entrar no Sistema
                </button>
            </div>
            
            <p style="margin-top: 20px; color: #999; font-size: 12px; text-align: center;">
                Acesso restrito ‚Ä¢ Usu√°rios autorizados apenas
            </p>
            
            <button onclick="if(confirm('‚ö†Ô∏è ATEN√á√ÉO: Isso resetar√° TODOS os usu√°rios do sistema e criar√° apenas o usu√°rio admin padr√£o.\\n\\n‚ùå Os dados de login ser√£o perdidos!\\n‚úÖ As inspe√ß√µes n√£o ser√£o afetadas.\\n\\nDeseja continuar?')) { localStorage.removeItem(\'systemUsers\'); localStorage.removeItem(\'currentUser\'); location.reload(); }" 
                    style="margin-top: 15px; width: 100%; padding: 10px; background: #f44336; color: white; border: none; border-radius: 5px; font-size: 12px; cursor: pointer;">
                üîÑ Resetar Sistema de Login
            </button>
        </div>

        <!-- Admin Panel (User Management) -->
        <div id="adminPanel" class="settings-screen" style="display: none;">
            <div class="settings-header">
                <h2>üë§ Gerenciar Usu√°rios</h2>
                <button class="btn btn-secondary" onclick="closeAdminPanel()">‚Üê Voltar</button>
            </div>
            
            <div style="padding: 30px;">
                <!-- Add New User -->
                <div class="form-section" style="background: #f8f9fa; padding: 25px; border-radius: 10px; margin-bottom: 30px;">
                    <h3 style="margin-bottom: 20px; color: #667eea;">‚ûï Adicionar Novo Usu√°rio</h3>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Nome Completo:</label>
                        <input type="text" id="newUserName" placeholder="Ex: Jo√£o Silva" 
                               style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Usu√°rio:</label>
                        <input type="text" id="newUserUsername" placeholder="Ex: joao.silva" 
                               style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Senha:</label>
                        <input type="password" id="newUserPassword" placeholder="M√≠nimo 4 caracteres" 
                               style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="newUserIsAdmin" style="margin-right: 10px; width: 18px; height: 18px;">
                            <span style="font-weight: 600;">Administrador (pode gerenciar usu√°rios)</span>
                        </label>
                    </div>
                    
                    <button onclick="addNewUser()" class="btn btn-success" style="font-size: 16px; padding: 12px 30px;">
                        ‚úÖ Adicionar Usu√°rio
                    </button>
                </div>
                
                <!-- Users List -->
                <div class="form-section">
                    <h3 style="margin-bottom: 20px; color: #667eea;">üìã Usu√°rios Cadastrados</h3>
                    <div id="usersList"></div>
                </div>
            </div>
        </div>

        <!-- Main Menu -->
        <div id="mainMenu" class="main-menu">
            <div class="menu-grid">
                <div class="menu-card" onclick="showInspectionTypeModal()">
                    <i>üìã</i>
                    <h3>Nova Inspe√ß√£o</h3>
                    <p>Criar nova vistoria</p>
                </div>
                <div class="menu-card" onclick="showInspectionsList()">
                    <i>üìÅ</i>
                    <h3>Ver Inspe√ß√µes</h3>
                    <p>Hist√≥rico de vistorias</p>
                </div>
                <div class="menu-card" onclick="showSettings()">
                    <i>‚öôÔ∏è</i>
                    <h3>Configura√ß√µes</h3>
                    <p>Ajustes do sistema</p>
                </div>
                <div id="adminMenuButton" class="menu-card" onclick="showAdminPanel()" style="display: none;">
                    <i>üë§</i>
                    <h3>Gerenciar Usu√°rios</h3>
                    <p>Adicionar/remover usu√°rios</p>
                </div>
            </div>
            
            <!-- User Info -->
            <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px; text-align: center;">
                <p style="margin: 0; color: #666; font-size: 14px;">
                    üë§ Logado como: <strong id="currentUserDisplay"></strong>
                </p>
                <button onclick="logout()" class="btn btn-secondary" style="margin-top: 10px; font-size: 14px; padding: 8px 20px;">
                    üö™ Sair
                </button>
            </div>
        </div>

        <!-- Modal: Escolha do Tipo de Inspe√ß√£o -->
        <div id="inspectionTypeModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Escolha o Tipo de Inspe√ß√£o</h2>
                    <p style="color: #666; font-size: 14px;">Selecione o tipo de vistoria que deseja realizar</p>
                </div>
                <div class="modal-options">
                    <div class="option-card" onclick="startNewInspection('inicial')">
                        <h3>üèÅ Inspe√ß√£o Inicial</h3>
                        <p>Primeira vistoria do im√≥vel com dados b√°sicos e estruturais</p>
                    </div>
                    <div class="option-card" onclick="showInitialInspectionsList()">
                        <h3>üìä Inspe√ß√£o Completa</h3>
                        <p>Vistoria detalhada - requer inspe√ß√£o inicial pr√©via</p>
                    </div>
                </div>
                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn btn-secondary" onclick="closeInspectionTypeModal()">Cancelar</button>
                </div>
            </div>
        </div>

        <!-- Modal: Sele√ß√£o de Inspe√ß√£o Inicial -->
        <div id="selectInitialModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Selecione a Inspe√ß√£o Inicial</h2>
                    <p style="color: #666; font-size: 14px;">Escolha a inspe√ß√£o inicial deste im√≥vel para continuar</p>
                </div>
                <div id="initialInspectionsList" class="inspection-list">
                    <!-- Lista ser√° preenchida dinamicamente -->
                </div>
                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn btn-primary" onclick="continueWithSelectedInspection()" style="margin-right: 10px;">Continuar</button>
                    <button class="btn btn-secondary" onclick="closeSelectInitialModal()">Cancelar</button>
                </div>
            </div>
        </div>

        <!-- Tela: Banco de Dados de Inspe√ß√µes -->
        <div id="inspectionsDatabase" class="inspection-form" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>üìÅ Banco de Dados de Inspe√ß√µes</h2>
                <button class="btn btn-secondary" onclick="closeDatabaseView()">‚Üê Voltar ao Menu</button>
            </div>

            <!-- Filtros -->
            <div class="form-section">
                <h3>üîç Filtros</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Tipo de Inspe√ß√£o</label>
                        <select id="filterType" onchange="applyFilters()">
                            <option value="all">Todas</option>
                            <option value="inicial">Inspe√ß√£o Inicial</option>
                            <option value="completa">Inspe√ß√£o Completa</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Munic√≠pio</label>
                        <select id="filterCity" onchange="applyFilters()">
                            <option value="all">Todos</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Buscar por Endere√ßo</label>
                        <input type="text" id="filterAddress" placeholder="Digite o endere√ßo..." oninput="applyFilters()">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Quartos (m√≠nimo)</label>
                        <input type="number" id="filterQuartos" placeholder="M√≠nimo" min="0" onchange="applyFilters()">
                    </div>
                    <div class="form-group">
                        <label>√Årea Total (m¬≤) - M√≠nimo</label>
                        <input type="number" id="filterAreaMin" placeholder="M√≠nimo m¬≤" min="0" step="0.01" onchange="applyFilters()">
                    </div>
                    <div class="form-group">
                        <label>√Årea Total (m¬≤) - M√°ximo</label>
                        <input type="number" id="filterAreaMax" placeholder="M√°ximo m¬≤" min="0" step="0.01" onchange="applyFilters()">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Pavimentos (m√≠nimo)</label>
                        <input type="number" id="filterPavimentos" placeholder="M√≠nimo" min="1" onchange="applyFilters()">
                    </div>
                    <div class="form-group">
                        <label>Su√≠tes (m√≠nimo)</label>
                        <input type="number" id="filterSuites" placeholder="M√≠nimo" min="0" onchange="applyFilters()">
                    </div>
                    <div class="form-group">
                        <label>Tem Garagem?</label>
                        <select id="filterGaragem" onchange="applyFilters()">
                            <option value="all">Todas</option>
                            <option value="sim">Sim</option>
                            <option value="nao">N√£o</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tem Quintal?</label>
                        <select id="filterQuintal" onchange="applyFilters()">
                            <option value="all">Todas</option>
                            <option value="sim">Sim</option>
                            <option value="nao">N√£o</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top: 10px;">
                    <button class="btn btn-secondary" onclick="clearFilters()">üîÑ Limpar Filtros</button>
                </div>
            </div>

            <!-- Estat√≠sticas R√°pidas -->
            <div class="form-section">
                <div class="form-row">
                    <div class="stat-card" style="text-align: center; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; color: white;">
                        <div style="font-size: 32px; font-weight: bold;" id="dbTotalInspections">0</div>
                        <div>Total de Inspe√ß√µes</div>
                    </div>
                    <div class="stat-card" style="text-align: center; padding: 20px; background: #4CAF50; border-radius: 10px; color: white;">
                        <div style="font-size: 32px; font-weight: bold;" id="dbTotalInicial">0</div>
                        <div>Inspe√ß√µes Iniciais</div>
                    </div>
                    <div class="stat-card" style="text-align: center; padding: 20px; background: #FF9800; border-radius: 10px; color: white;">
                        <div style="font-size: 32px; font-weight: bold;" id="dbTotalCompleta">0</div>
                        <div>Inspe√ß√µes Completas</div>
                    </div>
                </div>
            </div>

            <!-- Lista de Inspe√ß√µes -->
            <div class="form-section">
                <h3>üìã Inspe√ß√µes Cadastradas</h3>
                <div id="inspectionsListContainer" style="max-height: 500px; overflow-y: auto;">
                    <!-- Lista ser√° preenchida dinamicamente -->
                </div>
            </div>
        </div>

        <!-- Inspection Form -->
        <div id="inspectionForm" class="inspection-form">
            <!-- Form will be generated dynamically -->
        </div>

        <!-- Settings Screen -->
        <div id="settingsScreen" class="settings-screen">
            <div class="settings-header">
                <h2>‚öôÔ∏è Configura√ß√µes</h2>
                <button class="btn btn-secondary" onclick="backToMenu()">‚Üê Voltar</button>
            </div>

            <!-- Tabs -->
            <div class="settings-tabs">
                <button class="settings-tab active" onclick="switchSettingsTab('drive')">üîó Google Drive</button>
                <button class="settings-tab" onclick="switchSettingsTab('preferences')">üé® Prefer√™ncias</button>
                <button class="settings-tab" onclick="switchSettingsTab('stats')">üìä Estat√≠sticas</button>
                <button class="settings-tab" onclick="switchSettingsTab('notifications')">üîî Notifica√ß√µes</button>
                <button class="settings-tab" onclick="switchSettingsTab('privacy')">üîí Privacidade</button>
                <button class="settings-tab" onclick="switchSettingsTab('custom')">üìù Customiza√ß√£o</button>
                <button class="settings-tab" onclick="switchSettingsTab('about')">‚ÑπÔ∏è Sobre</button>
            </div>

            <!-- Google Drive Tab -->
            <div id="tab-drive" class="settings-content active">
                <div class="settings-group">
                    <h3>Status da Conex√£o</h3>
                    <div class="connection-status">
                        <div class="status-dot" id="connectionDot"></div>
                        <div>
                            <div style="font-weight: 500;" id="connectionText">Verificando...</div>
                            <div style="font-size: 12px; color: #666;" id="connectionEmail"></div>
                        </div>
                    </div>
                    
                    <!-- Container para informa√ß√µes de armazenamento -->
                    <div id="driveStorageInfo"></div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="reconnectDrive()" id="btnReconnect">üîÑ Reconectar</button>
                        <button class="btn btn-secondary" onclick="disconnectDrive()" id="btnDisconnect">üö´ Desconectar</button>
                        <button class="btn btn-success" onclick="openDriveFolder()">üìÅ Ver Pasta</button>
                    </div>
                </div>

                <div class="settings-group">
                    <h3>Sincroniza√ß√£o</h3>
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <div class="settings-item-title">Sincronizar Agora</div>
                            <div class="settings-item-desc">For√ßar upload manual de todas as inspe√ß√µes</div>
                        </div>
                        <div class="settings-item-control">
                            <button class="btn btn-primary" onclick="syncWithDrive()">‚Üª Sincronizar</button>
                        </div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <div class="settings-item-title">√öltima Sincroniza√ß√£o</div>
                            <div class="settings-item-desc" id="lastSyncTime">Nunca</div>
                        </div>
                    </div>
                </div>

                <div class="settings-group" style="border: 3px solid #FF9800; background: #fff3cd;">
                    <h3 style="color: #FF9800;">üéØ Pasta Centralizada (Recomendado)</h3>
                    <div class="info-card" style="background: white; border-color: #FF9800;">
                        <h4 style="color: #FF9800;">üìå Como Configurar:</h4>
                        <p style="margin: 5px 0; line-height: 1.8; color: #333;">
                            <strong>1.</strong> Acesse o Drive do <code style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px;">brunomachado.bmconsultoria@gmail.com</code><br>
                            <strong>2.</strong> Crie uma pasta (ex: "Inspe√ß√µes BM Consultoria")<br>
                            <strong>3.</strong> Clique com bot√£o direito ‚Üí <strong>Compartilhar</strong><br>
                            <strong>4.</strong> Configure: <strong>"Qualquer pessoa com o link pode editar"</strong><br>
                            <strong>5.</strong> Abra a pasta no navegador<br>
                            <strong>6.</strong> Copie o ID da URL: <code style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px;">https://drive.google.com/drive/folders/<span style="color: #FF9800; font-weight: bold;">ID_AQUI</span></code><br>
                            <strong>7.</strong> Cole abaixo e clique em Salvar
                        </p>
                    </div>
                    <div style="margin-top: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #FF9800;">ID da Pasta Compartilhada:</label>
                        <input type="text" 
                               id="sharedFolderId" 
                               placeholder="Cole o ID da pasta aqui (ex: 1a2b3c4d5e6f7g8h9i0j)" 
                               style="width: 100%; padding: 12px; border: 2px solid #FF9800; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 13px;">
                        <p style="font-size: 12px; color: #856404; margin-top: 8px; font-weight: 500;">
                            ‚ö†Ô∏è Se configurado, TODAS as inspe√ß√µes de TODOS os inspetores ser√£o salvas nesta pasta compartilhada!
                        </p>
                    </div>
                    <div style="margin-top: 15px; display: flex; gap: 10px;">
                        <button class="btn btn-success" onclick="saveSharedFolderConfig()" style="font-weight: 600;">üíæ Salvar Configura√ß√£o</button>
                        <button class="btn btn-secondary" onclick="testSharedFolder()">üß™ Testar Acesso √† Pasta</button>
                    </div>
                </div>

                <div class="settings-group">
                    <h3>Configura√ß√£o de Pastas</h3>
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <div class="settings-item-title">Pasta Raiz</div>
                            <div class="settings-item-desc">Nome da pasta principal no Drive</div>
                        </div>
                        <div class="settings-item-control">
                            <input type="text" class="settings-input" id="folderRootName" value="Inspecoes_Residenciais">
                        </div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <div class="settings-item-title">Estrutura de Pastas</div>
                            <div class="settings-item-desc">Como organizar as pastas</div>
                        </div>
                        <div class="settings-item-control">
                            <select class="settings-select" id="folderStructure">
                                <option value="tipo-data-endereco">Tipo ‚Üí Data ‚Üí Endere√ßo</option>
                                <option value="data-tipo-endereco">Data ‚Üí Tipo ‚Üí Endere√ßo</option>
                                <option value="endereco-data">Endere√ßo ‚Üí Data</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-success" onclick="saveSettings()">üíæ Salvar Configura√ß√µes</button>
                    </div>
                </div>
            </div>

            <!-- Preferences Tab -->
            <div id="tab-preferences" class="settings-content">
                <div class="settings-group">
                    <h3>Apar√™ncia</h3>
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <div class="settings-item-title">Tema</div>
                            <div class="settings-item-desc">Modo claro ou escuro</div>
                        </div>
                        <div class="settings-item-control">
                            <select class="settings-select" id="theme" onchange="applyTheme(this.value)">
                                <option value="light">‚òÄÔ∏è Claro</option>
                                <option value="dark">üåô Escuro</option>
                            </select>
                        </div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <div class="settings-item-title">Tamanho da Fonte</div>
                            <div class="settings-item-desc">Ajustar legibilidade</div>
                        </div>
                        <div class="settings-item-control">
                            <select class="settings-select" id="fontSize" onchange="applyFontSize(this.value)">
                                <option value="small">Pequeno</option>
                                <option value="medium">M√©dio</option>
                                <option value="large">Grande</option>
                            </select>
                        </div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <div class="settings-item-title">Cor Principal</div>
                            <div class="settings-item-desc">Personalizar cor do sistema</div>
                        </div>
                        <div class="settings-item-control">
                            <input type="color" id="primaryColor" value="#667eea" onchange="applyPrimaryColor(this.value)">
                        </div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <div class="settings-item-title">Compactar Interface</div>
                            <div class="settings-item-desc">Mostrar mais itens na tela</div>
                        </div>
                        <div class="settings-item-control">
                            <label class="toggle-switch">
                                <input type="checkbox" id="compactMode" onchange="applyCompactMode(this.checked)">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <div class="settings-item-title">Ocultar Dicas e Tooltips</div>
                            <div class="settings-item-desc">Esconder √≠cones "i" explicativos</div>
                        </div>
                        <div class="settings-item-control">
                            <label class="toggle-switch">
                                <input type="checkbox" id="hideTooltips" onchange="applyHideTooltips(this.checked)">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <div class="settings-item-title">Modo Simplificado</div>
                            <div class="settings-item-desc">Interface com menos op√ß√µes</div>
                        </div>
                        <div class="settings-item-control">
                            <label class="toggle-switch">
                                <input type="checkbox" id="simpleMode" onchange="applySimpleMode(this.checked)">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="settings-group">
                    <h3>Fotos</h3>
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <div class="settings-item-title">Qualidade de Fotos</div>
                            <div class="settings-item-desc">Tamanho e qualidade ao salvar</div>
                        </div>
                        <div class="settings-item-control">
                            <select class="settings-select" id="photoQuality">
                                <option value="original">Original (Maior qualidade)</option>
                                <option value="high">Alta (Boa qualidade)</option>
                                <option value="medium">M√©dia (Equilibrado)</option>
                                <option value="low">Baixa (Menor tamanho)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <button class="btn btn-success" onclick="saveSettings()">üíæ Salvar Configura√ß√µes</button>
                </div>
            </div>

            <!-- Statistics Tab -->
            <div id="tab-stats" class="settings-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalInspections">0</div>
                        <div class="stat-label">Total de Inspe√ß√µes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="monthInspections">0</div>
                        <div class="stat-label">Este M√™s</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="todayInspections">0</div>
                        <div class="stat-label">Hoje</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalPhotos">0</div>
                        <div class="stat-label">Total de Fotos</div>
                    </div>
                </div>

                <div class="settings-group">
                    <h3>Problemas Mais Comuns</h3>
                    <div id="commonIssuesChart" style="padding: 20px;">
                        <canvas id="issuesCanvas" style="max-height: 300px;"></canvas>
                    </div>
                </div>

                <div class="settings-group">
                    <h3>Cidades Mais Inspecionadas</h3>
                    <div id="citiesList" style="padding: 10px;">
                        <!-- Will be populated by JS -->
                    </div>
                </div>

                <div class="settings-group">
                    <h3>Tempo M√©dio por Inspe√ß√£o</h3>
                    <div style="text-align: center; padding: 20px; font-size: 32px; color: #667eea;" id="avgTime">
                        -- min
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="exportStatistics()">üìä Exportar Estat√≠sticas</button>
                    <button class="btn btn-secondary" onclick="refreshStatistics()">üîÑ Atualizar</button>
                </div>
            </div>

            <!-- Notifications Tab -->
            <div id="tab-notifications" class="settings-content">
                <div class="settings-group">
                    <h3>Alertas</h3>
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <div class="settings-item-title">Avisar quando Drive est√° desconectado</div>
                            <div class="settings-item-desc">Notifica√ß√£o ao tentar salvar sem conex√£o</div>
                        </div>
                        <div class="settings-item-control">
                            <label class="toggle-switch">
                                <input type="checkbox" id="alertDriveDisconnected" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <div class="settings-item-title">Confirmar antes de sair sem salvar</div>
                            <div class="settings-item-desc">Evitar perda de dados</div>
                        </div>
                        <div class="settings-item-control">
                            <label class="toggle-switch">
                                <input type="checkbox" id="confirmBeforeExit" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <div class="settings-item-title">Sons de Confirma√ß√£o</div>
                            <div class="settings-item-desc">Sons ao salvar, tirar foto, etc</div>
                        </div>
                        <div class="settings-item-control">
                            <label class="toggle-switch">
                                <input type="checkbox" id="soundEffects" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <button class="btn btn-success" onclick="saveSettings()">üíæ Salvar Configura√ß√µes</button>
                </div>
            </div>

            <!-- Privacy Tab -->
            <div id="tab-privacy" class="settings-content">
                <div class="settings-group">
                    <h3>Armazenamento</h3>
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <div class="settings-item-title">Salvar somente no Drive</div>
                            <div class="settings-item-desc">N√£o manter c√≥pia local no navegador</div>
                        </div>
                        <div class="settings-item-control">
                            <label class="toggle-switch">
                                <input type="checkbox" id="driveOnly">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="info-card">
                    <h4>‚ö†Ô∏è Aten√ß√£o</h4>
                    <p>Se ativar "Salvar somente no Drive", os dados n√£o ficar√£o dispon√≠veis offline.</p>
                    <p>Certifique-se de ter boa conex√£o com internet ao usar o sistema.</p>
                </div>

                <div style="margin-top: 20px;">
                    <button class="btn btn-success" onclick="saveSettings()">üíæ Salvar Configura√ß√µes</button>
                </div>
            </div>

            <!-- Custom Tab -->
            <div id="tab-custom" class="settings-content">
                <div class="settings-group">
                    <h3>Campos Personalizados</h3>
                    <p style="margin-bottom: 15px; color: #666;">Adicione campos extras aos formul√°rios de inspe√ß√£o</p>
                    
                    <div id="customFieldsList">
                        <!-- Will be populated by JS -->
                    </div>

                    <button class="btn btn-primary" onclick="showAddCustomFieldModal()">‚ûï Adicionar Campo</button>
                </div>

                <div class="info-card">
                    <h4>üí° Dica</h4>
                    <p>Campos personalizados aparecem no final do formul√°rio de inspe√ß√£o.</p>
                    <p>Voc√™ pode adicionar campos para informa√ß√µes espec√≠ficas do seu trabalho.</p>
                </div>
            </div>

            <!-- About Tab -->
            <div id="tab-about" class="settings-content">
                <div class="settings-group">
                    <h3>Informa√ß√µes do Sistema</h3>
                    <div class="info-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                        <div style="text-align: center; color: white;">
                            <div style="font-size: 48px; margin-bottom: 10px;">üè†</div>
                            <h3 style="color: white; font-size: 24px; margin-bottom: 5px;">Sistema de Inspe√ß√£o Residencial</h3>
                            <p style="color: white; opacity: 0.9;">Vers√£o V00</p>
                        </div>
                    </div>
                </div>

                <div class="settings-group">
                    <h3>Ajuda e Suporte</h3>
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <div class="settings-item-title">Tutorial Interativo</div>
                            <div class="settings-item-desc">Aprenda a usar o sistema</div>
                        </div>
                        <div class="settings-item-control">
                            <button class="btn btn-primary" onclick="showTutorial()">‚ñ∂Ô∏è Iniciar</button>
                        </div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <div class="settings-item-title">Contato e Suporte</div>
                            <div class="settings-item-desc">
                                üìß engenheirobrunomachado@gmail.com<br>
                                üì± (21) 99497-2971
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-group">
                    <h3>Documenta√ß√£o</h3>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="showChangelog()">üìã Changelog</button>
                        <button class="btn btn-secondary" onclick="showTermsOfUse()">üìÑ Termos de Uso</button>
                    </div>
                </div>

                <div class="settings-group">
                    <h3>Desenvolvedor</h3>
                    <div class="info-card">
                        <p style="margin: 0;">
                            <strong>Engenheiro Bruno Machado</strong><br>
                            Sistema desenvolvido para inspe√ß√µes residenciais profissionais<br>
                            ¬© 2025 - Todos os direitos reservados
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tutorial Overlay -->
        <div id="tutorialOverlay" class="tutorial-overlay">
            <div class="tutorial-content">
                <div id="tutorialSteps">
                    <!-- Steps will be populated by JS -->
                </div>
                <div class="tutorial-progress" id="tutorialProgress"></div>
                <div class="tutorial-actions">
                    <button class="btn btn-secondary" onclick="previousTutorialStep()">‚Üê Anterior</button>
                    <button class="btn btn-secondary" onclick="closeTutorial()">Pular</button>
                    <button class="btn btn-primary" onclick="nextTutorialStep()">Pr√≥ximo ‚Üí</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration - SUBSTITUA AQUI SUAS CREDENCIAIS
        const CLIENT_ID = '756155400991-gle9g8l22p3a8h9at5uu5djijtqat9lu.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyDTduz53nKthvO9sR1cvHNmD1DK4IDazlM';
        // Escopo ampliado para permitir compartilhamento de pastas
        const SCOPES = 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive';

        // ‚ö†Ô∏è PASTA COMPARTILHADA CENTRALIZADA ‚ö†Ô∏è
        // IMPORTANTE: TODOS os usu√°rios DEVEM usar a MESMA pasta compartilhada
        // Esta pasta ser√° usada por TODOS os usu√°rios para salvar e carregar inspe√ß√µes
        // N√ÉO criar pastas pessoais - SEMPRE usar esta pasta compartilhada
        let SHARED_FOLDER_ID = '19H2cLVp7KeNs5rCxVh0wQqfxACxNoJHj'; // Pasta compartilhada PR√â-CONFIGURADA
        
        // Carregar do localStorage na inicializa√ß√£o
        function loadSharedFolderConfig() {
            const savedFolderId = localStorage.getItem('SHARED_FOLDER_ID');
            if (savedFolderId && savedFolderId.trim() !== '') {
                SHARED_FOLDER_ID = savedFolderId;
                console.log('üìÅ Pasta compartilhada configurada (localStorage):', SHARED_FOLDER_ID);
                
                // Preencher o campo na interface
                const input = document.getElementById('sharedFolderId');
                if (input) input.value = SHARED_FOLDER_ID;
            } else {
                // Se n√£o houver pasta salva, usar a padr√£o (SEMPRE a mesma para todos)
                console.log('üìÅ Usando pasta compartilhada padr√£o (TODOS usam esta):', SHARED_FOLDER_ID);
                // Salvar a padr√£o no localStorage para garantir consist√™ncia
                localStorage.setItem('SHARED_FOLDER_ID', SHARED_FOLDER_ID);
            }
        }
        
        // Garantir que sempre usamos a pasta compartilhada (SEM FALLBACK)
        async function ensureSharedFolderAccess() {
            if (!SHARED_FOLDER_ID || !accessToken) {
                const errorMsg = 'Pasta compartilhada n√£o configurada ou n√£o conectado ao Drive';
                console.error('‚ùå', errorMsg);
                throw new Error(errorMsg);
            }
            
            try {
                // Verificar se temos acesso √† pasta compartilhada
                const response = await gapi.client.drive.files.get({
                    fileId: SHARED_FOLDER_ID,
                    fields: 'id, name, capabilities'
                });
                
                // Verificar se temos permiss√£o de escrita
                if (response.result.capabilities && !response.result.capabilities.canEdit) {
                    const errorMsg = 'Voc√™ n√£o tem permiss√£o de edi√ß√£o na pasta compartilhada. Configure a pasta nas Configura√ß√µes ‚Üí Google Drive ‚Üí Pasta Centralizada.';
                    console.error('‚ùå', errorMsg);
                    throw new Error(errorMsg);
                }
                
                console.log('‚úÖ Acesso √† pasta compartilhada confirmado:', response.result.name);
                return true;
            } catch (error) {
                console.error('‚ùå Erro ao verificar acesso √† pasta compartilhada:', error);
                
                let errorMsg = 'Erro ao acessar pasta compartilhada';
                
                if (error.status === 404) {
                    errorMsg = `Pasta compartilhada n√£o encontrada (ID: ${SHARED_FOLDER_ID}).\n\nConfigure a pasta correta em Configura√ß√µes ‚Üí Google Drive ‚Üí Pasta Centralizada.`;
                } else if (error.status === 403) {
                    errorMsg = 'Acesso negado √† pasta compartilhada.\n\nCertifique-se de que a pasta est√° compartilhada como "Qualquer pessoa com o link pode editar".\n\nConfigure em Configura√ß√µes ‚Üí Google Drive ‚Üí Pasta Centralizada.';
                } else if (error.message) {
                    errorMsg = error.message;
                }
                
                throw new Error(errorMsg);
            }
        }

        // Global variables
        let accessToken = null;
        let tokenClient = null;
        let gapiInited = false;
        let gisInited = false;
        let inspections = [];
        let currentInspection = null;
        let currentInspectionType = null;
        let selectedInitialInspection = null;
        let photoData = {};
        let currentUser = null; // Usu√°rio logado

        // ==========================================
        // FUN√á√ïES HELPER SEGURAS
        // ==========================================
        
        // Fun√ß√£o segura para salvar no localStorage com tratamento de quota
        function safeLocalStorageSet(key, value) {
            try {
                localStorage.setItem(key, value);
                return true;
            } catch (e) {
                if (e.name === 'QuotaExceededError' || e.code === 22) {
                    console.error('‚ùå Quota do localStorage excedida');
                    
                    // Mensagem personalizada dependendo da chave
                    if (key === 'inspections') {
                        alert('‚ö†Ô∏è MEM√ìRIA LOCAL CHEIA!\n\n' +
                              'üì∏ SOLU√á√ÉO: As fotos agora s√£o salvas apenas no Google Drive!\n\n' +
                              '‚úÖ Os dados da inspe√ß√£o est√£o salvos\n' +
                              '‚úÖ As fotos ser√£o enviadas automaticamente para o Drive\n\n' +
                              'üí° Essa nova estrat√©gia economiza mem√≥ria do celular e evita esse erro.');
                    } else {
                        alert('‚ö†Ô∏è Mem√≥ria local cheia! Limpe alguns dados antigos em Configura√ß√µes ‚Üí Gerenciar Inspe√ß√µes');
                    }
                    
                    return false;
                } else if (e.name === 'SecurityError') {
                    console.error('‚ùå Acesso ao localStorage bloqueado (modo privado?)');
                    alert('‚ö†Ô∏è N√£o √© poss√≠vel salvar dados localmente. Verifique se n√£o est√° em modo de navega√ß√£o privada.');
                    return false;
                } else {
                    console.error('‚ùå Erro ao salvar no localStorage:', e);
                    alert('‚ö†Ô∏è Erro ao salvar dados localmente: ' + e.message);
                    return false;
                }
            }
        }
        
        // Fun√ß√£o segura para obter do localStorage com fallback
        function safeLocalStorageGet(key, defaultValue = null) {
            try {
                const value = localStorage.getItem(key);
                return value !== null ? value : defaultValue;
            } catch (e) {
                console.error('‚ùå Erro ao ler do localStorage:', e);
                return defaultValue;
            }
        }
        
        // Fun√ß√£o segura para fazer JSON.parse com tratamento de erro
        function safeJSONParse(jsonString, defaultValue = null) {
            try {
                return JSON.parse(jsonString);
            } catch (e) {
                console.error('‚ùå Erro ao fazer parse de JSON:', e);
                return defaultValue;
            }
        }
        
        // Fun√ß√£o segura para fazer JSON.stringify com tratamento de erro
        function safeJSONStringify(obj, defaultValue = '{}') {
            try {
                return JSON.stringify(obj);
            } catch (e) {
                console.error('‚ùå Erro ao converter para JSON:', e);
                return defaultValue;
            }
        }
        
        // Fun√ß√£o para limpar localStorage se estiver muito cheio (manter apenas √∫ltimas 50 inspe√ß√µes)
        function cleanupOldInspections() {
            try {
                const inspectionsStr = safeLocalStorageGet('inspections');
                if (!inspectionsStr) return;
                
                const inspections = safeJSONParse(inspectionsStr, []);
                if (inspections.length > 50) {
                    // Ordenar por timestamp e manter apenas as 50 mais recentes
                    inspections.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    const recentInspections = inspections.slice(0, 50);
                    
                    safeLocalStorageSet('inspections', safeJSONStringify(recentInspections));
                    console.log(`üßπ Limpeza: removidas ${inspections.length - 50} inspe√ß√µes antigas`);
                }
            } catch (e) {
                console.error('‚ùå Erro na limpeza de inspe√ß√µes antigas:', e);
            }
        }

        // ==========================================
        // SISTEMA DE AUTENTICA√á√ÉO
        // ==========================================
        
        // Inicializar sistema com usu√°rio admin padr√£o
        function initializeAuthSystem() {
            let users = JSON.parse(localStorage.getItem('systemUsers')) || [];
            
            // Criar admin padr√£o se n√£o existir nenhum usu√°rio
            if (users.length === 0) {
                const defaultAdmin = {
                    id: Date.now().toString(),
                    name: 'Administrador',
                    username: 'admin',
                    password: 'admin123', // Senha padr√£o - DEVE SER ALTERADA
                    isAdmin: true,
                    createdAt: new Date().toISOString()
                };
                users.push(defaultAdmin);
                localStorage.setItem('systemUsers', JSON.stringify(users));
                console.log('‚úÖ Usu√°rio admin padr√£o criado: admin / admin123');
            }
        }
        
        // Tentar fazer login
        function attemptLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            
            console.log('üîê Tentativa de login para usu√°rio:', username);
            
            if (!username || !password) {
                alert('‚ö†Ô∏è Por favor, preencha usu√°rio e senha.');
                return;
            }
            
            const users = JSON.parse(localStorage.getItem('systemUsers')) || [];
            console.log('üë• Total de usu√°rios no sistema:', users.length);
            
            if (users.length === 0) {
                alert('‚ùå Nenhum usu√°rio cadastrado no sistema!\n\n' +
                      'üîß O sistema criar√° o usu√°rio admin padr√£o.\n\n' +
                      'Usu√°rio: admin\n' +
                      'Senha: admin123\n\n' +
                      'Por favor, recarregue a p√°gina e tente novamente.');
                console.error('‚ùå Nenhum usu√°rio cadastrado!');
                return;
            }
            
            const user = users.find(u => u.username === username && u.password === password);
            
            if (user) {
                console.log('‚úÖ Login bem-sucedido para:', user.name);
                
                // Login bem-sucedido
                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(user));
                
                // Ocultar tela de login
                document.getElementById('loginScreen').classList.remove('active');
                
                // Atualizar interface
                document.getElementById('currentUserDisplay').textContent = user.name;
                
                // Mostrar bot√£o de admin se for admin
                if (user.isAdmin) {
                    document.getElementById('adminMenuButton').style.display = 'block';
                }
                
                // Conectar ao Google Drive
                showProgress('Conectando ao Google Drive...');
                
                // Aguardar inicializa√ß√£o das APIs e ent√£o solicitar autoriza√ß√£o
                const waitForInitAndConnect = setInterval(() => {
                    if (gapiInited && gisInited) {
                        clearInterval(waitForInitAndConnect);
                        hideProgress();
                        
                        // Agora solicitar autoriza√ß√£o do Google
                        console.log('‚úÖ APIs inicializadas. Solicitando autoriza√ß√£o...');
                        requestAccessToken();
                        
                        // Ap√≥s autoriza√ß√£o, verificar acesso √† pasta compartilhada
                        setTimeout(async () => {
                            if (accessToken) {
                                try {
                                    await ensureSharedFolderAccess();
                                    console.log('‚úÖ Acesso √† pasta compartilhada confirmado');
                                } catch (error) {
                                    console.warn('‚ö†Ô∏è Aviso:', error.message);
                                    console.warn('‚ö†Ô∏è Configure a pasta compartilhada em Configura√ß√µes ‚Üí Google Drive ‚Üí Pasta Centralizada');
                                }
                            }
                        }, 3000);
                    }
                }, 100);
                
                // Timeout de seguran√ßa (10 segundos)
                setTimeout(() => {
                    clearInterval(waitForInitAndConnect);
                    if (!gapiInited || !gisInited) {
                        hideProgress();
                        console.warn('‚ö†Ô∏è Timeout ao inicializar APIs. Continuando em modo local.');
                        showMainMenu(); // Mostrar menu mesmo sem Drive
                    }
                }, 10000);
                
                playSound('success');
            } else {
                console.log('‚ùå Login falhou: credenciais inv√°lidas');
                alert('‚ùå Usu√°rio ou senha incorretos!\n\nVerifique suas credenciais e tente novamente.');
                document.getElementById('loginPassword').value = '';
                document.getElementById('loginPassword').focus();
            }
        }
        
        // Logout
        function logout() {
            if (confirm('Deseja realmente sair do sistema?')) {
                currentUser = null;
                localStorage.removeItem('currentUser');
                
                // Limpar token do Drive
                accessToken = null;
                
                // Recarregar p√°gina
                window.location.reload();
            }
        }
        
        // Adicionar novo usu√°rio (apenas admin)
        function addNewUser() {
            if (!currentUser || !currentUser.isAdmin) {
                alert('‚ùå Apenas administradores podem adicionar usu√°rios!');
                return;
            }
            
            const name = document.getElementById('newUserName').value.trim();
            const username = document.getElementById('newUserUsername').value.trim();
            const password = document.getElementById('newUserPassword').value.trim();
            const isAdmin = document.getElementById('newUserIsAdmin').checked;
            
            // Valida√ß√µes
            if (!name || !username || !password) {
                alert('‚ö†Ô∏è Preencha todos os campos!');
                return;
            }
            
            if (username.length < 3) {
                alert('‚ö†Ô∏è Usu√°rio deve ter pelo menos 3 caracteres!');
                return;
            }
            
            if (password.length < 4) {
                alert('‚ö†Ô∏è Senha deve ter pelo menos 4 caracteres!');
                return;
            }
            
            // Verificar se usu√°rio j√° existe
            const users = JSON.parse(localStorage.getItem('systemUsers')) || [];
            if (users.find(u => u.username === username)) {
                alert('‚ùå Este nome de usu√°rio j√° existe!');
                return;
            }
            
            // Criar novo usu√°rio
            const newUser = {
                id: Date.now().toString(),
                name: name,
                username: username,
                password: password,
                isAdmin: isAdmin,
                createdAt: new Date().toISOString(),
                createdBy: currentUser.username
            };
            
            users.push(newUser);
            localStorage.setItem('systemUsers', JSON.stringify(users));
            
            // Limpar campos
            document.getElementById('newUserName').value = '';
            document.getElementById('newUserUsername').value = '';
            document.getElementById('newUserPassword').value = '';
            document.getElementById('newUserIsAdmin').checked = false;
            
            // Atualizar lista
            loadUsersList();
            
            playSound('success');
            alert(`‚úÖ Usu√°rio "${name}" criado com sucesso!\n\nUsu√°rio: ${username}\nSenha: ${password}\n\n‚ö†Ô∏è Anote estas credenciais!`);
        }
        
        // Carregar lista de usu√°rios
        function loadUsersList() {
            const users = JSON.parse(localStorage.getItem('systemUsers')) || [];
            const container = document.getElementById('usersList');
            
            if (users.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">Nenhum usu√°rio cadastrado</p>';
                return;
            }
            
            let html = '<div style="display: grid; gap: 15px;">';
            
            users.forEach(user => {
                const isCurrentUser = currentUser && currentUser.id === user.id;
                const createdDate = new Date(user.createdAt).toLocaleDateString('pt-BR');
                
                html += `
                    <div style="padding: 20px; background: ${isCurrentUser ? '#e3f2fd' : 'white'}; border: 2px solid ${isCurrentUser ? '#2196f3' : '#e0e0e0'}; border-radius: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                    <h4 style="margin: 0; color: #333;">${user.name}</h4>
                                    ${user.isAdmin ? '<span style="background: #FF9800; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">ADMIN</span>' : ''}
                                    ${isCurrentUser ? '<span style="background: #2196f3; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">VOC√ä</span>' : ''}
                                </div>
                                <p style="margin: 5px 0; color: #666; font-size: 14px;">
                                    <strong>Usu√°rio:</strong> ${user.username}<br>
                                    <strong>Criado em:</strong> ${createdDate}
                                    ${user.createdBy ? `<br><strong>Criado por:</strong> ${user.createdBy}` : ''}
                                </p>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                ${!isCurrentUser ? `<button onclick="deleteUser('${user.id}')" class="btn btn-secondary" style="background: #dc3545; font-size: 12px; padding: 8px 15px;">üóëÔ∏è Excluir</button>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // Excluir usu√°rio
        function deleteUser(userId) {
            if (!currentUser || !currentUser.isAdmin) {
                alert('‚ùå Apenas administradores podem excluir usu√°rios!');
                return;
            }
            
            const users = JSON.parse(localStorage.getItem('systemUsers')) || [];
            const user = users.find(u => u.id === userId);
            
            if (!user) return;
            
            if (user.id === currentUser.id) {
                alert('‚ùå Voc√™ n√£o pode excluir seu pr√≥prio usu√°rio!');
                return;
            }
            
            if (confirm(`Deseja realmente excluir o usu√°rio "${user.name}"?`)) {
                const updatedUsers = users.filter(u => u.id !== userId);
                localStorage.setItem('systemUsers', JSON.stringify(updatedUsers));
                loadUsersList();
                playSound('success');
                alert('‚úÖ Usu√°rio exclu√≠do com sucesso!');
            }
        }
        
        // Mostrar painel de administra√ß√£o
        function showAdminPanel() {
            if (!currentUser || !currentUser.isAdmin) {
                alert('‚ùå Apenas administradores podem acessar este painel!');
                return;
            }
            
            document.getElementById('mainMenu').classList.remove('active');
            document.getElementById('adminPanel').style.display = 'block';
            loadUsersList();
        }
        
        // Fechar painel de administra√ß√£o
        function closeAdminPanel() {
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('mainMenu').classList.add('active');
        }

        // Patologias Info Database
        const patologiasInfo = {
            'fissuras': 'Aberturas na estrutura com menos de 0,5mm de largura. Geralmente causadas por movimenta√ß√£o t√©rmica ou retra√ß√£o do concreto.',
            'trincas': 'Aberturas acima de 0,5mm de largura. Podem indicar problemas estruturais mais s√©rios e requerem aten√ß√£o imediata.',
            'danos': 'Deteriora√ß√£o ou avarias na estrutura que comprometem a integridade do im√≥vel.',
            'recalque': 'Afundamento da funda√ß√£o causando desn√≠veis e rachaduras. Problema estrutural grave.',
            'vazamento': 'Perda de √°gua ou esgoto nas tubula√ß√µes, podendo causar infiltra√ß√µes e danos estruturais.',
            'goteiras': 'Infiltra√ß√£o de √°gua da chuva pela cobertura, causando manchas e mofo.',
            'infiltracao': 'Penetra√ß√£o de umidade nas paredes, pisos ou tetos, causando manchas, mofo e degrada√ß√£o.',
            'manchas': 'Marcas vis√≠veis de umidade, mofo ou deteriora√ß√£o nos acabamentos.',
            'mofo': 'Crescimento de fungos causado por umidade excessiva, prejudicial √† sa√∫de.',
            'cupim': 'Infesta√ß√£o de insetos xil√≥fagos que deterioram madeiras e podem comprometer estruturas.',
            'corrosao': 'Oxida√ß√£o de elementos met√°licos (ferragens, estruturas) que compromete a resist√™ncia.'
        };

        // Initialize Google Drive
        function initializeGoogleDrive() {
            // Verificar se as credenciais foram configuradas
            if (CLIENT_ID === 'YOUR_CLIENT_ID.apps.googleusercontent.com' || API_KEY === 'YOUR_API_KEY') {
                console.warn('‚ö†Ô∏è Credenciais do Google Drive n√£o configuradas. Usando modo local.');
                gapiInited = true; // Marcar como "inicializado" para n√£o bloquear
                gisInited = true;
                return; // Continuar sem Drive
            }

            try {
                // Carregar API do Google
                gapi.load('client', initializeGapiClient);
                
                // Inicializar Google Identity Services
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: (tokenResponse) => {
                        if (tokenResponse.error !== undefined) {
                            console.error('Erro na autentica√ß√£o:', tokenResponse);
                            console.warn('‚ö†Ô∏è Continuando em modo local sem Google Drive');
                            showMainMenu(); // Continuar sem Drive
                            return;
                        }
                        accessToken = tokenResponse.access_token;
                        console.log('‚úÖ Conectado ao Google Drive com sucesso!');
                        showMainMenu();
                    },
                    error_callback: (error) => {
                        console.error('Erro no token client:', error);
                        console.warn('‚ö†Ô∏è Continuando em modo local sem Google Drive');
                        showMainMenu(); // Continuar sem Drive
                    }
                });
                
                gisInited = true;
            } catch (error) {
                console.error('Erro ao inicializar:', error);
                console.warn('‚ö†Ô∏è APIs do Google n√£o dispon√≠veis. Usando modo local.');
                // Marcar como inicializado para n√£o bloquear
                gapiInited = true;
                gisInited = true;
            }
        }

        async function initializeGapiClient() {
            try {
                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
                });
                gapiInited = true;
                console.log('‚úÖ Google API Client inicializado');
            } catch (error) {
                console.error('Erro ao inicializar GAPI:', error);
                console.warn('‚ö†Ô∏è Continuando em modo local sem Google Drive');
                gapiInited = true; // Marcar como inicializado para n√£o bloquear
            }
        }

        function handleCredentialResponse(response) {
            // Fun√ß√£o removida - n√£o √© mais necess√°ria
            console.log('Credential response (legacy - n√£o usado)');
        }

        function requestAccessToken() {
            if (!tokenClient) {
                console.warn('‚ö†Ô∏è Token client n√£o dispon√≠vel. Continuando em modo local.');
                showMainMenu(); // Continuar sem Drive
                return;
            }
            
            if (!gapiInited || !gisInited) {
                console.log('‚è≥ APIs ainda est√£o carregando...');
                setTimeout(requestAccessToken, 2000);
                return;
            }
            
            try {
                console.log('üì§ Solicitando token de acesso...');
                // Solicitar token com prompt de consentimento
                tokenClient.requestAccessToken({ 
                    prompt: 'consent',
                    hint: '' // Remove hint que pode causar problemas
                });
            } catch (error) {
                console.error('‚ùå Erro ao solicitar token:', error);
                console.warn('‚ö†Ô∏è Continuando em modo local sem Google Drive');
                showMainMenu(); // Continuar sem Drive
            }
        }

        function showMainMenu() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainMenu').classList.add('active');
            loadInspections();
        }

        // Load inspections from localStorage
        async function loadInspections() {
            // SEMPRE tentar carregar do Drive primeiro
            if (accessToken) {
                try {
                    console.log('‚òÅÔ∏è Carregando inspe√ß√µes do Google Drive...');
                    showProgress('Carregando inspe√ß√µes do Google Drive...');
                    await loadInspectionsFromDrive();
                    hideProgress();
                    console.log(`‚úÖ ${inspections.length} inspe√ß√µes carregadas do Drive`);
                    return;
                } catch (error) {
                    console.error('‚ùå Erro ao carregar do Drive:', error);
                    hideProgress();
                    
                    // Se o erro for de pasta n√£o configurada, alertar usu√°rio
                    if (error.message.includes('Pasta compartilhada n√£o configurada')) {
                        alert('‚ö†Ô∏è Pasta compartilhada do Google Drive n√£o configurada!\n\nAcesse: Menu ‚Üí Configura√ß√µes ‚Üí Google Drive ‚Üí Pasta Centralizada');
                    }
                    
                    console.log('‚ö†Ô∏è Tentando carregar do armazenamento local...');
                }
            } else {
                console.log('‚ö†Ô∏è Sem conex√£o com Drive. Carregando do armazenamento local...');
            }
            
            // Fallback: carregar do localStorage
            try {
                const stored = localStorage.getItem('inspections');
                if (stored) {
                    // Tentar fazer parse
                    try {
                        inspections = JSON.parse(stored);
                        console.log(`üì¶ ${inspections.length} inspe√ß√µes carregadas do localStorage`);
                        
                        // N√ÉO limpar fotos de inspe√ß√µes antigas - elas precisam das fotos para exporta√ß√£o!
                        // Apenas novas inspe√ß√µes n√£o salvam fotos no localStorage
                        
                    } catch (parseError) {
                        console.error('‚ùå Erro ao fazer parse do localStorage:', parseError);
                        alert('‚ö†Ô∏è Erro ao carregar inspe√ß√µes locais. Os dados podem estar corrompidos.\n\nRecomendamos reconectar ao Google Drive para recuperar os dados.');
                        inspections = [];
                    }
                } else {
                    console.log('üì≠ Nenhuma inspe√ß√£o encontrada localmente');
                    inspections = [];
                }
            } catch (storageError) {
                console.error('‚ùå Erro ao acessar localStorage:', storageError);
                alert('‚ö†Ô∏è Erro ao acessar armazenamento local.\n\nVerifique se n√£o est√° em modo de navega√ß√£o privada.');
                inspections = [];
            }
        }

        // Carregar inspe√ß√µes do Google Drive
        async function loadInspectionsFromDrive() {
            if (!accessToken) {
                throw new Error('N√£o conectado ao Google Drive');
            }

            inspections = [];
            
            try {
                // SEMPRE usar pasta compartilhada - TODOS os usu√°rios usam a MESMA pasta
                if (!SHARED_FOLDER_ID) {
                    throw new Error('Pasta compartilhada n√£o configurada. Configure em Configura√ß√µes ‚Üí Google Drive ‚Üí Pasta Centralizada.');
                }
                
                // Garantir acesso √† pasta compartilhada (SEM FALLBACK)
                await ensureSharedFolderAccess();
                
                const rootFolderId = SHARED_FOLDER_ID;
                console.log('üìÅ Usando pasta compartilhada (TODOS usam esta):', rootFolderId);

                // Buscar pastas de tipo (inicial e completa)
                const typeFolders = await gapi.client.drive.files.list({
                    q: `'${rootFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
                    fields: 'files(id, name)',
                    spaces: 'drive'
                });

                if (!typeFolders.result.files || typeFolders.result.files.length === 0) {
                    console.log('üì≠ Nenhuma pasta de tipo encontrada no Drive');
                    return;
                }

                console.log(`üìÇ ${typeFolders.result.files.length} pasta(s) de tipo encontrada(s)`);

                for (const typeFolder of typeFolders.result.files) {
                    console.log(`üìÇ Processando tipo: ${typeFolder.name}`);
                    
                    try {
                        // Buscar pastas de data
                        const dateFolders = await gapi.client.drive.files.list({
                            q: `'${typeFolder.id}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
                            fields: 'files(id, name)',
                            spaces: 'drive'
                        });

                        for (const dateFolder of dateFolders.result.files) {
                            try {
                                // Buscar pastas de endere√ßo
                                const addressFolders = await gapi.client.drive.files.list({
                                    q: `'${dateFolder.id}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
                                    fields: 'files(id, name)',
                                    spaces: 'drive'
                                });

                                for (const addressFolder of addressFolders.result.files) {
                                    try {
                                        // Buscar arquivo inspecao.json dentro da pasta
                                        const jsonFiles = await gapi.client.drive.files.list({
                                            q: `'${addressFolder.id}' in parents and name='inspecao.json' and trashed=false`,
                                            fields: 'files(id, name)',
                                            spaces: 'drive'
                                        });

                                        if (jsonFiles.result.files && jsonFiles.result.files.length > 0) {
                                            const fileId = jsonFiles.result.files[0].id;
                                            
                                            // Baixar conte√∫do do arquivo
                                            const response = await gapi.client.drive.files.get({
                                                fileId: fileId,
                                                alt: 'media'
                                            });

                                            const inspection = JSON.parse(response.body);
                                            inspection.driveFileId = fileId;
                                            inspection.driveFolderId = addressFolder.id;
                                            
                                            // N√ÉO remover fotos de inspe√ß√µes antigas!
                                            // As fotos s√£o necess√°rias para exporta√ß√£o
                                            
                                            inspections.push(inspection);
                                            console.log(`  ‚úÖ Inspe√ß√£o carregada: ${inspection.endereco}, ${inspection.numero}`);
                                        }
                                    } catch (fileError) {
                                        console.error(`  ‚ùå Erro ao processar arquivo em ${addressFolder.name}:`, fileError);
                                        // Continuar com pr√≥ximo arquivo
                                    }
                                }
                            } catch (addressError) {
                                console.error(`  ‚ùå Erro ao processar pasta de endere√ßo em ${dateFolder.name}:`, addressError);
                                // Continuar com pr√≥xima pasta
                            }
                        }
                    } catch (dateError) {
                        console.error(`  ‚ùå Erro ao processar pasta de data em ${typeFolder.name}:`, dateError);
                        // Continuar com pr√≥xima pasta
                    }
                }

                console.log(`‚úÖ Total de ${inspections.length} inspe√ß√µes carregadas do Drive`);
                
                // Sincronizar com localStorage tamb√©m (COM fotos - necess√°rio para exporta√ß√£o)
                safeLocalStorageSet('inspections', safeJSONStringify(inspections));
                
            } catch (error) {
                console.error('‚ùå Erro ao buscar inspe√ß√µes do Drive:', error);
                throw error;
            }
        }

        // Deletar inspe√ß√£o do Google Drive
        async function deleteInspectionFromDrive(inspection) {
            let driveDeleteSuccess = false;
            let driveDeleteError = null;
            
            // Se a inspe√ß√£o tem driveFolderId, tentar deletar do Drive
            if (inspection.driveFolderId && accessToken) {
                try {
                    // Deletar a pasta inteira (que cont√©m o JSON, relat√≥rio e fotos)
                    await gapi.client.drive.files.delete({
                        fileId: inspection.driveFolderId
                    });

                    console.log('‚úÖ Pasta deletada do Drive:', inspection.driveFolderId);
                    driveDeleteSuccess = true;
                } catch (error) {
                    console.error('‚ùå Erro ao deletar do Drive:', error);
                    driveDeleteError = error;
                    
                    // Tratar diferentes tipos de erro
                    if (error.status === 404) {
                        console.warn('‚ö†Ô∏è Pasta n√£o encontrada no Drive (pode j√° ter sido deletada)');
                        // N√£o √© um erro cr√≠tico, pode continuar
                    } else if (error.status === 403) {
                        console.warn('‚ö†Ô∏è Sem permiss√£o para deletar no Drive (inspe√ß√£o criada por outro usu√°rio)');
                        // N√£o √© um erro cr√≠tico, pode continuar deletando localmente
                    } else {
                        console.warn('‚ö†Ô∏è Erro ao deletar do Drive, mas continuando com exclus√£o local');
                        // N√£o √© um erro cr√≠tico, pode continuar
                    }
                }
            } else if (!accessToken) {
                console.log('‚ÑπÔ∏è N√£o conectado ao Drive, deletando apenas localmente');
            } else {
                console.log('‚ÑπÔ∏è Inspe√ß√£o n√£o tem driveFolderId, deletando apenas localmente');
            }
            
            // SEMPRE remover do array local, independente de ter driveFolderId ou permiss√£o no Drive
            const index = inspections.findIndex(i => i.id === inspection.id);
            if (index > -1) {
                inspections.splice(index, 1);
                safeLocalStorageSet('inspections', safeJSONStringify(inspections));
                console.log('‚úÖ Inspe√ß√£o removida localmente');
            } else {
                console.warn('‚ö†Ô∏è Inspe√ß√£o n√£o encontrada no array local');
            }
            
            // Se houve erro de permiss√£o (403), informar mas n√£o falhar
            if (driveDeleteError && driveDeleteError.status === 403) {
                console.log('‚ÑπÔ∏è Inspe√ß√£o deletada localmente. N√£o foi poss√≠vel deletar no Drive (sem permiss√£o).');
            }
        }

        // Save inspections to localStorage
        function saveInspections() {
            safeLocalStorageSet('inspections', safeJSONStringify(inspections));
            // Limpar inspe√ß√µes antigas periodicamente
            cleanupOldInspections();
        }

        // Show inspection type modal
        function showInspectionTypeModal() {
            document.getElementById('inspectionTypeModal').classList.add('active');
        }

        function closeInspectionTypeModal() {
            document.getElementById('inspectionTypeModal').classList.remove('active');
        }

        // Start new inspection
        function startNewInspection(type) {
            currentInspectionType = type;
            closeInspectionTypeModal();
            
            if (type === 'inicial') {
                createInspectionForm(type, null);
            }
        }

        // Show list of initial inspections
        async function showInitialInspectionsList() {
            // Carregar inspe√ß√µes do Drive primeiro
            showProgress('Carregando inspe√ß√µes do Google Drive...');
            await loadInspections();
            hideProgress();
            
            const initialInspections = inspections.filter(i => i.type === 'inicial');
            
            if (initialInspections.length === 0) {
                alert('N√£o h√° inspe√ß√µes iniciais cadastradas no Google Drive. Por favor, realize uma inspe√ß√£o inicial primeiro.');
                return;
            }

            const listContainer = document.getElementById('initialInspectionsList');
            listContainer.innerHTML = '';

            initialInspections.forEach(inspection => {
                const item = document.createElement('div');
                item.className = 'inspection-item';
                item.onclick = () => selectInitialInspection(inspection, item);
                
                item.innerHTML = `
                    <div class="inspection-item-date">üìÖ ${formatDate(inspection.dataVistoria)} - ${inspection.horaVistoria}</div>
                    <div class="inspection-item-address">üìç ${inspection.endereco}, ${inspection.numero} - ${inspection.bairro}, ${inspection.municipio}/${inspection.uf}</div>
                `;
                
                listContainer.appendChild(item);
            });

            closeInspectionTypeModal();
            document.getElementById('selectInitialModal').classList.add('active');
        }

        function selectInitialInspection(inspection, element) {
            // Remove selection from all items
            document.querySelectorAll('.inspection-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Add selection to clicked item
            element.classList.add('selected');
            selectedInitialInspection = inspection;
        }

        function continueWithSelectedInspection() {
            if (!selectedInitialInspection) {
                alert('Por favor, selecione uma inspe√ß√£o inicial.');
                return;
            }

            console.log('üîç DEBUG - Inspe√ß√£o inicial selecionada:', selectedInitialInspection);
            console.log('üìç Endere√ßo:', selectedInitialInspection.endereco);
            console.log('üî¢ N√∫mero:', selectedInitialInspection.numero);
            console.log('üìä Checklist:', selectedInitialInspection.checklist);
            console.log('üì∏ Fotos:', selectedInitialInspection.photos);

            // IMPORTANTE: Salvar refer√™ncia ANTES de fechar o modal (que zera a vari√°vel)
            const inspectionData = selectedInitialInspection;
            
            currentInspectionType = 'completa';
            closeSelectInitialModal(); // Isso zera selectedInitialInspection
            
            // Usar a c√≥pia salva
            createInspectionForm('completa', inspectionData);
        }

        function closeSelectInitialModal() {
            document.getElementById('selectInitialModal').classList.remove('active');
            selectedInitialInspection = null; // ‚Üê Aqui estava o problema!
        }

        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }

        // Fun√ß√£o para ocultar TODAS as telas (previne sobreposi√ß√£o)
        function hideAllScreens() {
            document.getElementById('mainMenu').classList.remove('active');
            document.getElementById('inspectionsDatabase').style.display = 'none';
            document.getElementById('inspectionForm').classList.remove('active');
            
            const settingsScreen = document.getElementById('settingsScreen');
            if (settingsScreen) settingsScreen.style.display = 'none';
            
            const adminPanel = document.getElementById('adminPanel');
            if (adminPanel) adminPanel.style.display = 'none';
            
            document.getElementById('inspectionTypeModal').classList.remove('active');
            document.getElementById('selectInitialModal').classList.remove('active');
        }

        // Create inspection form
        function createInspectionForm(type, baseInspection) {
            console.log('üèóÔ∏è Criando formul√°rio de inspe√ß√£o...');
            console.log('üìã Tipo:', type);
            console.log('üì¶ BaseInspection recebida:', baseInspection);
            
            // Ocultar todas as telas primeiro
            hideAllScreens();
            
            if (baseInspection) {
                console.log('‚úÖ Dados da baseInspection:');
                console.log('  - ID:', baseInspection.id);
                console.log('  - Endere√ßo:', baseInspection.endereco);
                console.log('  - N√∫mero:', baseInspection.numero);
                console.log('  - Bairro:', baseInspection.bairro);
                console.log('  - Munic√≠pio:', baseInspection.municipio);
                console.log('  - UF:', baseInspection.uf);
                console.log('  - Acompanhante:', baseInspection.acompanhante);
                console.log('  - Quartos:', baseInspection.qtdQuartos);
                console.log('  - Su√≠tes:', baseInspection.qtdSuites);
            } else {
                console.log('‚ö†Ô∏è BaseInspection √© NULL ou UNDEFINED');
            }
            
            const formContainer = document.getElementById('inspectionForm');
            const isCompleta = type === 'completa';
            const badge = isCompleta ? 
                '<span class="inspection-type-badge badge-completa">INSPE√á√ÉO COMPLETA</span>' :
                '<span class="inspection-type-badge badge-inicial">INSPE√á√ÉO INICIAL</span>';

            // Se for inspe√ß√£o completa, carregar fotos da inicial
            if (isCompleta && baseInspection && baseInspection.photos) {
                console.log('üîÑ Carregando inspe√ß√£o completa baseada em:', baseInspection.id);
                console.log('üì∏ Fotos na inspe√ß√£o inicial:', baseInspection.photos);
                
                // Mapear fotos antigas (sem numera√ß√£o) para o novo formato (com _1)
                photoData = {};
                Object.keys(baseInspection.photos).forEach(oldKey => {
                    // Se a chave n√£o termina com _n√∫mero, adicionar _1
                    if (!oldKey.match(/_\d+$/)) {
                        const newKey = `${oldKey}_1`;
                        photoData[newKey] = baseInspection.photos[oldKey];
                        console.log(`  üîó Mapeando: ${oldKey} ‚Üí ${newKey}`);
                    } else {
                        photoData[oldKey] = baseInspection.photos[oldKey];
                        console.log(`  ‚úÖ Mantendo: ${oldKey}`);
                    }
                });
                
                console.log('‚úÖ photoData mapeado com sucesso:', Object.keys(photoData).length, 'itens');
                console.log('üìã Novos IDs:', Object.keys(photoData));
            } else {
                photoData = {}; // Reset photoData para nova inspe√ß√£o inicial
                console.log('üÜï Nova inspe√ß√£o inicial - photoData resetado');
            }

            let formHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Nova Inspe√ß√£o ${badge}</h2>
                    <button class="btn btn-secondary" onclick="backToMenu()">‚Üê Voltar</button>
                </div>
            `;

            // Aviso explicativo para inspe√ß√£o completa
            if (isCompleta) {
                formHTML += `
                    <div class="form-section" style="background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white; border: none;">
                        <h3 style="color: white; margin-bottom: 10px;">üìä Inspe√ß√£o Completa - Modo de Edi√ß√£o</h3>
                        <p style="margin: 0; line-height: 1.6;">
                            ‚úÖ Todos os dados da <strong>Inspe√ß√£o Inicial</strong> foram carregados<br>
                            ‚úèÔ∏è Voc√™ pode <strong>EDITAR</strong> qualquer informa√ß√£o da inicial<br>
                            üóëÔ∏è Voc√™ pode <strong>REMOVER</strong> problemas ou fotos<br>
                            ‚ûï Voc√™ pode <strong>ADICIONAR</strong> novos problemas e observa√ß√µes<br>
                            üîç Campos extras est√£o dispon√≠veis para uma vistoria mais detalhada
                        </p>
                    </div>
                `;
            }

            // Se√ß√£o 1: Dados do Im√≥vel
            formHTML += `
                <div class="form-section">
                    <h3>üìç Dados do Im√≥vel</h3>
                    ${isCompleta ? '<p style="color: #FF9800; font-size: 13px; margin-bottom: 15px;">üí° Dados importados da inspe√ß√£o inicial. Voc√™ pode edit√°-los se necess√°rio.</p>' : ''}
                    <div class="form-row">
                        <div class="form-group">
                            <label>Endere√ßo *</label>
                            <input type="text" id="endereco" value="${baseInspection?.endereco || ''}" required>
                        </div>
                        <div class="form-group">
                            <label>N√∫mero *</label>
                            <input type="text" id="numero" value="${baseInspection?.numero || ''}" required>
                        </div>
                        <div class="form-group">
                            <label>Complemento</label>
                            <input type="text" id="complemento" value="${baseInspection?.complemento || ''}">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Bairro *</label>
                            <input type="text" id="bairro" value="${baseInspection?.bairro || ''}" required>
                        </div>
                        <div class="form-group">
                            <label>Munic√≠pio *</label>
                            <input type="text" id="municipio" value="${baseInspection?.municipio || ''}" required>
                        </div>
                        <div class="form-group">
                            <label>UF *</label>
                            <select id="uf" required>
                                <option value="">Selecione</option>
                                ${getUFOptions(baseInspection?.uf)}
                            </select>
                        </div>
                    </div>
                </div>
            `;

            // Se√ß√£o 2: Data e Respons√°vel
            formHTML += `
                <div class="form-section">
                    <h3>üìÖ Data da Vistoria</h3>
                    ${isCompleta ? '<p style="color: #FF9800; font-size: 13px; margin-bottom: 15px;">üí° Voc√™ pode atualizar a data e hora para a vistoria completa.</p>' : ''}
                    <div class="form-row">
                        <div class="form-group">
                            <label>Data da Vistoria *</label>
                            <input type="date" id="dataVistoria" value="${baseInspection?.dataVistoria || new Date().toISOString().split('T')[0]}" required>
                        </div>
                        <div class="form-group">
                            <label>Hora *</label>
                            <input type="time" id="horaVistoria" value="${baseInspection?.horaVistoria || new Date().toTimeString().slice(0,5)}" required>
                        </div>
                        <div class="form-group">
                            <label>Quem Acompanhou *</label>
                            <input type="text" id="acompanhante" value="${baseInspection?.acompanhante || ''}" required>
                        </div>
                        <div class="form-group">
                            <label>Telefone de Contato</label>
                            <input type="tel" id="telefoneAcompanhante" value="${baseInspection?.telefoneAcompanhante || ''}" placeholder="(00) 00000-0000">
                        </div>
                    </div>
                </div>
            `;

            // Se√ß√£o 3: Caracter√≠sticas do Im√≥vel
            formHTML += `
                <div class="form-section">
                    <h3>üè† Caracter√≠sticas do Im√≥vel</h3>
                    ${isCompleta ? '<p style="color: #FF9800; font-size: 13px; margin-bottom: 15px;">üí° Dados importados da inspe√ß√£o inicial. Voc√™ pode corrigir se necess√°rio.</p>' : ''}
                    <div class="form-row">
                        <div class="form-group">
                            <label>Idade do Im√≥vel (anos)</label>
                            <input type="number" id="idadeImovel" value="${baseInspection?.idadeImovel || ''}" min="0">
                        </div>
                        <div class="form-group">
                            <label>Quantidade de Pavimentos</label>
                            <input type="number" id="qtdPavimentos" value="${baseInspection?.qtdPavimentos || ''}" min="1">
                        </div>
                        <div class="form-group">
                            <label>Quantidade de Salas</label>
                            <input type="number" id="qtdSalas" value="${baseInspection?.qtdSalas || ''}" min="0">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Quantidade de Quartos</label>
                            <input type="number" id="qtdQuartos" value="${baseInspection?.qtdQuartos || ''}" min="0">
                        </div>
                        <div class="form-group">
                            <label>Quantidade de Su√≠tes</label>
                            <input type="number" id="qtdSuites" value="${baseInspection?.qtdSuites || ''}" min="0">
                        </div>
                        <div class="form-group">
                            <label>Quantidade de Cozinhas</label>
                            <input type="number" id="qtdCozinhas" value="${baseInspection?.qtdCozinhas || ''}" min="0">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>√Årea Total (m¬≤)</label>
                            <input type="number" id="areaTotal" value="${baseInspection?.areaTotal || ''}" min="0" step="0.01" placeholder="Ex: 150.50">
                        </div>
                        <div class="form-group">
                            <label>Possui Quintal?</label>
                            <select id="possuiQuintal">
                                <option value="nao" ${baseInspection?.possuiQuintal === 'nao' ? 'selected' : ''}>N√£o</option>
                                <option value="sim" ${baseInspection?.possuiQuintal === 'sim' ? 'selected' : ''}>Sim</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Possui Garagem?</label>
                            <select id="possuiGaragem">
                                <option value="nao" ${baseInspection?.possuiGaragem === 'nao' ? 'selected' : ''}>N√£o</option>
                                <option value="sim" ${baseInspection?.possuiGaragem === 'sim' ? 'selected' : ''}>Sim</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;

            // FOTOS GERAIS - Categoria Especial (apenas na inspe√ß√£o inicial)
            if (!isCompleta) {
                formHTML += generateFotosGerais(baseInspection);
            }

            // Checklists - INSPE√á√ÉO INICIAL
            formHTML += generateChecklist('estrutura', '1 - Estrutura', [
                { id: 'fissuras', label: 'Fissuras', info: 'fissuras' },
                { id: 'trincas', label: 'Trincas', info: 'trincas' },
                { id: 'danos', label: 'Danos', info: 'danos' },
                { id: 'recalque', label: 'Recalque', info: 'recalque' }
            ], baseInspection);

            // Inspe√ß√£o Inicial: apenas quadro e fia√ß√£o
            // Inspe√ß√£o Completa: adiciona tomadas e interruptores
            const eletricaItems = [
                { id: 'quadro', label: 'Estado Quadro de Distribui√ß√£o' },
                { id: 'fiacao', label: 'Fia√ß√£o Aparente' },
                { id: 'componentes', label: 'Componentes El√©tricos' }
            ];
            if (isCompleta) {
                eletricaItems.push(
                    { id: 'tomadas', label: 'Tomadas' },
                    { id: 'interruptores', label: 'Interruptores' }
                );
            }
            formHTML += generateChecklist('eletrica', '2 - Instala√ß√µes El√©tricas', eletricaItems, baseInspection);

            // Inspe√ß√£o Inicial: apenas sinais de vazamento
            // Inspe√ß√£o Completa: adiciona tubula√ß√µes, registros, lou√ßas, caixas d'√°gua
            const hidroItems = [
                { id: 'vazamento', label: 'Sinais de Vazamento', info: 'vazamento' }
            ];
            if (isCompleta) {
                hidroItems.push(
                    { id: 'tubulacoes', label: 'Tubula√ß√µes' },
                    { id: 'registros', label: 'Registros' },
                    { id: 'loucas', label: 'Lou√ßas' },
                    { id: 'caixas', label: 'Caixas d\'√°gua' }
                );
            }
            formHTML += generateChecklist('hidro', '3 - Instala√ß√µes Hidrossanit√°rias', hidroItems, baseInspection);

            // Inspe√ß√£o Inicial: goteiras e infiltra√ß√µes
            // Inspe√ß√£o Completa: adiciona telhado, calhas, impermeabiliza√ß√£o
            const coberturaItems = [
                { id: 'goteiras', label: 'Presen√ßa de Goteiras', info: 'goteiras' },
                { id: 'infiltracoes', label: 'Infiltra√ß√µes', info: 'infiltracao' }
            ];
            if (isCompleta) {
                coberturaItems.push(
                    { id: 'telhado', label: 'Telhado' },
                    { id: 'calhas', label: 'Calhas' },
                    { id: 'impermeabilizacao', label: 'Impermeabiliza√ß√£o' }
                );
            }
            formHTML += generateChecklist('cobertura', '4 - Cobertura e Impermeabiliza√ß√£o', coberturaItems, baseInspection);

            formHTML += generateChecklist('revestimento', '5 - Revestimento e Acabamentos', [
                { id: 'paredes', label: 'Paredes' },
                { id: 'pisos', label: 'Pisos' },
                { id: 'pintura', label: 'Pintura' },
                { id: 'azulejos', label: 'Azulejos' },
                { id: 'manchas', label: 'Manchas', info: 'manchas' }
            ], baseInspection);

            // Inspe√ß√£o Inicial: funcionamento e conserva√ß√£o
            // Inspe√ß√£o Completa: adiciona portas, janelas, veda√ß√£o
            const esquadriasItems = [
                { id: 'funcionamento', label: 'Funcionamento' },
                { id: 'conservacao', label: 'Estado de Conserva√ß√£o' }
            ];
            if (isCompleta) {
                esquadriasItems.push(
                    { id: 'portas', label: 'Portas' },
                    { id: 'janelas', label: 'Janelas' },
                    { id: 'vedacao', label: 'Veda√ß√£o' }
                );
            }
            formHTML += generateChecklist('esquadrias', '6 - Esquadrias', esquadriasItems, baseInspection);

            formHTML += generateChecklist('infra', '7 - Infraestrutura', [
                { id: 'redeAgua', label: 'Conex√£o √† Rede de √Ågua' },
                { id: 'hidrometro', label: 'Hidr√¥metro Individual' },
                { id: 'redeEsgoto', label: 'Conex√£o √† Rede de Esgoto' },
                { id: 'redeEletrica', label: 'Liga√ß√£o com a Rede El√©trica' },
                { id: 'medidor', label: 'Medidor Individual' }
            ], baseInspection);

            formHTML += generateChecklist('outros', '8 - Outros Problemas Identificados', [
                { id: 'outros', label: 'Descrever Outros Problemas' }
            ], baseInspection);

            // Form Actions
            formHTML += `
                <div class="form-actions">
                    <button class="btn btn-secondary" onclick="backToMenu()">Cancelar</button>
                    <button class="btn" onclick="downloadHTMLReport()" style="background: #4CAF50; color: white;">üåê Exportar HTML (Recomendado)</button>
                    <button class="btn" onclick="downloadDOCXReport()" style="background: #FF5722; color: white;">üìÑ Exportar DOCX</button>
                    <button class="btn btn-success" onclick="saveInspection()">üíæ Salvar Inspe√ß√£o</button>
                </div>
            `;

            formContainer.innerHTML = formHTML;
            formContainer.classList.add('active');
            document.getElementById('mainMenu').classList.remove('active');

            // Add event listeners for checkboxes
            initializeCheckboxListeners();
            
            // Se for inspe√ß√£o completa, renderizar fotos carregadas da inicial
            if (isCompleta && baseInspection) {
                // Inicializar occurrenceCounters com base nas ocorr√™ncias carregadas
                if (baseInspection.checklist) {
                    Object.keys(baseInspection.checklist).forEach(itemId => {
                        const item = baseInspection.checklist[itemId];
                        if (item.occurrences && item.occurrences.length > 1) {
                            occurrenceCounters[itemId] = item.occurrences.length;
                        }
                    });
                }
                
                // Debug: listar todos os containers de fotos no DOM
                setTimeout(() => {
                    const allPhotoContainers = document.querySelectorAll('[id$="_photos"]');
                    console.log(`üîç Total de ${allPhotoContainers.length} containers de fotos encontrados no DOM`);
                    allPhotoContainers.forEach(container => {
                        console.log(`  - ${container.id}`);
                    });
                }, 100);
                
                // Renderizar fotos ap√≥s o DOM estar pronto (com retry)
                const renderPhotos = (attempt = 1, maxAttempts = 5) => {
                    if (Object.keys(photoData).length > 0) {
                        console.log(`üì∏ Tentativa ${attempt} de carregar fotos. Total de ${Object.keys(photoData).length} conjuntos de fotos`);
                        console.log('üì¶ Chaves em photoData:', Object.keys(photoData));
                        
                        let successCount = 0;
                        let failCount = 0;
                        const failedItems = [];
                        
                        Object.keys(photoData).forEach(itemId => {
                            const container = document.getElementById(`${itemId}_photos`);
                            if (container) {
                                console.log(`  ‚úÖ Renderizando ${photoData[itemId].length} foto(s) de: ${itemId}`);
                                displayPhotos(itemId);
                                successCount++;
                            } else {
                                console.log(`  ‚è≥ Container n√£o encontrado: ${itemId}_photos`);
                                failCount++;
                                failedItems.push(itemId);
                            }
                        });
                        
                        // Se ainda h√° containers n√£o encontrados e n√£o atingiu o m√°ximo de tentativas, tentar novamente
                        if (failCount > 0 && attempt < maxAttempts) {
                            console.log(`üîÑ Aguardando DOM... ${failCount} containers pendentes. Tentando novamente em 300ms`);
                            console.log(`   Pendentes: ${failedItems.join(', ')}`);
                            setTimeout(() => renderPhotos(attempt + 1, maxAttempts), 300);
                        } else {
                            if (failCount > 0) {
                                console.warn(`‚ö†Ô∏è Carregamento de fotos finalizado com ${failCount} falhas`);
                                console.warn(`   Itens n√£o encontrados: ${failedItems.join(', ')}`);
                            } else {
                                console.log(`‚úÖ Carregamento de fotos 100% conclu√≠do: ${successCount} conjuntos renderizados`);
                            }
                        }
                    } else {
                        console.log('üì≠ Nenhuma foto para carregar');
                    }
                };
                
                // Iniciar renderiza√ß√£o ap√≥s 300ms
                setTimeout(() => renderPhotos(), 300);
            }
        }

        // Generate FOTOS GERAIS section (special category)
        function generateFotosGerais(baseInspection) {
            let html = `
                <div class="form-section" style="background: #e8f5e9; border-left: 4px solid #4caf50;">
                    <div class="checklist-section">
                        <div class="checklist-header">
                            <h4>üì∏ FOTOS GERAIS DO IM√ìVEL</h4>
                            <p style="color: #666; font-size: 14px; margin-top: 5px;">
                                <span style="color: #f44336; font-weight: bold;">*</span> = Obrigat√≥ria | 
                                As demais s√£o opcionais
                            </p>
                        </div>
            `;

            // Fachada - √öNICA OBRIGAT√ìRIA
            html += generateFotoItem('fotos_fachada', 'Fachada <span style="color: #f44336;">*</span>', baseInspection, true);

            // Sala(s) - OPCIONAL
            const qtdSalas = parseInt(document.getElementById('qtdSalas')?.value || baseInspection?.qtdSalas || 1);
            for (let i = 1; i <= qtdSalas; i++) {
                const label = qtdSalas > 1 ? `Sala ${i}` : 'Sala';
                html += generateFotoItem(`fotos_sala${i}`, label, baseInspection, false);
            }

            // Cozinha(s) - OPCIONAL
            const qtdCozinhas = parseInt(document.getElementById('qtdCozinhas')?.value || baseInspection?.qtdCozinhas || 1);
            for (let i = 1; i <= qtdCozinhas; i++) {
                const label = qtdCozinhas > 1 ? `Cozinha ${i}` : 'Cozinha';
                html += generateFotoItem(`fotos_cozinha${i}`, label, baseInspection, false);
            }

            // Quarto(s) - OPCIONAL
            const qtdQuartos = parseInt(document.getElementById('qtdQuartos')?.value || baseInspection?.qtdQuartos || 1);
            const qtdSuites = parseInt(document.getElementById('qtdSuites')?.value || baseInspection?.qtdSuites || 0);
            const totalQuartos = qtdQuartos + qtdSuites;
            
            for (let i = 1; i <= totalQuartos; i++) {
                const label = totalQuartos > 1 ? `Quarto ${i}` : 'Quarto';
                html += generateFotoItem(`fotos_quarto${i}`, label, baseInspection, false);
            }

            // NOVOS C√îMODOS - OPCIONAIS
            
            // Banheiro(s)
            html += generateFotoItem('fotos_banheiro1', 'Banheiro', baseInspection, false);
            
            // Quarto com Su√≠te (se houver su√≠tes)
            if (qtdSuites > 0) {
                for (let i = 1; i <= qtdSuites; i++) {
                    const label = qtdSuites > 1 ? `Quarto com Su√≠te ${i}` : 'Quarto com Su√≠te';
                    html += generateFotoItem(`fotos_suite${i}`, label, baseInspection, false);
                }
            }
            
            // Quintal (se possui)
            const possuiQuintal = document.getElementById('possuiQuintal')?.value || baseInspection?.possuiQuintal;
            if (possuiQuintal === 'sim') {
                html += generateFotoItem('fotos_quintal', 'Quintal', baseInspection, false);
            }
            
            // √Årea de Servi√ßo
            html += generateFotoItem('fotos_area_servico', '√Årea de Servi√ßo', baseInspection, false);

            html += `
                    </div>
                </div>
            `;

            return html;
        }

        // Generate individual photo item for FOTOS GERAIS
        function generateFotoItem(itemId, label, baseInspection, isRequired = false) {
            const baseValue = baseInspection?.checklist?.[itemId];
            
            return `
                <div class="checklist-item" style="border-bottom: 1px solid #e0e0e0; padding: 15px 0;">
                    <div class="checklist-item-label" style="font-weight: 500;">
                        ${label}
                    </div>
                    <div style="margin-top: 10px;">
                        <button class="btn btn-primary" onclick="addPhoto('${itemId}')" style="font-size: 12px; padding: 8px 15px;">
                            üì∏ Adicionar Foto
                        </button>
                    </div>
                    <div class="photo-preview" id="${itemId}_photos"></div>
                </div>
            `;
        }

        // Generate checklist HTML
        function generateChecklist(category, title, items, baseInspection) {
            let html = `
                <div class="form-section">
                    <div class="checklist-section">
                        <div class="checklist-header">
                            <h4>${title}</h4>
                        </div>
            `;

            items.forEach(item => {
                const itemId = `${category}_${item.id}`;
                const baseValue = baseInspection?.checklist?.[itemId];
                const isChecked = baseValue?.status === 'issue';
                
                // Verificar se √© um item novo (s√≥ existe na completa)
                const isNewItem = !baseValue && baseInspection; // Se n√£o tem valor base E existe inspe√ß√£o base, √© novo
                
                html += `
                    <div class="checklist-item" ${isNewItem ? 'style="background: #fff3cd; border-left: 4px solid #FF9800;"' : ''}>
                        <div class="checklist-item-label">
                            ${isNewItem ? 'üÜï ' : ''}${item.label}
                            ${item.info ? createInfoIcon(item.info) : ''}
                        </div>
                        <div class="checklist-options">
                            <div class="check-option">
                                <input type="checkbox" 
                                       id="${itemId}" 
                                       ${isChecked ? 'checked' : ''}
                                       onchange="toggleObservation('${itemId}')">
                                <label for="${itemId}">Problema</label>
                            </div>
                        </div>
                    </div>
                    <div class="observation-field ${isChecked ? 'active' : ''}" id="${itemId}_obs">
                        <div id="${itemId}_occurrences_container">
                            <!-- Container para m√∫ltiplas ocorr√™ncias -->
                `;
                
                // Se tiver ocorr√™ncias salvas, criar uma div para cada
                const occurrences = baseValue?.occurrences || [{ observation: baseValue?.observation || '', occurrenceNum: 1 }];
                
                occurrences.forEach((occ, index) => {
                    const occNum = occ.occurrenceNum || (index + 1);
                    const isFirst = occNum === 1;
                    
                    html += `
                        <div class="occurrence-item" id="${itemId}_occurrence_${occNum}" ${!isFirst ? 'style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e0e0e0;"' : ''}>
                            <div style="display: flex; justify-content: ${isFirst ? 'between' : 'space-between'}; align-items: center; margin-bottom: 5px;">
                                <label style="display: block; font-size: 13px; color: #666; font-weight: bold;">Ocorr√™ncia ${occNum}:</label>
                                ${!isFirst ? `
                                    <button class="btn btn-secondary" onclick="removeOccurrence('${itemId}', ${occNum})" 
                                            style="font-size: 11px; padding: 4px 8px; background: #dc3545;">
                                        üóëÔ∏è Remover
                                    </button>
                                ` : ''}
                            </div>
                            <textarea id="${itemId}_text_${occNum}" placeholder="Descreva o problema identificado..." style="margin-bottom: 10px;">${occ.observation || ''}</textarea>
                            <div style="margin-bottom: 10px;">
                                <button class="btn btn-primary" onclick="addPhoto('${itemId}_${occNum}')" style="font-size: 12px; padding: 8px 15px;">
                                    üì∏ Adicionar Foto
                                </button>
                            </div>
                            <div class="photo-preview" id="${itemId}_${occNum}_photos"></div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 2px dashed #ddd;">
                            <button class="btn btn-secondary" onclick="addNewOccurrence('${itemId}')" style="font-size: 12px; padding: 8px 15px; background: #28a745;">
                                ‚ûï Adicionar Nova Ocorr√™ncia deste Problema
                            </button>
                        </div>
                    </div>
                `;
            });

            html += `
                    </div>
                </div>
            `;

            return html;
        }

        // Create info icon with tooltip
        function createInfoIcon(infoKey) {
            const info = patologiasInfo[infoKey] || 'Informa√ß√£o n√£o dispon√≠vel';
            return `
                <span class="info-icon">
                    i
                    <span class="tooltip">${info}</span>
                </span>
            `;
        }

        // Get UF options
        function getUFOptions(selectedUF = '') {
            const ufs = ['AC', 'AL', 'AP', 'AM', 'BA', 'CE', 'DF', 'ES', 'GO', 'MA', 'MT', 'MS', 'MG', 'PA', 'PB', 'PR', 'PE', 'PI', 'RJ', 'RN', 'RS', 'RO', 'RR', 'SC', 'SP', 'SE', 'TO'];
            return ufs.map(uf => `<option value="${uf}" ${uf === selectedUF ? 'selected' : ''}>${uf}</option>`).join('');
        }

        // Initialize checkbox listeners
        function initializeCheckboxListeners() {
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    toggleObservation(this.id);
                });
            });
        }

        // Toggle observation field
        function toggleObservation(itemId) {
            const obsField = document.getElementById(`${itemId}_obs`);
            const checkbox = document.getElementById(itemId);
            
            if (checkbox.checked) {
                obsField.classList.add('active');
            } else {
                obsField.classList.remove('active');
            }
        }

        // Add new occurrence of the same problem
        const occurrenceCounters = {}; // Track occurrence numbers for each item
        
        function addNewOccurrence(itemId) {
            // Initialize counter if not exists
            if (!occurrenceCounters[itemId]) {
                occurrenceCounters[itemId] = 1;
            }
            
            // Increment counter
            occurrenceCounters[itemId]++;
            const occurrenceNum = occurrenceCounters[itemId];
            
            // Get container
            const container = document.getElementById(`${itemId}_occurrences_container`);
            
            // Create new occurrence div
            const newOccurrence = document.createElement('div');
            newOccurrence.className = 'occurrence-item';
            newOccurrence.id = `${itemId}_occurrence_${occurrenceNum}`;
            newOccurrence.style.marginTop = '20px';
            newOccurrence.style.paddingTop = '20px';
            newOccurrence.style.borderTop = '2px solid #e0e0e0';
            
            newOccurrence.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                    <label style="display: block; font-size: 13px; color: #666; font-weight: bold;">Ocorr√™ncia ${occurrenceNum}:</label>
                    <button class="btn btn-secondary" onclick="removeOccurrence('${itemId}', ${occurrenceNum})" 
                            style="font-size: 11px; padding: 4px 8px; background: #dc3545;">
                        üóëÔ∏è Remover
                    </button>
                </div>
                <textarea id="${itemId}_text_${occurrenceNum}" 
                          placeholder="Descreva o problema identificado..." 
                          style="margin-bottom: 10px;"></textarea>
                <div style="margin-bottom: 10px;">
                    <button class="btn btn-primary" onclick="addPhoto('${itemId}_${occurrenceNum}')" 
                            style="font-size: 12px; padding: 8px 15px;">
                        üì∏ Adicionar Foto
                    </button>
                </div>
                <div class="photo-preview" id="${itemId}_${occurrenceNum}_photos"></div>
            `;
            
            // Add to container
            container.appendChild(newOccurrence);
            
            // Success feedback
            playSound('success');
        }

        // Remove occurrence
        function removeOccurrence(itemId, occurrenceNum) {
            if (occurrenceNum === 1) {
                alert('N√£o √© poss√≠vel remover a primeira ocorr√™ncia. Desmarque o checkbox "Problema" se n√£o houver problema.');
                return;
            }
            
            if (confirm('Deseja remover esta ocorr√™ncia? As fotos associadas tamb√©m ser√£o removidas.')) {
                // Remove from DOM
                const occurrence = document.getElementById(`${itemId}_occurrence_${occurrenceNum}`);
                if (occurrence) {
                    occurrence.remove();
                }
                
                // Remove photos from photoData
                const photoKey = `${itemId}_${occurrenceNum}`;
                if (photoData[photoKey]) {
                    delete photoData[photoKey];
                }
                
                playSound('success');
            }
        }

        // Vari√°veis globais para c√¢mera e fotos
        let currentPhotoItemId = null;
        let cameraStream = null;
        let capturedPhotoData = null;

        // Add photo - Mostra modal de escolha
        function addPhoto(itemId) {
            currentPhotoItemId = itemId;
            showPhotoChoiceModal();
        }

        // Mostrar modal de escolha (C√¢mera ou Galeria)
        function showPhotoChoiceModal() {
            const modal = document.getElementById('photoChoiceModal');
            modal.classList.add('active');
        }

        // Fechar modal de escolha
        function closePhotoChoiceModal(clearItemId = false) {
            const modal = document.getElementById('photoChoiceModal');
            modal.classList.remove('active');
            // S√≥ limpar currentPhotoItemId se explicitamente solicitado
            // (n√£o limpar quando abrindo c√¢mera ou galeria)
            if (clearItemId) {
                currentPhotoItemId = null;
            }
        }

        // Abrir galeria (funcionalidade original)
        function openGallery() {
            // Salvar itemId ANTES de fechar o modal
            const itemIdToUse = currentPhotoItemId;
            
            if (!itemIdToUse) {
                alert('‚ö†Ô∏è Erro: contexto da foto n√£o encontrado. Tente adicionar a foto novamente.');
                closePhotoChoiceModal(true);
                return;
            }
            
            closePhotoChoiceModal(false); // N√£o limpar itemId ainda
            
            const input = document.getElementById('galleryInput');
            input.value = ''; // Reset do input
            
            if (!photoData[itemIdToUse]) {
                photoData[itemIdToUse] = [];
            }
            
            input.onchange = function(e) {
                const files = Array.from(e.target.files);
                
                if (files.length === 0) {
                    // Se n√£o selecionou nenhum arquivo, limpar itemId
                    currentPhotoItemId = null;
                    return;
                }
                
                console.log('üì∏ Processando', files.length, 'foto(s) da galeria para itemId:', itemIdToUse);
                
                let processedCount = 0;
                
                files.forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        photoData[itemIdToUse].push({
                            data: event.target.result,
                            name: file.name
                        });
                        
                        processedCount++;
                        console.log(`‚úÖ Foto ${processedCount}/${files.length} processada`);
                        
                        // Atualizar display ap√≥s cada foto
                        displayPhotos(itemIdToUse);
                        
                        // Se processou todas as fotos, limpar itemId
                        if (processedCount === files.length) {
                            console.log('‚úÖ Todas as fotos foram adicionadas ao relat√≥rio');
                            currentPhotoItemId = null;
                        }
                    };
                    
                    reader.onerror = function() {
                        console.error('‚ùå Erro ao ler arquivo:', file.name);
                        processedCount++;
                        if (processedCount === files.length) {
                            currentPhotoItemId = null;
                        }
                    };
                    
                    reader.readAsDataURL(file);
                });
            };
            
            input.click();
        }

        // Abrir c√¢mera traseira
        async function openCamera() {
            closePhotoChoiceModal(false); // N√£o limpar itemId, vamos precisar dele depois
            
            const cameraModal = document.getElementById('cameraModal');
            const video = document.getElementById('cameraVideo');
            const cameraContainer = document.getElementById('cameraContainer');
            const cameraPreview = document.getElementById('cameraPreview');
            
            // Mostrar modal da c√¢mera
            cameraModal.classList.add('active');
            cameraContainer.style.display = 'block';
            cameraPreview.classList.remove('active');
            
            try {
                // Primeiro, solicitar permiss√£o b√°sica para poder listar dispositivos
                // Isso √© necess√°rio porque alguns navegadores s√≥ mostram labels ap√≥s permiss√£o
                try {
                    const tempStream = await navigator.mediaDevices.getUserMedia({ video: true });
                    tempStream.getTracks().forEach(track => track.stop());
                } catch (permError) {
                    // Ignorar erro de permiss√£o, vamos tentar mesmo assim
                }
                
                // Agora listar dispositivos para encontrar a c√¢mera traseira
                let deviceId = null;
                
                if (navigator.mediaDevices && navigator.mediaDevices.enumerateDevices) {
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const videoDevices = devices.filter(device => device.kind === 'videoinput');
                    
                    console.log('üì∑ Dispositivos de v√≠deo encontrados:', videoDevices.length);
                    
                    // Procurar c√¢mera traseira pelo label
                    const backCamera = videoDevices.find(device => {
                        if (!device.label) return false;
                        const label = device.label.toLowerCase();
                        return label.includes('back') || 
                               label.includes('rear') || 
                               label.includes('traseira') ||
                               label.includes('environment') ||
                               label.includes('facing back');
                    });
                    
                    // Se n√£o encontrou por label, tentar pela √∫ltima c√¢mera (geralmente √© a traseira em dispositivos m√≥veis)
                    if (!backCamera && videoDevices.length > 1) {
                        // Em dispositivos m√≥veis, geralmente a √∫ltima c√¢mera listada √© a traseira
                        deviceId = videoDevices[videoDevices.length - 1].deviceId;
                        console.log('üì∑ Usando √∫ltima c√¢mera dispon√≠vel (provavelmente traseira)');
                    } else if (backCamera) {
                        deviceId = backCamera.deviceId;
                        console.log('üì∑ C√¢mera traseira encontrada:', backCamera.label);
                    }
                }
                
                // Configurar constraints - for√ßar c√¢mera traseira
                const constraints = {
                    video: {
                        facingMode: { exact: 'environment' }, // For√ßar c√¢mera traseira
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };
                
                // Se encontrou deviceId espec√≠fico, usar ele (prioridade)
                if (deviceId) {
                    constraints.video.deviceId = { exact: deviceId };
                    // Remover facingMode quando usar deviceId espec√≠fico para evitar conflito
                    delete constraints.video.facingMode;
                }
                
                // Tentar acessar a c√¢mera
                try {
                    cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                    video.srcObject = cameraStream;
                    
                    // Verificar qual c√¢mera est√° sendo usada
                    const track = cameraStream.getVideoTracks()[0];
                    const settings = track.getSettings();
                    console.log('üì∑ C√¢mera ativa - facingMode:', settings.facingMode || 'indefinido', 'deviceId:', settings.deviceId || 'indefinido');
                    
                    // Se ainda estiver usando frontal (user), tentar m√©todo alternativo
                    if (settings.facingMode === 'user') {
                        console.warn('‚ö†Ô∏è Detectada c√¢mera frontal, tentando for√ßar traseira...');
                        track.stop();
                        
                        // Tentar com deviceId se dispon√≠vel
                        if (deviceId) {
                            const altConstraints = {
                                video: {
                                    deviceId: { exact: deviceId },
                                    width: { ideal: 1280 },
                                    height: { ideal: 720 }
                                }
                            };
                            cameraStream = await navigator.mediaDevices.getUserMedia(altConstraints);
                            video.srcObject = cameraStream;
                        } else {
                            // Tentar sem exact
                            const altConstraints = {
                                video: {
                                    facingMode: 'environment',
                                    width: { ideal: 1280 },
                                    height: { ideal: 720 }
                                }
                            };
                            cameraStream = await navigator.mediaDevices.getUserMedia(altConstraints);
                            video.srcObject = cameraStream;
                        }
                    }
                    
                } catch (exactError) {
                    console.log('‚ö†Ô∏è Erro com exact, tentando m√©todo alternativo...', exactError);
                    // Se falhar com exact, tentar sem exact mas com deviceId
                    const fallbackConstraints = {
                        video: {
                            facingMode: 'environment',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    };
                    
                    if (deviceId) {
                        fallbackConstraints.video.deviceId = { ideal: deviceId };
                        delete fallbackConstraints.video.facingMode;
                    }
                    
                    cameraStream = await navigator.mediaDevices.getUserMedia(fallbackConstraints);
                    video.srcObject = cameraStream;
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao acessar c√¢mera:', error);
                alert('‚ö†Ô∏è N√£o foi poss√≠vel acessar a c√¢mera traseira. Verifique as permiss√µes do navegador.\n\n' + error.message);
                closeCamera();
            }
        }

        // Fechar c√¢mera
        function closeCamera() {
            const cameraModal = document.getElementById('cameraModal');
            cameraModal.classList.remove('active');
            
            // Parar o stream da c√¢mera
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            // Limpar video
            const video = document.getElementById('cameraVideo');
            video.srcObject = null;
            
            // Resetar preview
            const cameraPreview = document.getElementById('cameraPreview');
            cameraPreview.classList.remove('active');
            capturedPhotoData = null;
            currentPhotoItemId = null;
        }

        // Capturar foto
        function capturePhoto() {
            try {
                const video = document.getElementById('cameraVideo');
                
                // Verificar se o v√≠deo est√° pronto
                if (!video || !video.videoWidth || !video.videoHeight) {
                    alert('‚ö†Ô∏è Aguarde a c√¢mera carregar completamente antes de tirar a foto.');
                    return;
                }
                
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Definir tamanho do canvas igual ao v√≠deo
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                // Desenhar frame do v√≠deo no canvas (c√¢mera traseira - imagem normal)
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // Converter para base64
                capturedPhotoData = canvas.toDataURL('image/jpeg', 0.9);
                
                // Validar se a foto foi capturada
                if (!capturedPhotoData || capturedPhotoData.length < 100) {
                    alert('‚ö†Ô∏è Erro ao capturar foto. Tente novamente.');
                    capturedPhotoData = null;
                    return;
                }
                
                // Mostrar preview (foto n√£o √© salva automaticamente na galeria)
                const cameraContainer = document.getElementById('cameraContainer');
                const cameraPreview = document.getElementById('cameraPreview');
                const capturedPhoto = document.getElementById('capturedPhoto');
                
                capturedPhoto.src = capturedPhotoData;
                cameraContainer.style.display = 'none';
                cameraPreview.classList.add('active');
                
                console.log('‚úÖ Foto capturada com sucesso. Tamanho:', capturedPhotoData.length, 'bytes');
                
            } catch (error) {
                console.error('‚ùå Erro ao capturar foto:', error);
                alert('‚ö†Ô∏è Erro ao capturar foto: ' + error.message);
                capturedPhotoData = null;
            }
        }

        // Salvar foto na galeria do dispositivo
        async function savePhotoToDeviceGallery(canvas) {
            try {
                // Converter canvas para blob
                canvas.toBlob(async function(blob) {
                    try {
                        // Tentar usar a File System Access API (Chrome/Edge)
                        if ('showSaveFilePicker' in window) {
                            const fileHandle = await window.showSaveFilePicker({
                                suggestedName: `inspecao_${Date.now()}.jpg`,
                                types: [{
                                    description: 'Imagens JPEG',
                                    accept: { 'image/jpeg': ['.jpg'] }
                                }]
                            });
                            const writable = await fileHandle.createWritable();
                            await writable.write(blob);
                            await writable.close();
                            console.log('‚úÖ Foto salva na galeria via File System Access API');
                        } 
                        // Fallback: criar link de download
                        else {
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `inspecao_${Date.now()}.jpg`;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);
                            console.log('‚úÖ Foto salva via download (ser√° salva na pasta Downloads)');
                        }
                    } catch (saveError) {
                        console.warn('‚ö†Ô∏è N√£o foi poss√≠vel salvar automaticamente na galeria:', saveError);
                        // N√£o mostrar erro ao usu√°rio, a foto ainda pode ser usada
                    }
                }, 'image/jpeg', 0.9);
            } catch (error) {
                console.warn('‚ö†Ô∏è Erro ao preparar foto para salvar:', error);
            }
        }

        // Salvar foto na galeria e abrir seletor de galeria
        function saveToGalleryAndOpen() {
            if (!capturedPhotoData) {
                alert('‚ö†Ô∏è Nenhuma foto capturada.');
                return;
            }
            
            // Salvar itemId antes de fechar c√¢mera
            const itemIdToPreserve = currentPhotoItemId;
            
            // Fechar c√¢mera (mas preservar itemId)
            const cameraModal = document.getElementById('cameraModal');
            cameraModal.classList.remove('active');
            
            // Parar o stream da c√¢mera
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            // Limpar video
            const video = document.getElementById('cameraVideo');
            video.srcObject = null;
            
            // Resetar preview
            const cameraPreview = document.getElementById('cameraPreview');
            cameraPreview.classList.remove('active');
            capturedPhotoData = null;
            
            // Restaurar itemId
            currentPhotoItemId = itemIdToPreserve;
            
            // Aguardar um pouco e abrir galeria
            setTimeout(() => {
                openGallery();
            }, 300);
        }

        // Tirar outra foto (voltar para c√¢mera)
        function retakePhoto() {
            const cameraContainer = document.getElementById('cameraContainer');
            const cameraPreview = document.getElementById('cameraPreview');
            
            cameraPreview.classList.remove('active');
            cameraContainer.style.display = 'block';
            capturedPhotoData = null; // Limpar foto anterior, mas manter currentPhotoItemId
            console.log('üì∑ Voltando para c√¢mera. ItemId mantido:', currentPhotoItemId);
        }

        // Cancelar foto (fechar c√¢mera sem usar)
        function cancelPhoto() {
            closeCamera();
        }

        // Usar foto capturada
        function useCapturedPhoto() {
            try {
                // Validar dados
                if (!capturedPhotoData) {
                    alert('‚ö†Ô∏è Nenhuma foto capturada. Por favor, tire uma foto primeiro.');
                    return;
                }
                
                if (!currentPhotoItemId) {
                    alert('‚ö†Ô∏è Erro: contexto da foto n√£o encontrado. Tente adicionar a foto novamente.');
                    closeCamera();
                    return;
                }
                
                // Salvar itemId e foto antes de fechar a c√¢mera
                const itemIdToUse = currentPhotoItemId;
                const photoDataToAdd = capturedPhotoData;
                
                console.log('üì∏ Adicionando foto para itemId:', itemIdToUse);
                console.log('üì∏ Tamanho da foto:', photoDataToAdd.length, 'bytes');
                
                // Adicionar foto aos dados
                if (!photoData[itemIdToUse]) {
                    photoData[itemIdToUse] = [];
                }
                
                // Adicionar foto
                photoData[itemIdToUse].push({
                    data: photoDataToAdd,
                    name: `foto_${Date.now()}.jpg`
                });
                
                console.log('‚úÖ Foto adicionada aos dados. Total de fotos para este item:', photoData[itemIdToUse].length);
                
                // Fechar c√¢mera (isso limpa as vari√°veis globais)
                closeCamera();
                
                // Atualizar display ap√≥s fechar c√¢mera
                setTimeout(() => {
                    displayPhotos(itemIdToUse);
                    // Feedback
                    playSound('success');
                }, 100);
                
            } catch (error) {
                console.error('‚ùå Erro ao processar foto:', error);
                alert('‚ö†Ô∏è Erro ao processar foto: ' + error.message);
                closeCamera();
            }
        }

        // Fechar modais ao clicar fora
        window.addEventListener('click', function(event) {
            const photoChoiceModal = document.getElementById('photoChoiceModal');
            const cameraModal = document.getElementById('cameraModal');
            
            // Fechar modal de escolha se clicar fora
            if (event.target === photoChoiceModal) {
                closePhotoChoiceModal(true); // Limpar itemId ao cancelar
            }
            
            // N√£o fechar modal da c√¢mera ao clicar fora (para evitar perder a foto)
            // O usu√°rio deve usar o bot√£o de fechar
        });

        // Display photos
        function displayPhotos(itemId) {
            const container = document.getElementById(`${itemId}_photos`);
            
            if (!container) {
                console.warn(`‚ö†Ô∏è Container ${itemId}_photos n√£o encontrado no DOM`);
                return;
            }
            
            const photos = photoData[itemId] || [];
            
            // Sempre limpar o container primeiro
            container.innerHTML = '';
            
            if (photos.length === 0) {
                console.log(`üì≠ Nenhuma foto para ${itemId}`);
                return;
            }
            
            console.log(`üì∏ Renderizando ${photos.length} foto(s) em ${itemId}_photos`);
            
            photos.forEach((photo, index) => {
                const photoDiv = document.createElement('div');
                photoDiv.className = 'photo-item';
                photoDiv.innerHTML = `
                    <img src="${photo.data}" alt="Foto ${index + 1}">
                    <button class="photo-remove" onclick="removePhoto('${itemId}', ${index})">√ó</button>
                `;
                container.appendChild(photoDiv);
            });
        }

        // Remove photo
        function removePhoto(itemId, index) {
            if (photoData[itemId] && photoData[itemId][index] !== undefined) {
                // Remover a foto do array
                photoData[itemId].splice(index, 1);
                
                // Se n√£o sobrou nenhuma foto, limpar o array (mas manter a chave)
                if (photoData[itemId].length === 0) {
                    // Manter a chave mas com array vazio para permitir adicionar novas fotos
                    photoData[itemId] = [];
                }
                
                // Atualizar display (mesmo que esteja vazio, para limpar a interface)
                displayPhotos(itemId);
            }
        }

        // Fun√ß√£o auxiliar para converter base64 para Uint8Array
        async function base64ToUint8Array(base64String) {
            try {
                // Validar entrada
                if (!base64String || typeof base64String !== 'string') {
                    throw new Error('Base64 string inv√°lida');
                }
                
                // Remove o prefixo data:image/...;base64, se houver
                const base64 = base64String.includes(',') ? base64String.split(',')[1] : base64String;
                
                // Validar formato base64
                if (!base64 || base64.trim().length === 0) {
                    throw new Error('String base64 vazia');
                }
                
                const binaryString = atob(base64);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                return bytes;
            } catch (error) {
                console.error('‚ùå Erro ao converter base64 para Uint8Array:', error);
                throw new Error('Falha ao processar imagem: ' + error.message);
            }
        }

        // Fun√ß√£o auxiliar para obter dimens√µes da imagem
        function getImageDimensions(base64String) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = function() {
                    resolve({
                        width: this.width,
                        height: this.height
                    });
                };
                img.onerror = function() {
                    resolve({ width: 400, height: 300 }); // Dimens√µes padr√£o
                };
                img.src = base64String;
            });
        }

        // Fun√ß√£o auxiliar para detectar o tipo de imagem do base64
        function getImageType(base64String) {
            // Extrair o tipo MIME do prefixo data:image/...;base64,
            if (base64String.startsWith('data:image/')) {
                const mimeType = base64String.split(';')[0].split(':')[1];
                if (mimeType.includes('png')) return 'png';
                if (mimeType.includes('jpeg') || mimeType.includes('jpg')) return 'jpg';
                if (mimeType.includes('gif')) return 'gif';
                if (mimeType.includes('bmp')) return 'bmp';
            }
            // Por padr√£o, retornar jpg se n√£o conseguir detectar
            return 'jpg';
        }

        // Download DOCX Report
        async function downloadDOCXReport() {
            // Validar formul√°rio primeiro
            if (!validateForm()) {
                alert('‚ö†Ô∏è Por favor, preencha todos os campos obrigat√≥rios antes de gerar o relat√≥rio.');
                return;
            }
            
            // Coletar dados do formul√°rio
            const inspection = collectFormData();
            
            try {
                showProgress('Gerando relat√≥rio DOCX...');
                
                // Verificar se a biblioteca docx est√° dispon√≠vel
                // Aguardar um pouco para garantir que a biblioteca carregou
                await new Promise(resolve => setTimeout(resolve, 500));
                
                let docxLib = null;
                if (typeof docx !== 'undefined') {
                    docxLib = docx;
                } else if (typeof window.docx !== 'undefined') {
                    docxLib = window.docx;
                }
                
                if (!docxLib) {
                    alert('‚ö†Ô∏è Biblioteca docx n√£o est√° dispon√≠vel. Por favor, recarregue a p√°gina e tente novamente.\n\nSe o problema persistir, verifique sua conex√£o com a internet.');
                    hideProgress();
                    return;
                }

                const { Document, Packer, Paragraph, TextRun, HeadingLevel, AlignmentType, WidthType, ImageRun, Media } = docxLib;
                
                // Array para armazenar elementos do documento
                const children = [];
                
                // T√≠tulo do relat√≥rio
                children.push(
                    new Paragraph({
                        text: "RELAT√ìRIO DE INSPE√á√ÉO RESIDENCIAL",
                        heading: HeadingLevel.HEADING_1,
                        alignment: AlignmentType.CENTER,
                        spacing: { after: 200 }
                    })
                );
                
                // Tipo de inspe√ß√£o
                const tipoTexto = inspection.type === 'inicial' ? 'INSPE√á√ÉO INICIAL' : 'INSPE√á√ÉO COMPLETA';
                children.push(
                    new Paragraph({
                        text: tipoTexto,
                        heading: HeadingLevel.HEADING_2,
                        alignment: AlignmentType.CENTER,
                        spacing: { after: 300 }
                    })
                );
                
                // DADOS DO IM√ìVEL
                children.push(
                    new Paragraph({
                        text: "DADOS DO IM√ìVEL",
                        heading: HeadingLevel.HEADING_2,
                        spacing: { before: 200, after: 200 }
                    })
                );
                
                const dadosImovel = [
                    ['Endere√ßo:', `${inspection.endereco}, ${inspection.numero}`],
                    ['Complemento:', inspection.complemento || 'N/A'],
                    ['Bairro:', inspection.bairro],
                    ['Munic√≠pio/UF:', `${inspection.municipio} - ${inspection.uf}`],
                    ['Data da Vistoria:', inspection.dataVistoria],
                    ['Hora da Vistoria:', inspection.horaVistoria],
                    ['Acompanhante:', inspection.acompanhante],
                    ['Idade do Im√≥vel:', `${inspection.idadeImovel} anos`]
                ];
                
                dadosImovel.forEach(([label, value]) => {
                    children.push(
                        new Paragraph({
                            children: [
                                new TextRun({ text: label, bold: true }),
                                new TextRun({ text: ` ${value}` })
                            ],
                            spacing: { after: 100 }
                        })
                    );
                });
                
                // CARACTER√çSTICAS
                children.push(
                    new Paragraph({
                        text: "CARACTER√çSTICAS DO IM√ìVEL",
                        heading: HeadingLevel.HEADING_2,
                        spacing: { before: 400, after: 200 }
                    })
                );
                
                const caracteristicas = [
                    ['Pavimentos:', inspection.qtdPavimentos || 'N/A'],
                    ['Salas:', inspection.qtdSalas || 'N/A'],
                    ['Quartos:', inspection.qtdQuartos || 'N/A'],
                    ['Su√≠tes:', inspection.qtdSuites || 'N/A'],
                    ['Cozinhas:', inspection.qtdCozinhas || 'N/A'],
                    ['Quintal:', inspection.possuiQuintal || 'N/A'],
                    ['Garagem:', inspection.possuiGaragem || 'N/A']
                ];
                
                caracteristicas.forEach(([label, value]) => {
                    children.push(
                        new Paragraph({
                            children: [
                                new TextRun({ text: label, bold: true }),
                                new TextRun({ text: ` ${value}` })
                            ],
                            spacing: { after: 100 }
                        })
                    );
                });
                
                // FOTOS GERAIS DO IM√ìVEL
                const fotosGerais = [];
                if (inspection.photos) {
                    Object.keys(inspection.photos).forEach(key => {
                        if (key.startsWith('fotos_')) {
                            const nomeLimpo = key.replace('fotos_', '').replace(/\d+$/, '').replace(/_/g, ' ');
                            fotosGerais.push({
                                key: key,
                                nome: nomeLimpo.charAt(0).toUpperCase() + nomeLimpo.slice(1),
                                fotos: inspection.photos[key]
                            });
                        }
                    });
                }
                
                if (fotosGerais.length > 0) {
                    children.push(
                        new Paragraph({
                            text: "FOTOS GERAIS DO IM√ìVEL",
                            heading: HeadingLevel.HEADING_2,
                            spacing: { before: 400, after: 200 }
                        })
                    );
                    
                    for (const fotoGeral of fotosGerais) {
                        if (fotoGeral.fotos && fotoGeral.fotos.length > 0) {
                            children.push(
                                new Paragraph({
                                    text: fotoGeral.nome.toUpperCase(),
                                    heading: HeadingLevel.HEADING_3,
                                    spacing: { before: 200, after: 100 }
                                })
                            );
                            
                            for (let i = 0; i < fotoGeral.fotos.length; i++) {
                                try {
                                    const imageData = (typeof fotoGeral.fotos[i] === 'object' && fotoGeral.fotos[i].data) ? 
                                        fotoGeral.fotos[i].data : fotoGeral.fotos[i];
                                    
                                    const imageBytes = await base64ToUint8Array(imageData);
                                    const dimensions = await getImageDimensions(imageData);
                                    const imageType = getImageType(imageData);
                                    
                                    // Redimensionar para caber no documento (max width 400px para evitar problemas)
                                    const maxWidth = 400;
                                    const aspectRatio = dimensions.width / dimensions.height;
                                    let width = Math.min(dimensions.width, maxWidth);
                                    let height = width / aspectRatio;
                                    
                                    // Garantir que as dimens√µes sejam v√°lidas
                                    if (width <= 0 || height <= 0 || !isFinite(width) || !isFinite(height)) {
                                        width = 400;
                                        height = 300;
                                    }
                                    
                                    // Converter para EMU (English Metric Units) - 1 pixel = 9525 EMU
                                    const widthEMU = Math.round(width * 9525);
                                    const heightEMU = Math.round(height * 9525);
                                    
                                    children.push(
                                        new Paragraph({
                                            children: [
                                                new ImageRun({
                                                    data: imageBytes,
                                                    transformation: {
                                                        width: widthEMU,
                                                        height: heightEMU
                                                    },
                                                    type: imageType
                                                })
                                            ],
                                            alignment: AlignmentType.LEFT,
                                            spacing: { after: 200 }
                                        })
                                    );
                                    
                                    children.push(
                                        new Paragraph({
                                            text: `Foto ${i + 1}`,
                                            spacing: { after: 200 }
                                        })
                                    );
                                } catch (error) {
                                    console.error('‚ùå Erro ao adicionar foto geral ao DOCX:', error);
                                    children.push(
                                        new Paragraph({
                                            text: `[Erro ao carregar foto ${i + 1}]`,
                                            spacing: { after: 200 }
                                        })
                                    );
                                }
                            }
                        }
                    }
                }
                
                // PROBLEMAS ENCONTRADOS
                const problemasEncontrados = [];
                
                if (inspection.checklist) {
                    Object.keys(inspection.checklist).forEach(itemId => {
                        const item = inspection.checklist[itemId];
                        
                        if (item.status === 'issue' && isValidInspectionItem(itemId)) {
                            const categoryName = getCategoryNameFromId(itemId);
                            const itemName = getItemNameFromId(itemId);
                            
                            if (item.occurrences && item.occurrences.length > 0) {
                                item.occurrences.forEach((occ, index) => {
                                    const occNum = occ.occurrenceNum || (index + 1);
                                    problemasEncontrados.push({
                                        categoria: categoryName,
                                        item: itemName,
                                        ocorrencia: occNum,
                                        observacao: occ.observation || 'Sem observa√ß√£o',
                                        photoKey: `${itemId}_${occNum}`
                                    });
                                });
                            } else if (item.observation) {
                                problemasEncontrados.push({
                                    categoria: categoryName,
                                    item: itemName,
                                    ocorrencia: 1,
                                    observacao: item.observation,
                                    photoKey: `${itemId}_1`
                                });
                            } else {
                                problemasEncontrados.push({
                                    categoria: categoryName,
                                    item: itemName,
                                    ocorrencia: 1,
                                    observacao: 'Problema identificado',
                                    photoKey: `${itemId}_1`
                                });
                            }
                        }
                    });
                }
                
                if (problemasEncontrados.length > 0) {
                    children.push(
                        new Paragraph({
                            text: "PROBLEMAS ENCONTRADOS",
                            heading: HeadingLevel.HEADING_2,
                            spacing: { before: 400, after: 200 }
                        })
                    );
                    
                    for (let i = 0; i < problemasEncontrados.length; i++) {
                        const problema = problemasEncontrados[i];
                        
                        // N√∫mero do problema
                        children.push(
                            new Paragraph({
                                children: [
                                    new TextRun({ 
                                        text: `${i + 1}. ${problema.categoria} - ${problema.item}`, 
                                        bold: true,
                                        size: 22
                                    })
                                ],
                                spacing: { before: 200, after: 100 }
                            })
                        );
                        
                        // Ocorr√™ncia (se houver m√∫ltiplas)
                        if (problemasEncontrados.filter(p => p.item === problema.item).length > 1) {
                            children.push(
                                new Paragraph({
                                    text: `(Ocorr√™ncia ${problema.ocorrencia})`,
                                    spacing: { after: 100 }
                                })
                            );
                        }
                        
                        // Observa√ß√£o
                        children.push(
                            new Paragraph({
                                children: [
                                    new TextRun({ text: "Observa√ß√£o: ", bold: true }),
                                    new TextRun({ text: problema.observacao })
                                ],
                                spacing: { after: 200 }
                            })
                        );
                        
                        // Adicionar fotos se existirem
                        if (inspection.photos && inspection.photos[problema.photoKey]) {
                            const fotos = inspection.photos[problema.photoKey];
                            
                            for (let j = 0; j < fotos.length; j++) {
                                try {
                                    const imageData = (typeof fotos[j] === 'object' && fotos[j].data) ? fotos[j].data : fotos[j];
                                    const imageBytes = await base64ToUint8Array(imageData);
                                    const dimensions = await getImageDimensions(imageData);
                                    const imageType = getImageType(imageData);
                                    
                                    // Redimensionar para caber no documento (max width 400px para evitar problemas)
                                    const maxWidth = 400;
                                    const aspectRatio = dimensions.width / dimensions.height;
                                    let width = Math.min(dimensions.width, maxWidth);
                                    let height = width / aspectRatio;
                                    
                                    // Garantir que as dimens√µes sejam v√°lidas
                                    if (width <= 0 || height <= 0 || !isFinite(width) || !isFinite(height)) {
                                        width = 400;
                                        height = 300;
                                    }
                                    
                                    // Converter para EMU (English Metric Units) - 1 pixel = 9525 EMU
                                    const widthEMU = Math.round(width * 9525);
                                    const heightEMU = Math.round(height * 9525);
                                    
                                    children.push(
                                        new Paragraph({
                                            children: [
                                                new ImageRun({
                                                    data: imageBytes,
                                                    transformation: {
                                                        width: widthEMU,
                                                        height: heightEMU
                                                    },
                                                    type: imageType
                                                })
                                            ],
                                            alignment: AlignmentType.LEFT,
                                            spacing: { after: 200 }
                                        })
                                    );
                                    
                                    children.push(
                                        new Paragraph({
                                            text: `Foto ${j + 1} - ${problema.observacao}`,
                                            spacing: { after: 200 }
                                        })
                                    );
                                } catch (error) {
                                    console.error('‚ùå Erro ao adicionar foto ao DOCX:', error);
                                    children.push(
                                        new Paragraph({
                                            text: `[Erro ao carregar foto ${j + 1}]`,
                                            spacing: { after: 200 }
                                        })
                                    );
                                }
                            }
                        } else {
                            children.push(
                                new Paragraph({
                                    text: "(Sem fotos anexadas)",
                                    spacing: { after: 200 }
                                })
                            );
                        }
                    }
                } else {
                    children.push(
                        new Paragraph({
                            text: "PROBLEMAS ENCONTRADOS",
                            heading: HeadingLevel.HEADING_2,
                            spacing: { before: 400, after: 200 }
                        })
                    );
                    
                    children.push(
                        new Paragraph({
                            text: "‚úì Nenhum problema identificado na inspe√ß√£o.",
                            spacing: { after: 200 }
                        })
                    );
                }
                
                // Criar documento com configura√ß√µes b√°sicas
                const doc = new Document({
                    creator: "Sistema de Inspe√ß√£o Residencial",
                    title: `Relat√≥rio de Inspe√ß√£o - ${inspection.type}`,
                    description: `Relat√≥rio de inspe√ß√£o residencial gerado em ${new Date().toLocaleString('pt-BR')}`,
                    sections: [{
                        properties: {
                            page: {
                                margin: {
                                    top: 1440,    // 1 polegada = 1440 twips
                                    right: 1440,
                                    bottom: 1440,
                                    left: 1440
                                }
                            }
                        },
                        children: children
                    }]
                });
                
                // Gerar blob com tratamento de erro
                let blob;
                try {
                    blob = await Packer.toBlob(doc);
                    console.log('‚úÖ Documento DOCX gerado com sucesso, tamanho:', blob.size, 'bytes');
                    
                    // Verificar se o blob √© v√°lido
                    if (!blob || blob.size === 0) {
                        throw new Error('Arquivo DOCX gerado est√° vazio');
                    }
                } catch (error) {
                    console.error('‚ùå Erro ao gerar blob do documento:', error);
                    throw new Error('Erro ao gerar arquivo DOCX: ' + error.message);
                }
                
                // Nome do arquivo
                const nomeArquivo = `Relatorio_${inspection.type}_${inspection.municipio.replace(/\s+/g, '_')}_${inspection.dataVistoria.replace(/\//g, '-')}.docx`;
                
                // Primeiro, sempre fazer download local para garantir que o arquivo est√° OK
                saveAs(blob, nomeArquivo);
                hideProgress();
                playSound('success');
                
                // Fazer upload para o Drive em background (sem bloquear)
                if (accessToken) {
                    // Upload em background sem bloquear a interface
                    (async () => {
                        try {
                            showProgress('Enviando relat√≥rio para o Google Drive...');
                            
                            // Timeout de 30 segundos para o upload
                            const uploadPromise = (async () => {
                                // Obter ou criar pasta da obra no Drive
                                let folderId = inspection.driveFolderId;
                                
                                if (!folderId) {
                                    // Criar estrutura de pastas se n√£o existir
                                    if (!SHARED_FOLDER_ID) {
                                        throw new Error('Pasta compartilhada n√£o configurada');
                                    }
                                    
                                    await ensureSharedFolderAccess();
                                    const rootFolderId = SHARED_FOLDER_ID;
                                    
                                    const typeFolderName = inspection.type === 'inicial' ? 'inspecao_inicial' : 'inspecao_completa';
                                    const typeFolderId = await findOrCreateFolder(typeFolderName, rootFolderId);
                                    
                                    const dateFolder = formatDate(inspection.dataVistoria).replace(/\//g, '-');
                                    const dateFolderId = await findOrCreateFolder(dateFolder, typeFolderId);
                                    
                                    const addressFolder = `${inspection.endereco}_${inspection.numero}`.replace(/[^a-zA-Z0-9]/g, '_');
                                    folderId = await findOrCreateFolder(addressFolder, dateFolderId);
                                }
                                
                                // Upload direto do blob para o Drive
                                await uploadFile(blob, nomeArquivo, folderId, 'application/vnd.openxmlformats-officedocument.wordprocessingml.document');
                            })();
                            
                            // Adicionar timeout
                            const timeoutPromise = new Promise((_, reject) => {
                                setTimeout(() => reject(new Error('Timeout: Upload demorou mais de 30 segundos')), 30000);
                            });
                            
                            await Promise.race([uploadPromise, timeoutPromise]);
                            
                            hideProgress();
                            alert('‚úÖ Relat√≥rio DOCX tamb√©m foi enviado para o Google Drive com sucesso!\n\nüìÑ O arquivo foi salvo na pasta da obra.');
                            
                        } catch (error) {
                            console.error('Erro ao enviar para o Drive:', error);
                            hideProgress();
                            // N√£o mostrar alerta de erro para n√£o incomodar - o arquivo j√° foi baixado
                            console.warn('‚ö†Ô∏è Upload para Drive falhou, mas arquivo foi salvo localmente:', error.message);
                        }
                    })();
                    
                    // Mostrar mensagem de sucesso imediatamente
                    alert('‚úÖ Relat√≥rio DOCX gerado com sucesso!\n\nüìÑ O arquivo foi baixado automaticamente.\n\nüì§ O upload para o Google Drive est√° sendo feito em segundo plano.');
                } else {
                    // Apenas download local se n√£o estiver conectado ao Drive
                    alert('‚úÖ Relat√≥rio DOCX gerado com sucesso!\n\nüìÑ O arquivo foi baixado automaticamente.\n\n‚ö†Ô∏è N√£o conectado ao Google Drive. Para enviar automaticamente, configure o Drive nas Configura√ß√µes.');
                }
                
            } catch (error) {
                hideProgress();
                console.error('Erro ao gerar DOCX:', error);
                alert('‚ùå Erro ao gerar DOCX. Verifique o console para mais detalhes.\n\nErro: ' + error.message);
            }
        }

        // Download HTML Report (RECOMENDADO - mais robusto que DOCX)
        async function downloadHTMLReport() {
            // Validar formul√°rio primeiro
            if (!validateForm()) {
                alert('‚ö†Ô∏è Por favor, preencha todos os campos obrigat√≥rios antes de gerar o relat√≥rio.');
                return;
            }
            
            // Coletar dados do formul√°rio
            const inspection = collectFormData();
            
            try {
                showProgress('Gerando relat√≥rio HTML...');
                
                // Criar HTML completo
                let html = `
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relat√≥rio de Inspe√ß√£o - ${inspection.endereco}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #667eea;
            text-align: center;
            font-size: 32px;
            margin-bottom: 10px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 15px;
        }
        
        h2 {
            color: #667eea;
            font-size: 24px;
            margin-top: 30px;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        h3 {
            color: #764ba2;
            font-size: 18px;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            font-size: 18px;
            margin-bottom: 30px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .info-label {
            font-weight: bold;
            color: #555;
        }
        
        .info-value {
            color: #333;
        }
        
        .problem-item {
            background: #f9f9f9;
            border-left: 4px solid #ff5722;
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 4px;
        }
        
        .problem-title {
            font-weight: bold;
            color: #ff5722;
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        .problem-observation {
            color: #555;
            margin: 10px 0;
            font-style: italic;
        }
        
        .photos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }
        
        .photo-item {
            text-align: center;
        }
        
        .photo-item img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 8px;
        }
        
        .photo-caption {
            font-size: 14px;
            color: #666;
        }
        
        .no-problems {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 20px;
            border-radius: 4px;
            color: #2e7d32;
            font-weight: 500;
        }
        
        .footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
            text-align: center;
            color: #666;
            font-size: 14px;
        }
        
        @media print {
            body {
                background: white;
                padding: 0;
            }
            .container {
                box-shadow: none;
                padding: 20px;
            }
            .photo-item img {
                max-width: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>RELAT√ìRIO DE INSPE√á√ÉO RESIDENCIAL</h1>
        <p class="subtitle">${inspection.type === 'inicial' ? 'INSPE√á√ÉO INICIAL' : 'INSPE√á√ÉO COMPLETA'}</p>
        
        <h2>üìã DADOS DO IM√ìVEL</h2>
        <div class="info-grid">
            <div class="info-label">Endere√ßo:</div>
            <div class="info-value">${inspection.endereco}, ${inspection.numero}</div>
            
            <div class="info-label">Complemento:</div>
            <div class="info-value">${inspection.complemento || 'N/A'}</div>
            
            <div class="info-label">Bairro:</div>
            <div class="info-value">${inspection.bairro}</div>
            
            <div class="info-label">Munic√≠pio/UF:</div>
            <div class="info-value">${inspection.municipio} - ${inspection.uf}</div>
            
            <div class="info-label">Data da Vistoria:</div>
            <div class="info-value">${inspection.dataVistoria}</div>
            
            <div class="info-label">Hora da Vistoria:</div>
            <div class="info-value">${inspection.horaVistoria}</div>
            
            <div class="info-label">Acompanhante:</div>
            <div class="info-value">${inspection.acompanhante}</div>
            
            <div class="info-label">Idade do Im√≥vel:</div>
            <div class="info-value">${inspection.idadeImovel} anos</div>
        </div>
        
        <h2>üè† CARACTER√çSTICAS DO IM√ìVEL</h2>
        <div class="info-grid">
            <div class="info-label">Pavimentos:</div>
            <div class="info-value">${inspection.qtdPavimentos || 'N/A'}</div>
            
            <div class="info-label">Salas:</div>
            <div class="info-value">${inspection.qtdSalas || 'N/A'}</div>
            
            <div class="info-label">Quartos:</div>
            <div class="info-value">${inspection.qtdQuartos || 'N/A'}</div>
            
            <div class="info-label">Su√≠tes:</div>
            <div class="info-value">${inspection.qtdSuites || 'N/A'}</div>
            
            <div class="info-label">Cozinhas:</div>
            <div class="info-value">${inspection.qtdCozinhas || 'N/A'}</div>
            
            <div class="info-label">Quintal:</div>
            <div class="info-value">${inspection.possuiQuintal || 'N/A'}</div>
            
            <div class="info-label">Garagem:</div>
            <div class="info-value">${inspection.possuiGaragem || 'N/A'}</div>
        </div>
`;
                
                // FOTOS GERAIS DO IM√ìVEL
                const fotosGerais = [];
                if (inspection.photos) {
                    Object.keys(inspection.photos).forEach(key => {
                        if (key.startsWith('fotos_')) {
                            const nomeLimpo = key.replace('fotos_', '').replace(/\d+$/, '').replace(/_/g, ' ');
                            fotosGerais.push({
                                key: key,
                                nome: nomeLimpo.charAt(0).toUpperCase() + nomeLimpo.slice(1),
                                fotos: inspection.photos[key]
                            });
                        }
                    });
                }
                
                if (fotosGerais.length > 0) {
                    html += `<h2>üì∏ FOTOS GERAIS DO IM√ìVEL</h2>`;
                    
                    for (const fotoGeral of fotosGerais) {
                        if (fotoGeral.fotos && fotoGeral.fotos.length > 0) {
                            html += `<h3>${fotoGeral.nome.toUpperCase()}</h3>`;
                            html += `<div class="photos-grid">`;
                            
                            for (let i = 0; i < fotoGeral.fotos.length; i++) {
                                const imageData = (typeof fotoGeral.fotos[i] === 'object' && fotoGeral.fotos[i].data) ? 
                                    fotoGeral.fotos[i].data : fotoGeral.fotos[i];
                                
                                html += `
                                    <div class="photo-item">
                                        <img src="${imageData}" alt="Foto ${i + 1}">
                                        <div class="photo-caption">Foto ${i + 1}</div>
                                    </div>
                                `;
                            }
                            
                            html += `</div>`;
                        }
                    }
                }
                
                // PROBLEMAS ENCONTRADOS
                const problemasEncontrados = [];
                
                if (inspection.checklist) {
                    Object.keys(inspection.checklist).forEach(itemId => {
                        const item = inspection.checklist[itemId];
                        
                        if (item.status === 'issue' && isValidInspectionItem(itemId)) {
                            const categoryName = getCategoryNameFromId(itemId);
                            const itemName = getItemNameFromId(itemId);
                            
                            if (item.occurrences && item.occurrences.length > 0) {
                                item.occurrences.forEach((occ, index) => {
                                    const occNum = occ.occurrenceNum || (index + 1);
                                    problemasEncontrados.push({
                                        categoria: categoryName,
                                        item: itemName,
                                        ocorrencia: occNum,
                                        observacao: occ.observation || 'Sem observa√ß√£o',
                                        photoKey: `${itemId}_${occNum}`
                                    });
                                });
                            } else if (item.observation) {
                                problemasEncontrados.push({
                                    categoria: categoryName,
                                    item: itemName,
                                    ocorrencia: 1,
                                    observacao: item.observation,
                                    photoKey: `${itemId}_1`
                                });
                            } else {
                                problemasEncontrados.push({
                                    categoria: categoryName,
                                    item: itemName,
                                    ocorrencia: 1,
                                    observacao: 'Problema identificado',
                                    photoKey: `${itemId}_1`
                                });
                            }
                        }
                    });
                }
                
                html += `<h2>‚ö†Ô∏è PROBLEMAS ENCONTRADOS</h2>`;
                
                if (problemasEncontrados.length > 0) {
                    for (let i = 0; i < problemasEncontrados.length; i++) {
                        const problema = problemasEncontrados[i];
                        
                        html += `
                            <div class="problem-item">
                                <div class="problem-title">${i + 1}. ${problema.categoria} - ${problema.item}</div>
                                ${problemasEncontrados.filter(p => p.item === problema.item).length > 1 ? 
                                    `<div>(Ocorr√™ncia ${problema.ocorrencia})</div>` : ''}
                                <div class="problem-observation"><strong>Observa√ß√£o:</strong> ${problema.observacao}</div>
                        `;
                        
                        // Adicionar fotos se existirem
                        if (inspection.photos && inspection.photos[problema.photoKey]) {
                            const fotos = inspection.photos[problema.photoKey];
                            
                            html += `<div class="photos-grid">`;
                            
                            for (let j = 0; j < fotos.length; j++) {
                                const imageData = (typeof fotos[j] === 'object' && fotos[j].data) ? fotos[j].data : fotos[j];
                                
                                html += `
                                    <div class="photo-item">
                                        <img src="${imageData}" alt="Foto do problema ${j + 1}">
                                        <div class="photo-caption">Foto ${j + 1}</div>
                                    </div>
                                `;
                            }
                            
                            html += `</div>`;
                        }
                        
                        html += `</div>`;
                    }
                } else {
                    html += `<div class="no-problems">‚úì Nenhum problema identificado na inspe√ß√£o.</div>`;
                }
                
                // Footer
                html += `
        <div class="footer">
            <p><strong>Relat√≥rio gerado em:</strong> ${new Date().toLocaleString('pt-BR')}</p>
            <p><strong>Sistema de Inspe√ß√£o Residencial</strong> - Eng. Bruno Machado</p>
            <p style="margin-top: 10px; font-size: 12px; color: #999;">
                üí° <strong>Dica:</strong> Para imprimir como PDF, pressione Ctrl+P (Windows) ou Cmd+P (Mac) e escolha "Salvar como PDF"<br>
                üí° Para abrir no Word e salvar como DOCX, clique com bot√£o direito no arquivo ‚Üí Abrir com ‚Üí Microsoft Word
            </p>
        </div>
    </div>
</body>
</html>
`;
                
                // Criar blob e fazer download
                const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
                const nomeArquivo = `Relatorio_${inspection.type}_${inspection.municipio.replace(/\s+/g, '_')}_${inspection.dataVistoria.replace(/\//g, '-')}.html`;
                
                saveAs(blob, nomeArquivo);
                hideProgress();
                playSound('success');
                
                alert(`‚úÖ Relat√≥rio HTML gerado com sucesso!

üìÅ Arquivo: ${nomeArquivo}

üí° COMO USAR:
1. Abra o arquivo no navegador para visualizar
2. Para PDF: Abra no navegador ‚Üí Ctrl+P ‚Üí Salvar como PDF
3. Para DOCX: Clique com bot√£o direito ‚Üí Abrir com ‚Üí Word ‚Üí Salvar como DOCX

‚ú® O HTML √© mais confi√°vel e n√£o corrompe!`);
                
            } catch (error) {
                hideProgress();
                console.error('Erro ao gerar HTML:', error);
                alert('‚ùå Erro ao gerar HTML: ' + error.message);
            }
        }

        // Download PDF Report (mantido para compatibilidade)
        async function downloadPDFReport() {
            // Validar formul√°rio primeiro
            if (!validateForm()) {
                alert('‚ö†Ô∏è Por favor, preencha todos os campos obrigat√≥rios antes de gerar o relat√≥rio.');
                return;
            }
            
            // Coletar dados do formul√°rio
            const inspection = collectFormData();
            
            // Verificar se jsPDF est√° dispon√≠vel
            if (typeof window.jspdf === 'undefined') {
                alert('‚ö†Ô∏è Biblioteca jsPDF ainda est√° carregando. Aguarde alguns segundos e tente novamente.');
                return;
            }
            
            try {
                showProgress('Gerando relat√≥rio PDF...');
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                let yPos = 20;
                const pageHeight = doc.internal.pageSize.height;
                const pageWidth = doc.internal.pageSize.width;
                const margin = 15;
                const maxWidth = pageWidth - (2 * margin);
                
                // Fun√ß√£o para adicionar nova p√°gina se necess√°rio
                const checkPageBreak = (neededSpace = 20) => {
                    if (yPos + neededSpace > pageHeight - 20) {
                        doc.addPage();
                        yPos = 20;
                        return true;
                    }
                    return false;
                };
                
                // T√≠tulo do relat√≥rio
                doc.setFontSize(20);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(102, 126, 234);
                doc.text('RELAT√ìRIO DE INSPE√á√ÉO RESIDENCIAL', margin, yPos);
                yPos += 10;
                
                // Tipo de inspe√ß√£o
                doc.setFontSize(14);
                doc.setTextColor(100, 100, 100);
                const tipoTexto = inspection.type === 'inicial' ? 'INSPE√á√ÉO INICIAL' : 'INSPE√á√ÉO COMPLETA';
                doc.text(tipoTexto, margin, yPos);
                yPos += 15;
                
                // Linha divis√≥ria
                doc.setDrawColor(102, 126, 234);
                doc.setLineWidth(0.5);
                doc.line(margin, yPos, pageWidth - margin, yPos);
                yPos += 10;
                
                // DADOS DO IM√ìVEL
                doc.setFontSize(14);
                doc.setTextColor(0, 0, 0);
                doc.setFont(undefined, 'bold');
                doc.text('DADOS DO IM√ìVEL', margin, yPos);
                yPos += 8;
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                
                const dadosImovel = [
                    ['Endere√ßo:', `${inspection.endereco}, ${inspection.numero}`],
                    ['Complemento:', inspection.complemento || 'N/A'],
                    ['Bairro:', inspection.bairro],
                    ['Munic√≠pio/UF:', `${inspection.municipio} - ${inspection.uf}`],
                    ['Data da Vistoria:', inspection.dataVistoria],
                    ['Hora da Vistoria:', inspection.horaVistoria],
                    ['Acompanhante:', inspection.acompanhante],
                    ['Idade do Im√≥vel:', `${inspection.idadeImovel} anos`]
                ];
                
                dadosImovel.forEach(([label, value]) => {
                    checkPageBreak();
                    doc.setFont(undefined, 'bold');
                    doc.text(label, margin, yPos);
                    doc.setFont(undefined, 'normal');
                    doc.text(String(value), margin + 45, yPos);
                    yPos += 6;
                });
                
                yPos += 5;
                
                // CARACTER√çSTICAS
                checkPageBreak(30);
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('CARACTER√çSTICAS DO IM√ìVEL', margin, yPos);
                yPos += 8;
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                
                const caracteristicas = [
                    ['Pavimentos:', inspection.qtdPavimentos || 'N/A'],
                    ['Salas:', inspection.qtdSalas || 'N/A'],
                    ['Quartos:', inspection.qtdQuartos || 'N/A'],
                    ['Su√≠tes:', inspection.qtdSuites || 'N/A'],
                    ['Cozinhas:', inspection.qtdCozinhas || 'N/A'],
                    ['Quintal:', inspection.possuiQuintal || 'N/A'],
                    ['Garagem:', inspection.possuiGaragem || 'N/A']
                ];
                
                caracteristicas.forEach(([label, value]) => {
                    checkPageBreak();
                    doc.setFont(undefined, 'bold');
                    doc.text(label, margin, yPos);
                    doc.setFont(undefined, 'normal');
                    doc.text(String(value), margin + 45, yPos);
                    yPos += 6;
                });
                
                yPos += 10;
                
                // =====================================================
                // SE√á√ÉO 1: FOTOS GERAIS DO IM√ìVEL (VINDO PRIMEIRO!)
                // =====================================================
                const fotosGerais = [];
                if (inspection.photos) {
                    Object.keys(inspection.photos).forEach(key => {
                        if (key.startsWith('fotos_')) {
                            const nomeLimpo = key.replace('fotos_', '').replace(/\d+$/, '').replace(/_/g, ' ');
                            fotosGerais.push({
                                key: key,
                                nome: nomeLimpo.charAt(0).toUpperCase() + nomeLimpo.slice(1),
                                fotos: inspection.photos[key]
                            });
                        }
                    });
                }
                
                if (fotosGerais.length > 0) {
                    checkPageBreak(30);
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(102, 126, 234);
                    doc.text('FOTOS GERAIS DO IM√ìVEL', margin, yPos);
                    doc.setTextColor(0, 0, 0);
                    yPos += 10;
                    
                    for (const fotoGeral of fotosGerais) {
                        if (fotoGeral.fotos && fotoGeral.fotos.length > 0) {
                            checkPageBreak(25);
                            
                            doc.setFontSize(11);
                            doc.setFont(undefined, 'bold');
                            doc.text(fotoGeral.nome.toUpperCase(), margin, yPos);
                            yPos += 6;
                            
                            for (let i = 0; i < fotoGeral.fotos.length; i++) {
                                checkPageBreak(90);
                                
                                try {
                                    const imgWidth = 80;
                                    const imgHeight = 60;
                                    
                                    const imageData = (typeof fotoGeral.fotos[i] === 'object' && fotoGeral.fotos[i].data) ? 
                                        fotoGeral.fotos[i].data : fotoGeral.fotos[i];
                                    
                                    doc.addImage(imageData, 'JPEG', margin + 10, yPos, imgWidth, imgHeight);
                                    
                                    doc.setFontSize(9);
                                    doc.setFont(undefined, 'italic');
                                    doc.setTextColor(100, 100, 100);
                                    doc.text(`Foto ${i + 1}`, margin + 10, yPos + imgHeight + 4);
                                    doc.setTextColor(0, 0, 0);
                                    doc.setFontSize(10);
                                    doc.setFont(undefined, 'normal');
                                    
                                    yPos += imgHeight + 10;
                                } catch (error) {
                                    console.error('‚ùå Erro ao adicionar foto geral ao PDF:', error);
                                    doc.setFontSize(9);
                                    doc.setTextColor(200, 0, 0);
                                    doc.text(`[Erro ao carregar foto ${i + 1}]`, margin + 10, yPos);
                                    doc.setTextColor(0, 0, 0);
                                    doc.setFontSize(10);
                                    yPos += 6;
                                }
                            }
                            
                            yPos += 5;
                        }
                    }
                    
                    yPos += 10;
                }
                
                // =====================================================
                // SE√á√ÉO 2: PROBLEMAS ENCONTRADOS (VINDO DEPOIS!)
                // =====================================================
                
                // PROBLEMAS ENCONTRADOS
                const problemasEncontrados = [];
                
                if (inspection.checklist) {
                    Object.keys(inspection.checklist).forEach(itemId => {
                        const item = inspection.checklist[itemId];
                        
                        // FILTRAR: Ignorar IDs inv√°lidos (alertas, sistema, etc)
                        if (item.status === 'issue' && isValidInspectionItem(itemId)) {
                            const categoryName = getCategoryNameFromId(itemId);
                            const itemName = getItemNameFromId(itemId);
                            
                            if (item.occurrences && item.occurrences.length > 0) {
                                item.occurrences.forEach((occ, index) => {
                                    const occNum = occ.occurrenceNum || (index + 1);
                                    problemasEncontrados.push({
                                        categoria: categoryName,
                                        item: itemName,
                                        ocorrencia: occNum,
                                        observacao: occ.observation || 'Sem observa√ß√£o',
                                        photoKey: `${itemId}_${occNum}`
                                    });
                                });
                            } else if (item.observation) {
                                problemasEncontrados.push({
                                    categoria: categoryName,
                                    item: itemName,
                                    ocorrencia: 1,
                                    observacao: item.observation,
                                    photoKey: `${itemId}_1`
                                });
                            } else {
                                problemasEncontrados.push({
                                    categoria: categoryName,
                                    item: itemName,
                                    ocorrencia: 1,
                                    observacao: 'Problema identificado',
                                    photoKey: `${itemId}_1`
                                });
                            }
                        }
                    });
                }
                
                if (problemasEncontrados.length > 0) {
                    checkPageBreak(30);
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(220, 53, 69);
                    doc.text('PROBLEMAS ENCONTRADOS', margin, yPos);
                    doc.setTextColor(0, 0, 0);
                    yPos += 10;
                    
                    doc.setFontSize(10);
                    
                    for (let i = 0; i < problemasEncontrados.length; i++) {
                        const problema = problemasEncontrados[i];
                        
                        checkPageBreak(30);
                        
                        // N√∫mero do problema
                        doc.setFont(undefined, 'bold');
                        doc.setFontSize(11);
                        doc.text(`${i + 1}. ${problema.categoria} - ${problema.item}`, margin, yPos);
                        yPos += 6;
                        
                        // Ocorr√™ncia (se houver m√∫ltiplas)
                        if (problemasEncontrados.filter(p => p.item === problema.item).length > 1) {
                            doc.setFont(undefined, 'italic');
                            doc.setFontSize(9);
                            doc.setTextColor(100, 100, 100);
                            doc.text(`(Ocorr√™ncia ${problema.ocorrencia})`, margin + 5, yPos);
                            doc.setTextColor(0, 0, 0);
                            yPos += 5;
                        }
                        
                        // Observa√ß√£o
                        doc.setFont(undefined, 'normal');
                        doc.setFontSize(10);
                        const obsText = `Observa√ß√£o: ${problema.observacao}`;
                        const obsLines = doc.splitTextToSize(obsText, maxWidth - 10);
                        obsLines.forEach(line => {
                            checkPageBreak();
                            doc.text(line, margin + 5, yPos);
                            yPos += 5;
                        });
                        
                        yPos += 3;
                        
                        // Adicionar fotos se existirem
                        if (inspection.photos && inspection.photos[problema.photoKey]) {
                            const fotos = inspection.photos[problema.photoKey];
                            
                            for (let j = 0; j < fotos.length; j++) {
                                checkPageBreak(90);
                                
                                try {
                                    const imgWidth = 80;
                                    const imgHeight = 60;
                                    
                                    // CORRE√á√ÉO: Usar foto.data se for objeto, ou foto diretamente se for string
                                    const imageData = (typeof fotos[j] === 'object' && fotos[j].data) ? fotos[j].data : fotos[j];
                                    
                                    doc.addImage(imageData, 'JPEG', margin + 10, yPos, imgWidth, imgHeight);
                                    
                                    doc.setFontSize(9);
                                    doc.setFont(undefined, 'italic');
                                    doc.setTextColor(100, 100, 100);
                                    doc.text(`Foto ${j + 1} - ${problema.observacao}`, margin + 10, yPos + imgHeight + 4);
                                    doc.setTextColor(0, 0, 0);
                                    doc.setFontSize(10);
                                    doc.setFont(undefined, 'normal');
                                    
                                    yPos += imgHeight + 10;
                                } catch (error) {
                                    console.error('‚ùå Erro ao adicionar foto ao PDF:', error);
                                    console.error('üì∑ Dados da foto:', fotos[j]);
                                    console.error('üìã Tipo:', typeof fotos[j]);
                                    doc.setFontSize(9);
                                    doc.setTextColor(200, 0, 0);
                                    doc.text(`[Erro ao carregar foto ${j + 1}]`, margin + 10, yPos);
                                    doc.setTextColor(0, 0, 0);
                                    doc.setFontSize(10);
                                    yPos += 6;
                                }
                            }
                        } else {
                            doc.setFontSize(9);
                            doc.setTextColor(150, 150, 150);
                            doc.text('(Sem fotos anexadas)', margin + 10, yPos);
                            doc.setTextColor(0, 0, 0);
                            doc.setFontSize(10);
                            yPos += 6;
                        }
                        
                        yPos += 8;
                    }
                } else {
                    checkPageBreak(20);
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text('PROBLEMAS ENCONTRADOS', margin, yPos);
                    yPos += 10;
                    
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(0, 150, 0);
                    doc.text('‚úì Nenhum problema identificado na inspe√ß√£o.', margin, yPos);
                    doc.setTextColor(0, 0, 0);
                    yPos += 10;
                }
                
                // Rodap√© em todas as p√°ginas
                const totalPages = doc.internal.pages.length - 1;
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(150, 150, 150);
                    doc.text(`P√°gina ${i} de ${totalPages}`, pageWidth - margin - 20, pageHeight - 10);
                    doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, margin, pageHeight - 10);
                }
                
                // Salvar PDF
                const nomeArquivo = `Relatorio_${inspection.type}_${inspection.municipio.replace(/\s+/g, '_')}_${inspection.dataVistoria.replace(/\//g, '-')}.pdf`;
                doc.save(nomeArquivo);
                
                hideProgress();
                playSound('success');
                alert('‚úÖ Relat√≥rio PDF gerado com sucesso!\n\nüìÑ O arquivo foi baixado automaticamente.');
                
            } catch (error) {
                hideProgress();
                console.error('Erro ao gerar PDF:', error);
                alert('‚ùå Erro ao gerar PDF. Verifique o console para mais detalhes.\n\nErro: ' + error.message);
            }
        }
        
        // Fun√ß√µes auxiliares para o PDF
        function getCategoryNameFromId(itemId) {
            const categoryMap = {
                'paredes': 'Paredes',
                'teto': 'Teto/Forro',
                'piso': 'Piso/Revestimento',
                'portas': 'Portas e Janelas',
                'eletrica': 'Sistema El√©trico',
                'hidraulica': 'Sistema Hidr√°ulico',
                'banheiro': 'Banheiros',
                'cozinha': 'Cozinha',
                'telhado': 'Telhado/Cobertura',
                'estrutura': 'Estrutura Geral',
                'fotos': 'Fotos Gerais'
            };
            
            for (const [key, value] of Object.entries(categoryMap)) {
                if (itemId.startsWith(key)) {
                    return value;
                }
            }
            
            return 'Outros';
        }
        
        // Fun√ß√£o auxiliar para verificar se um itemId √© v√°lido (n√£o √© um ID de sistema/alerta)
        function isValidInspectionItem(itemId) {
            // Validar se o itemId existe e √© uma string v√°lida
            if (!itemId || typeof itemId !== 'string' || itemId.trim() === '') {
                return false;
            }
            
            // LISTA DE IDs QUE N√ÉO S√ÉO PROBLEMAS DE INSPE√á√ÉO
            const invalidIds = [
                'alert', 'system', 'notification', 'undefined', 'null',
                // Configura√ß√µes do sistema:
                'alertdriveDisconnected', 'confirmbeforeexit', 'soundeffects',
                'driveonly', 'compactmode', 'hidetooltips', 'simplemode',
                'theme', 'fontsize', 'primarycolor', 'photoquality'
            ];
            
            const itemLower = itemId.toLowerCase();
            
            // Retornar falso se for exatamente igual ou come√ßar com algum ID inv√°lido
            for (const invalidId of invalidIds) {
                if (itemLower === invalidId || itemLower.startsWith(invalidId)) {
                    return false;
                }
            }
            
            // Ignorar se o ID for literalmente 'outros' sem mais informa√ß√µes
            if (itemLower === 'outros') {
                return false;
            }
            
            // ACEITAR TODOS OS OUTROS ITENS - n√£o restringir por categoria!
            // Isso garante que NENHUM problema real seja perdido
            return true;
        }
        
        function getItemNameFromId(itemId) {
            // Remove o prefixo da categoria
            const parts = itemId.split('_');
            if (parts.length > 1) {
                let nome = parts.slice(1).join(' ');
                // Adiciona espa√ßos antes de letras mai√∫sculas
                nome = nome.replace(/([A-Z])/g, ' $1').trim();
                // Capitaliza primeira letra
                nome = nome.charAt(0).toUpperCase() + nome.slice(1);
                return nome;
            }
            return itemId;
        }

        // Save inspection
        async function saveInspection() {
            if (!validateForm()) {
                alert('Por favor, preencha todos os campos obrigat√≥rios.');
                return;
            }

            const inspection = collectFormData();
            
            // ====================================================
            // SOLU√á√ÉO PARA MEM√ìRIA CHEIA:
            // Separar dados e fotos para evitar estourar localStorage
            // ====================================================
            
            // 1. Criar c√≥pia SEM fotos para localStorage (apenas metadados)
            const inspectionForLocalStorage = {
                ...inspection,
                photos: {}, // N√£o salvar fotos no localStorage - mem√≥ria limitada!
                hasPhotos: Object.keys(inspection.photos).length > 0 // Flag para indicar que existem fotos
            };
            
            // 2. Guardar fotos temporariamente em mem√≥ria
            const photosToSave = inspection.photos;
            
            // 3. Add to inspections array (SEM fotos no localStorage)
            inspections.push(inspectionForLocalStorage);
            
            // 4. Salvar no localStorage (SEM fotos - evita erro de mem√≥ria cheia)
            const saveSuccess = saveInspections();
            
            if (!saveSuccess) {
                // Se falhou ao salvar, n√£o continuar
                inspections.pop(); // Remover do array
                return;
            }
            
            console.log('üíæ Inspe√ß√£o salva localmente (sem fotos - economizando mem√≥ria)');
            
            // 5. Restaurar fotos no objeto para enviar ao Drive
            inspection.photos = photosToSave;
            
            // 6. Atualizar o objeto no array com as fotos (apenas na mem√≥ria, n√£o no localStorage)
            inspections[inspections.length - 1].photos = photosToSave;

            // SEMPRE tentar salvar no Google Drive (COM fotos)
            if (accessToken) {
                // J√° tem token, tenta salvar direto
                try {
                    showProgress('Enviando para Google Drive...');
                    await saveToGoogleDrive(inspection);
                    hideProgress();
                    console.log('‚òÅÔ∏è Inspe√ß√£o sincronizada com sucesso no Google Drive!');
                    alert('‚úÖ Inspe√ß√£o salva e sincronizada com sucesso!\n\nüíæ Metadados: localStorage\nüì∏ Fotos: Google Drive\n\n‚ú® Estrat√©gia otimizada para economizar mem√≥ria local!');
                    backToMenu();
                } catch (error) {
                    hideProgress();
                    console.error('‚ùå Erro ao sincronizar com Drive:', error);
                    alert('‚úÖ Inspe√ß√£o salva localmente!\n‚ö†Ô∏è Erro ao enviar fotos para o Google Drive.\n\nüì∏ As fotos ser√£o enviadas na pr√≥xima sincroniza√ß√£o.');
                    backToMenu();
                }
            } else {
                // Sem token, tenta obter autoriza√ß√£o
                console.log('üîê Sem token do Google Drive. Tentando obter autoriza√ß√£o...');
                
                if (tokenClient && gapiInited && gisInited) {
                    showProgress('Solicitando autoriza√ß√£o do Google Drive...');
                    
                    // Tentar obter token
                    try {
                        tokenClient.requestAccessToken({ 
                            prompt: '', // Tenta sem prompt primeiro
                            callback: async (response) => {
                                if (response.error) {
                                    hideProgress();
                                    console.warn('‚ö†Ô∏è N√£o foi poss√≠vel conectar ao Drive automaticamente');
                                    alert('‚úÖ Inspe√ß√£o salva localmente!\n\n‚ö†Ô∏è Configure o Google Drive para enviar as fotos.\n\nAcesse: Configura√ß√µes ‚Üí Google Drive');
                                    backToMenu();
                                    return;
                                }
                                
                                accessToken = response.access_token;
                                
                                // Agora tenta salvar no Drive
                                try {
                                    showProgress('Enviando para Google Drive...');
                                    await saveToGoogleDrive(inspection);
                                    hideProgress();
                                    console.log('‚òÅÔ∏è Inspe√ß√£o sincronizada com sucesso!');
                                    alert('‚úÖ Inspe√ß√£o salva e sincronizada com sucesso!\n\nüíæ Metadados: localStorage\nüì∏ Fotos: Google Drive');
                                    backToMenu();
                                } catch (error) {
                                    hideProgress();
                                    console.error('‚ùå Erro ao sincronizar:', error);
                                    alert('‚úÖ Inspe√ß√£o salva localmente!\n‚ö†Ô∏è Erro ao enviar fotos para o Google Drive.');
                                    backToMenu();
                                }
                            }
                        });
                    } catch (error) {
                        hideProgress();
                        console.error('‚ùå Erro ao solicitar autoriza√ß√£o:', error);
                        alert('‚úÖ Inspe√ß√£o salva localmente!\n\n‚ö†Ô∏è Configure o Google Drive para enviar as fotos.');
                        backToMenu();
                    }
                } else {
                    // APIs n√£o inicializadas
                    console.warn('‚ö†Ô∏è APIs do Google n√£o dispon√≠veis');
                    alert('‚úÖ Inspe√ß√£o salva localmente!\n\n‚ö†Ô∏è Google Drive n√£o est√° dispon√≠vel no momento.');
                    backToMenu();
                }
            }
        }

        // Validate form
        function validateForm() {
            const requiredFields = ['endereco', 'numero', 'bairro', 'municipio', 'uf', 'dataVistoria', 'horaVistoria', 'acompanhante'];
            
            for (const field of requiredFields) {
                const element = document.getElementById(field);
                if (!element || !element.value.trim()) {
                    return false;
                }
            }
            
            // Validar APENAS foto da fachada (√∫nica obrigat√≥ria)
            if (!photoData['fotos_fachada_1'] || photoData['fotos_fachada_1'].length === 0) {
                alert('‚ö†Ô∏è A foto da FACHADA √© obrigat√≥ria!\n\nPor favor, tire pelo menos uma foto da fachada do im√≥vel.');
                return false;
            }
            
            return true;
        }

        // Collect form data
        function collectFormData() {
            // Gerar ID √öNICO incluindo endere√ßo + n√∫mero + complemento + timestamp
            const endereco = document.getElementById('endereco').value;
            const numero = document.getElementById('numero').value;
            const complemento = document.getElementById('complemento').value;
            const uniqueString = `${endereco}_${numero}_${complemento}_${Date.now()}`;
            const uniqueId = btoa(uniqueString).replace(/[^a-zA-Z0-9]/g, '').substring(0, 32);
            
            const inspection = {
                id: uniqueId,
                type: currentInspectionType,
                baseInspectionId: selectedInitialInspection?.id || null,
                timestamp: new Date().toISOString(),
                endereco: document.getElementById('endereco').value,
                numero: document.getElementById('numero').value,
                complemento: document.getElementById('complemento').value,
                bairro: document.getElementById('bairro').value,
                municipio: document.getElementById('municipio').value,
                uf: document.getElementById('uf').value,
                dataVistoria: document.getElementById('dataVistoria').value,
                horaVistoria: document.getElementById('horaVistoria').value,
                acompanhante: document.getElementById('acompanhante').value,
                telefoneAcompanhante: document.getElementById('telefoneAcompanhante')?.value || '',
                idadeImovel: document.getElementById('idadeImovel').value,
                areaTotal: document.getElementById('areaTotal')?.value || '',
                qtdPavimentos: document.getElementById('qtdPavimentos').value,
                qtdSalas: document.getElementById('qtdSalas').value,
                qtdQuartos: document.getElementById('qtdQuartos').value,
                qtdSuites: document.getElementById('qtdSuites').value,
                qtdCozinhas: document.getElementById('qtdCozinhas').value,
                possuiQuintal: document.getElementById('possuiQuintal').value,
                possuiGaragem: document.getElementById('possuiGaragem').value,
                checklist: collectChecklistData(),
                photos: photoData
            };

            // Add complete inspection fields if applicable
            if (currentInspectionType === 'completa') {
                inspection.obsCompleta = document.getElementById('obsCompleta')?.value || '';
                inspection.estadoEstrutura = document.getElementById('estadoEstrutura')?.value || '';
                inspection.estadoEletrica = document.getElementById('estadoEletrica')?.value || '';
                inspection.estadoHidraulica = document.getElementById('estadoHidraulica')?.value || '';
                inspection.necessitaReforma = document.getElementById('necessitaReforma')?.value || '';
                inspection.custoReparos = document.getElementById('custoReparos')?.value || '';
                inspection.prazoReparos = document.getElementById('prazoReparos')?.value || '';
                inspection.recomendacoes = document.getElementById('recomendacoes')?.value || '';
                inspection.conclusao = document.getElementById('conclusao')?.value || '';
            }

            return inspection;
        }

        // Collect checklist data
        function collectChecklistData() {
            const checklist = {};
            
            // LISTA DE IDs QUE N√ÉO S√ÉO PROBLEMAS DE INSPE√á√ÉO (configura√ß√µes do sistema)
            const systemConfigIds = [
                'alertDriveDisconnected',
                'confirmBeforeExit', 
                'soundEffects',
                'driveOnly',
                'compactMode',
                'hideTooltips',
                'simpleMode',
                'theme',
                'fontSize',
                'primaryColor',
                'photoQuality'
            ];
            
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                const itemId = checkbox.id;
                
                // FILTRAR configura√ß√µes do sistema - N√ÉO s√£o problemas de inspe√ß√£o!
                if (systemConfigIds.includes(itemId)) {
                    console.log(`‚è≠Ô∏è Ignorando configura√ß√£o do sistema: ${itemId}`);
                    return; // Pular este item
                }
                
                // FILTRAR IDs vazios ou inv√°lidos
                if (!itemId || itemId.trim() === '') {
                    console.log('‚è≠Ô∏è Ignorando checkbox sem ID');
                    return;
                }
                
                // Coletar m√∫ltiplas ocorr√™ncias
                const occurrences = [];
                let occurrenceNum = 1;
                let textArea = document.getElementById(`${itemId}_text_${occurrenceNum}`);
                
                // Se n√£o existe _text_1, tenta sem n√∫mero (compatibilidade com FOTOS GERAIS)
                if (!textArea) {
                    textArea = document.getElementById(`${itemId}_text`);
                    if (textArea) {
                        occurrences.push({
                            observation: textArea.value,
                            occurrenceNum: 1
                        });
                    }
                } else {
                    // Coletar todas as ocorr√™ncias numeradas
                    while (textArea) {
                        occurrences.push({
                            observation: textArea.value,
                            occurrenceNum: occurrenceNum
                        });
                        occurrenceNum++;
                        textArea = document.getElementById(`${itemId}_text_${occurrenceNum}`);
                    }
                }
                
                checklist[itemId] = {
                    status: checkbox.checked ? 'issue' : 'ok',
                    observation: occurrences.length > 0 ? occurrences[0].observation : '', // Compatibilidade
                    occurrences: occurrences // Novo campo com todas as ocorr√™ncias
                };
            });
            
            console.log('üìã Checklist coletado (SEM configura√ß√µes do sistema):', Object.keys(checklist));
            
            return checklist;
        }

        // Save to Google Drive
        async function saveToGoogleDrive(inspection) {
            if (!accessToken) {
                throw new Error('N√£o conectado ao Google Drive');
            }

            // SEMPRE usar pasta compartilhada - TODOS os usu√°rios usam a MESMA pasta
            if (!SHARED_FOLDER_ID) {
                throw new Error('Pasta compartilhada n√£o configurada. Configure em Configura√ß√µes ‚Üí Google Drive ‚Üí Pasta Centralizada.');
            }
            
            // Garantir acesso √† pasta compartilhada (SEM FALLBACK - n√£o criar pastas pessoais)
            await ensureSharedFolderAccess();
            
            const rootFolderId = SHARED_FOLDER_ID;
            console.log('üìÅ Usando pasta compartilhada (TODOS usam esta):', rootFolderId);

            // Create folder structure: tipo_inspecao/data/endereco
            const typeFolderName = inspection.type === 'inicial' ? 'inspecao_inicial' : 'inspecao_completa';
            const typeFolderId = await findOrCreateFolder(typeFolderName, rootFolderId);

            const dateFolder = formatDate(inspection.dataVistoria).replace(/\//g, '-');
            const dateFolderId = await findOrCreateFolder(dateFolder, typeFolderId);

            const addressFolder = `${inspection.endereco}_${inspection.numero}`.replace(/[^a-zA-Z0-9]/g, '_');
            const addressFolderId = await findOrCreateFolder(addressFolder, dateFolderId);

            // Save JSON e obter o fileId
            const jsonContent = JSON.stringify(inspection, null, 2);
            const jsonFileResult = await uploadFile(jsonContent, 'inspecao.json', addressFolderId, 'application/json');
            const jsonFileId = jsonFileResult.id;

            // Save report
            const reportContent = createInspectionReport(inspection);
            await uploadFile(reportContent, 'relatorio.txt', addressFolderId, 'text/plain');

            // Save photos if any
            if (Object.keys(photoData).length > 0) {
                await savePhotos(inspection, addressFolderId);
            }

            // IMPORTANTE: Atualizar o objeto da inspe√ß√£o com os IDs do Drive
            inspection.driveFolderId = addressFolderId;
            inspection.driveFileId = jsonFileId;

            // Atualizar no array de inspe√ß√µes
            const index = inspections.findIndex(i => i.id === inspection.id);
            if (index > -1) {
                inspections[index] = inspection;
                // Salvar no localStorage com os IDs atualizados
                safeLocalStorageSet('inspections', safeJSONStringify(inspections));
                console.log('‚úÖ Inspe√ß√£o atualizada com IDs do Drive:', inspection.id);
            }
        }

        // Find or create folder
        async function findOrCreateFolder(folderName, parentId) {
            try {
                // Search for existing folder
                let query = `mimeType='application/vnd.google-apps.folder' and name='${folderName}' and trashed=false`;
                if (parentId) {
                    query += ` and '${parentId}' in parents`;
                }

                const response = await gapi.client.drive.files.list({
                    q: query,
                    fields: 'files(id, name)',
                    spaces: 'drive'
                });

                if (response.result.files && response.result.files.length > 0) {
                    return response.result.files[0].id;
                }

                // Create new folder
                const fileMetadata = {
                    name: folderName,
                    mimeType: 'application/vnd.google-apps.folder'
                };

                if (parentId) {
                    fileMetadata.parents = [parentId];
                }

                const folder = await gapi.client.drive.files.create({
                    resource: fileMetadata,
                    fields: 'id'
                });

                return folder.result.id;
            } catch (error) {
                console.error('Error creating folder:', error);
                throw error;
            }
        }

        // Upload file
        async function uploadFile(content, fileName, folderId, mimeType) {
            const metadata = {
                name: fileName,
                parents: [folderId]
            };

            // Se content j√° for um Blob, usar diretamente; caso contr√°rio, criar um Blob
            const file = content instanceof Blob ? content : new Blob([content], { type: mimeType });
            const formData = new FormData();
            formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            formData.append('file', file);

            const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                },
                body: formData
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ error: { message: 'Erro desconhecido' } }));
                throw new Error(`Erro ao fazer upload: ${errorData.error?.message || response.statusText}`);
            }

            const result = await response.json();
            if (!result.id) {
                throw new Error('Upload realizado mas ID do arquivo n√£o retornado');
            }

            return result;
        }

        // Save photos
        async function savePhotos(inspection, parentFolderId) {
            if (!photoData || Object.keys(photoData).length === 0) {
                console.log('‚ÑπÔ∏è Nenhuma foto para salvar');
                return;
            }

            const photosFolderId = await findOrCreateFolder('fotos', parentFolderId);

            for (const [itemId, photos] of Object.entries(photoData)) {
                if (photos && photos.length > 0) {
                    const itemFolderId = await findOrCreateFolder(itemId, photosFolderId);

                    for (let i = 0; i < photos.length; i++) {
                        const photo = photos[i];
                        if (!photo || !photo.data) {
                            console.warn(`‚ö†Ô∏è Foto ${i + 1} do item ${itemId} est√° vazia, pulando...`);
                            continue;
                        }

                        try {
                            const response = await fetch(photo.data);
                            if (!response.ok) {
                                throw new Error(`Erro ao buscar foto: ${response.statusText}`);
                            }
                            const blob = await response.blob();
                            const fileName = `foto_${i + 1}.jpg`;

                            const metadata = {
                                name: fileName,
                                parents: [itemFolderId]
                            };

                            const formData = new FormData();
                            formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                            formData.append('file', blob);

                            const uploadResponse = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${accessToken}`
                                },
                                body: formData
                            });

                            if (!uploadResponse.ok) {
                                const errorData = await uploadResponse.json().catch(() => ({ error: { message: 'Erro desconhecido' } }));
                                throw new Error(`Erro ao fazer upload da foto: ${errorData.error?.message || uploadResponse.statusText}`);
                            }

                            console.log(`‚úÖ Foto ${i + 1} do item ${itemId} salva com sucesso`);
                        } catch (error) {
                            console.error(`‚ùå Erro ao salvar foto ${i + 1} do item ${itemId}:`, error);
                            // Continuar com as outras fotos mesmo se uma falhar
                        }
                    }
                }
            }
        }

        // Create inspection report
        function createInspectionReport(inspection) {
            const typeBadge = inspection.type === 'inicial' ? 'INICIAL' : 'COMPLETA';
            
            let report = `
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         RELAT√ìRIO DE INSPE√á√ÉO RESIDENCIAL
              TIPO: ${typeBadge}
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

DATA E RESPONS√ÅVEL
----------------------------------------------------------
Data da Vistoria: ${formatDate(inspection.dataVistoria)} √†s ${inspection.horaVistoria}
Inspetor: ${inspection.acompanhante}

DADOS DO IM√ìVEL
----------------------------------------------------------
Endere√ßo: ${inspection.endereco}, ${inspection.numero}
${inspection.complemento ? `Complemento: ${inspection.complemento}\n` : ''}Bairro: ${inspection.bairro}
Munic√≠pio: ${inspection.municipio}/${inspection.uf}

CARACTER√çSTICAS
----------------------------------------------------------
Idade do Im√≥vel: ${inspection.idadeImovel || 'N/I'} anos
Pavimentos: ${inspection.qtdPavimentos || 'N/I'}
Salas: ${inspection.qtdSalas || 'N/I'}
Quartos: ${inspection.qtdQuartos || 'N/I'}
Su√≠tes: ${inspection.qtdSuites || 'N/I'}
Cozinhas: ${inspection.qtdCozinhas || 'N/I'}
Quintal: ${inspection.possuiQuintal === 'sim' ? 'Sim' : 'N√£o'}
Garagem: ${inspection.possuiGaragem === 'sim' ? 'Sim' : 'N√£o'}

PROBLEMAS IDENTIFICADOS
----------------------------------------------------------
`;

            let problemCount = 0;
            Object.entries(inspection.checklist).forEach(([key, value]) => {
                if (value.status === 'issue' && value.observation) {
                    problemCount++;
                    const label = key.split('_').slice(1).join(' ').toUpperCase();
                    report += `\n${problemCount}. ${label}\n`;
                    report += `   ${value.observation}\n`;
                }
            });

            if (problemCount === 0) {
                report += '\nNenhum problema foi identificado durante a inspe√ß√£o.\n';
            }

            // Add complete inspection details
            if (inspection.type === 'completa') {
                report += `
\nAVALIA√á√ïES DETALHADAS (INSPE√á√ÉO COMPLETA)
----------------------------------------------------------
Estado Estrutura: ${inspection.estadoEstrutura || 'N/I'}
Estado Instala√ß√µes El√©tricas: ${inspection.estadoEletrica || 'N/I'}
Estado Instala√ß√µes Hidr√°ulicas: ${inspection.estadoHidraulica || 'N/I'}
Necessita Reforma: ${inspection.necessitaReforma || 'N/I'}
Custo Estimado Reparos: R$ ${inspection.custoReparos || '0,00'}
Prazo Estimado: ${inspection.prazoReparos || '0'} dias

RECOMENDA√á√ïES T√âCNICAS:
${inspection.recomendacoes || 'Nenhuma recomenda√ß√£o espec√≠fica.'}

CONCLUS√ÉO:
${inspection.conclusao || 'Sem conclus√£o adicional.'}
`;
            }

            report += `
\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Total de problemas encontrados: ${problemCount}
Relat√≥rio gerado em: ${new Date().toLocaleString('pt-BR')}
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
`;

            return report;
        }

        // Show progress overlay
        function showProgress(message) {
            const overlay = document.createElement('div');
            overlay.id = 'progressOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
            `;
            overlay.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 10px; text-align: center;">
                    <h3>${message}</h3>
                    <div style="margin: 20px 0;">
                        <div style="width: 200px; height: 4px; background: #e0e0e0; border-radius: 2px; overflow: hidden;">
                            <div style="width: 30%; height: 100%; background: #667eea; animation: progress 2s infinite;"></div>
                        </div>
                    </div>
                </div>
                <style>
                    @keyframes progress {
                        0% { width: 30%; }
                        50% { width: 70%; }
                        100% { width: 30%; }
                    }
                </style>
            `;
            document.body.appendChild(overlay);
        }

        function hideProgress() {
            const overlay = document.getElementById('progressOverlay');
            if (overlay) {
                overlay.remove();
            }
        }

        // Back to menu
        function backToMenu() {
            // Limpar formul√°rio
            document.getElementById('inspectionForm').innerHTML = '';
            
            // Ocultar todas as telas
            hideAllScreens();
            
            // Mostrar menu principal
            document.getElementById('mainMenu').classList.add('active');
            
            // Limpar dados tempor√°rios
            currentInspection = null;
            currentInspectionType = null;
            selectedInitialInspection = null;
            photoData = {};
            occurrenceCounters = {};
        }

        // Show inspections list (placeholder)
        async function showInspectionsList() {
            // Ocultar todas as telas
            hideAllScreens();
            
            // Mostrar tela de banco de dados
            const dbScreen = document.getElementById('inspectionsDatabase');
            dbScreen.style.display = 'block';
            
            // Carregar dados do Drive
            await loadInspections();
            loadDatabaseView();
        }

        function closeDatabaseView() {
            hideAllScreens();
            document.getElementById('mainMenu').classList.add('active');
        }

        function loadDatabaseView() {
            // Atualizar estat√≠sticas
            const totalInspections = inspections.length;
            const totalInicial = inspections.filter(i => i.type === 'inicial').length;
            const totalCompleta = inspections.filter(i => i.type === 'completa').length;
            
            document.getElementById('dbTotalInspections').textContent = totalInspections;
            document.getElementById('dbTotalInicial').textContent = totalInicial;
            document.getElementById('dbTotalCompleta').textContent = totalCompleta;
            
            // Preencher dropdown de cidades
            const cities = new Set();
            inspections.forEach(i => {
                if (i.municipio) cities.add(i.municipio);
            });
            
            const cityFilter = document.getElementById('filterCity');
            cityFilter.innerHTML = '<option value="all">Todos</option>';
            Array.from(cities).sort().forEach(city => {
                cityFilter.innerHTML += `<option value="${city}">${city}</option>`;
            });
            
            // Renderizar lista
            renderInspectionsList(inspections);
        }

        function renderInspectionsList(filteredInspections) {
            const container = document.getElementById('inspectionsListContainer');
            
            if (filteredInspections.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #999;">
                        <div style="font-size: 48px; margin-bottom: 10px;">üì≠</div>
                        <p>Nenhuma inspe√ß√£o encontrada</p>
                    </div>
                `;
                return;
            }
            
            // Ordenar por data (mais recentes primeiro)
            const sorted = [...filteredInspections].sort((a, b) => {
                return new Date(b.timestamp) - new Date(a.timestamp);
            });
            
            let html = '';
            sorted.forEach(inspection => {
                const typeBadge = inspection.type === 'inicial' ? 
                    '<span class="inspection-type-badge badge-inicial">INICIAL</span>' :
                    '<span class="inspection-type-badge badge-completa">COMPLETA</span>';
                
                const problems = countProblems(inspection);
                const photos = countPhotos(inspection);
                
                html += `
                    <div class="inspection-card" style="border: 1px solid #e0e0e0; border-radius: 10px; padding: 15px; margin-bottom: 15px; background: white; transition: all 0.3s;" 
                         onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'"
                         onmouseout="this.style.boxShadow='none'">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div onclick="showInspectionDetails('${inspection.id}')" style="cursor: pointer; flex: 1;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                                    <h4 style="margin: 0; color: #333;">${inspection.endereco}, ${inspection.numero}</h4>
                                    ${typeBadge}
                                </div>
                                <p style="margin: 5px 0; color: #666; font-size: 14px;">
                                    üìç ${inspection.bairro}, ${inspection.municipio}/${inspection.uf}
                                </p>
                            </div>
                            <div style="text-align: right; display: flex; flex-direction: column; gap: 10px; align-items: flex-end;">
                                <div style="font-size: 13px; color: #999;">
                                    üìÖ ${formatDate(inspection.dataVistoria)}<br>
                                    üïê ${inspection.horaVistoria}
                                </div>
                                <button onclick="confirmDeleteInspection('${inspection.id}'); event.stopPropagation();" 
                                        class="btn btn-secondary" 
                                        style="font-size: 11px; padding: 6px 12px; background: #dc3545; color: white; border: none;">
                                    üóëÔ∏è Deletar
                                </button>
                            </div>
                        </div>
                        <div style="display: flex; gap: 20px; padding-top: 10px; border-top: 1px solid #f0f0f0; font-size: 13px;" onclick="showInspectionDetails('${inspection.id}')" style="cursor: pointer;">
                            <div style="color: ${problems > 0 ? '#f44336' : '#4caf50'};">
                                ‚ö†Ô∏è ${problems} problema${problems !== 1 ? 's' : ''}
                            </div>
                            <div style="color: #2196f3;">
                                üì∏ ${photos} foto${photos !== 1 ? 's' : ''}
                            </div>
                            <div style="color: #666;">
                                üë§ ${inspection.acompanhante}
                            </div>
                        </div>
                        <div style="display: flex; gap: 15px; padding-top: 8px; font-size: 12px; color: #888; flex-wrap: wrap;">
                            ${inspection.idadeImovel ? `<span>üè† ${inspection.idadeImovel} anos</span>` : ''}
                            ${inspection.qtdQuartos ? `<span>üõèÔ∏è ${inspection.qtdQuartos} quarto${inspection.qtdQuartos !== '1' ? 's' : ''}</span>` : ''}
                            ${inspection.areaTotal ? `<span>üìê ${inspection.areaTotal} m¬≤</span>` : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function countProblems(inspection) {
            let count = 0;
            if (inspection.checklist) {
                Object.values(inspection.checklist).forEach(item => {
                    if (item.status === 'issue' && isValidInspectionItem(itemId)) count++;
                });
            }
            return count;
        }

        function countPhotos(inspection) {
            let count = 0;
            if (inspection.photos) {
                Object.values(inspection.photos).forEach(photoArray => {
                    if (Array.isArray(photoArray)) {
                        count += photoArray.length;
                    }
                });
            }
            return count;
        }

        function applyFilters() {
            const typeFilter = document.getElementById('filterType').value;
            const cityFilter = document.getElementById('filterCity').value;
            const addressFilter = document.getElementById('filterAddress').value.toLowerCase();
            const quartosFilter = document.getElementById('filterQuartos').value;
            const areaMinFilter = document.getElementById('filterAreaMin').value;
            const areaMaxFilter = document.getElementById('filterAreaMax').value;
            const pavimentosFilter = document.getElementById('filterPavimentos').value;
            const suitesFilter = document.getElementById('filterSuites').value;
            const garagemFilter = document.getElementById('filterGaragem').value;
            const quintalFilter = document.getElementById('filterQuintal').value;
            
            let filtered = inspections;
            
            // Filtro por tipo
            if (typeFilter !== 'all') {
                filtered = filtered.filter(i => i.type === typeFilter);
            }
            
            // Filtro por cidade
            if (cityFilter !== 'all') {
                filtered = filtered.filter(i => i.municipio === cityFilter);
            }
            
            // Filtro por endere√ßo
            if (addressFilter) {
                filtered = filtered.filter(i => 
                    i.endereco.toLowerCase().includes(addressFilter) ||
                    i.bairro.toLowerCase().includes(addressFilter)
                );
            }
            
            // Filtro por quartos (m√≠nimo)
            if (quartosFilter) {
                const minQuartos = parseInt(quartosFilter);
                filtered = filtered.filter(i => {
                    const quartos = parseInt(i.qtdQuartos) || 0;
                    return quartos >= minQuartos;
                });
            }
            
            // Filtro por √°rea total (m√≠nimo e m√°ximo)
            if (areaMinFilter) {
                const minArea = parseFloat(areaMinFilter);
                filtered = filtered.filter(i => {
                    const area = parseFloat(i.areaTotal) || 0;
                    return area >= minArea;
                });
            }
            if (areaMaxFilter) {
                const maxArea = parseFloat(areaMaxFilter);
                filtered = filtered.filter(i => {
                    const area = parseFloat(i.areaTotal) || 0;
                    return area <= maxArea;
                });
            }
            
            // Filtro por pavimentos (m√≠nimo)
            if (pavimentosFilter) {
                const minPavimentos = parseInt(pavimentosFilter);
                filtered = filtered.filter(i => {
                    const pavimentos = parseInt(i.qtdPavimentos) || 0;
                    return pavimentos >= minPavimentos;
                });
            }
            
            // Filtro por su√≠tes (m√≠nimo)
            if (suitesFilter) {
                const minSuites = parseInt(suitesFilter);
                filtered = filtered.filter(i => {
                    const suites = parseInt(i.qtdSuites) || 0;
                    return suites >= minSuites;
                });
            }
            
            // Filtro por garagem
            if (garagemFilter !== 'all') {
                filtered = filtered.filter(i => i.possuiGaragem === garagemFilter);
            }
            
            // Filtro por quintal
            if (quintalFilter !== 'all') {
                filtered = filtered.filter(i => i.possuiQuintal === quintalFilter);
            }
            
            renderInspectionsList(filtered);
        }

        function clearFilters() {
            document.getElementById('filterType').value = 'all';
            document.getElementById('filterCity').value = 'all';
            document.getElementById('filterAddress').value = '';
            document.getElementById('filterQuartos').value = '';
            document.getElementById('filterAreaMin').value = '';
            document.getElementById('filterAreaMax').value = '';
            document.getElementById('filterPavimentos').value = '';
            document.getElementById('filterSuites').value = '';
            document.getElementById('filterGaragem').value = 'all';
            document.getElementById('filterQuintal').value = 'all';
            renderInspectionsList(inspections);
        }

        function showInspectionDetails(inspectionId) {
            const inspection = inspections.find(i => i.id === inspectionId);
            if (!inspection) {
                alert('Inspe√ß√£o n√£o encontrada!');
                return;
            }
            
            // Criar modal com detalhes
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.style.zIndex = '2000';
            
            const typeBadge = inspection.type === 'inicial' ? 
                '<span class="inspection-type-badge badge-inicial">INICIAL</span>' :
                '<span class="inspection-type-badge badge-completa">COMPLETA</span>';
            
            const problems = countProblems(inspection);
            const photos = countPhotos(inspection);
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h2>Detalhes da Inspe√ß√£o ${typeBadge}</h2>
                    </div>
                    <div style="max-height: 60vh; overflow-y: auto;">
                        <div class="form-section">
                            <h4>üìç Dados do Im√≥vel</h4>
                            <p><strong>Endere√ßo:</strong> ${inspection.endereco}, ${inspection.numero}</p>
                            ${inspection.complemento ? `<p><strong>Complemento:</strong> ${inspection.complemento}</p>` : ''}
                            <p><strong>Bairro:</strong> ${inspection.bairro}</p>
                            <p><strong>Munic√≠pio:</strong> ${inspection.municipio}</p>
                            <p><strong>UF:</strong> ${inspection.uf}</p>
                        </div>
                        
                        <div class="form-section">
                            <h4>üìÖ Informa√ß√µes da Vistoria</h4>
                            <p><strong>Data:</strong> ${formatDate(inspection.dataVistoria)}</p>
                            <p><strong>Hora:</strong> ${inspection.horaVistoria}</p>
                            <p><strong>Acompanhante:</strong> ${inspection.acompanhante}</p>
                        </div>
                        
                        <div class="form-section">
                            <h4>üè† Caracter√≠sticas</h4>
                            ${inspection.idadeImovel ? `<p><strong>Idade:</strong> ${inspection.idadeImovel} anos</p>` : ''}
                            ${inspection.qtdPavimentos ? `<p><strong>Pavimentos:</strong> ${inspection.qtdPavimentos}</p>` : ''}
                            ${inspection.qtdSalas ? `<p><strong>Salas:</strong> ${inspection.qtdSalas}</p>` : ''}
                            ${inspection.qtdQuartos ? `<p><strong>Quartos:</strong> ${inspection.qtdQuartos}</p>` : ''}
                            ${inspection.qtdSuites ? `<p><strong>Su√≠tes:</strong> ${inspection.qtdSuites}</p>` : ''}
                            ${inspection.qtdCozinhas ? `<p><strong>Cozinhas:</strong> ${inspection.qtdCozinhas}</p>` : ''}
                            ${inspection.possuiQuintal ? `<p><strong>Quintal:</strong> ${inspection.possuiQuintal === 'sim' ? 'Sim' : 'N√£o'}</p>` : ''}
                            ${inspection.possuiGaragem ? `<p><strong>Garagem:</strong> ${inspection.possuiGaragem === 'sim' ? 'Sim' : 'N√£o'}</p>` : ''}
                        </div>
                        
                        <div class="form-section">
                            <h4>‚ö†Ô∏è Resumo</h4>
                            <p><strong>Problemas encontrados:</strong> ${problems}</p>
                            <p><strong>Fotos registradas:</strong> ${photos}</p>
                        </div>
                    </div>
                    <div style="margin-top: 20px; text-align: center; display: flex; gap: 10px; justify-content: center;">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Fechar</button>
                        <button class="btn" onclick="downloadInspectionHTML('${inspection.id}')" style="background: #4CAF50; color: white;">üåê Exportar HTML (Recomendado)</button>
                        <button class="btn btn-primary" onclick="downloadInspectionDOCX('${inspection.id}')">üìÑ Exportar Relat√≥rio DOCX</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Download DOCX Report for saved inspection
        async function downloadInspectionDOCX(inspectionId) {
            // Encontrar a inspe√ß√£o
            const inspection = inspections.find(i => i.id === inspectionId);
            
            if (!inspection) {
                alert('‚ùå Inspe√ß√£o n√£o encontrada!');
                return;
            }
            
            try {
                showProgress('Gerando relat√≥rio DOCX...');
                
                // Verificar se a biblioteca docx est√° dispon√≠vel
                // Aguardar um pouco para garantir que a biblioteca carregou
                await new Promise(resolve => setTimeout(resolve, 500));
                
                let docxLib = null;
                if (typeof docx !== 'undefined') {
                    docxLib = docx;
                } else if (typeof window.docx !== 'undefined') {
                    docxLib = window.docx;
                }
                
                if (!docxLib) {
                    alert('‚ö†Ô∏è Biblioteca docx n√£o est√° dispon√≠vel. Por favor, recarregue a p√°gina e tente novamente.\n\nSe o problema persistir, verifique sua conex√£o com a internet.');
                    hideProgress();
                    return;
                }

                const { Document, Packer, Paragraph, TextRun, HeadingLevel, AlignmentType, ImageRun, Media } = docxLib;
                
                // Array para armazenar elementos do documento
                const children = [];
                
                // T√≠tulo do relat√≥rio
                children.push(
                    new Paragraph({
                        text: "RELAT√ìRIO DE INSPE√á√ÉO RESIDENCIAL",
                        heading: HeadingLevel.HEADING_1,
                        alignment: AlignmentType.CENTER,
                        spacing: { after: 200 }
                    })
                );
                
                // Tipo de inspe√ß√£o
                const tipoTexto = inspection.type === 'inicial' ? 'INSPE√á√ÉO INICIAL' : 'INSPE√á√ÉO COMPLETA';
                children.push(
                    new Paragraph({
                        text: tipoTexto,
                        heading: HeadingLevel.HEADING_2,
                        alignment: AlignmentType.CENTER,
                        spacing: { after: 300 }
                    })
                );
                
                // DADOS DO IM√ìVEL
                children.push(
                    new Paragraph({
                        text: "DADOS DO IM√ìVEL",
                        heading: HeadingLevel.HEADING_2,
                        spacing: { before: 200, after: 200 }
                    })
                );
                
                const dados = [
                    ['Endere√ßo:', `${inspection.endereco}, ${inspection.numero}`],
                    ['Complemento:', inspection.complemento || 'N/A'],
                    ['Bairro:', inspection.bairro],
                    ['Munic√≠pio/UF:', `${inspection.municipio} - ${inspection.uf}`],
                    ['Data:', inspection.dataVistoria],
                    ['Hora:', inspection.horaVistoria],
                    ['Acompanhante:', inspection.acompanhante],
                    ['Telefone:', inspection.telefoneAcompanhante || 'N/A'],
                    ['Idade:', `${inspection.idadeImovel} anos`]
                ];
                
                dados.forEach(([label, value]) => {
                    children.push(
                        new Paragraph({
                            children: [
                                new TextRun({ text: label, bold: true }),
                                new TextRun({ text: ` ${value}` })
                            ],
                            spacing: { after: 100 }
                        })
                    );
                });
                
                // CARACTER√çSTICAS
                children.push(
                    new Paragraph({
                        text: "CARACTER√çSTICAS DO IM√ìVEL",
                        heading: HeadingLevel.HEADING_2,
                        spacing: { before: 400, after: 200 }
                    })
                );
                
                const caracteristicas = [
                    ['Pavimentos:', inspection.qtdPavimentos || 'N/A'],
                    ['Salas:', inspection.qtdSalas || 'N/A'],
                    ['Quartos:', inspection.qtdQuartos || 'N/A'],
                    ['Su√≠tes:', inspection.qtdSuites || 'N/A'],
                    ['Cozinhas:', inspection.qtdCozinhas || 'N/A'],
                    ['Quintal:', inspection.possuiQuintal || 'N/A'],
                    ['Garagem:', inspection.possuiGaragem || 'N/A']
                ];
                
                caracteristicas.forEach(([label, value]) => {
                    children.push(
                        new Paragraph({
                            children: [
                                new TextRun({ text: label, bold: true }),
                                new TextRun({ text: ` ${value}` })
                            ],
                            spacing: { after: 100 }
                        })
                    );
                });
                
                // FOTOS GERAIS DO IM√ìVEL
                const fotosGerais = [];
                if (inspection.photos) {
                    Object.keys(inspection.photos).forEach(key => {
                        if (key.startsWith('fotos_')) {
                            const nomeLimpo = key.replace('fotos_', '').replace(/\d+$/, '').replace(/_/g, ' ');
                            fotosGerais.push({
                                key: key,
                                nome: nomeLimpo.charAt(0).toUpperCase() + nomeLimpo.slice(1),
                                fotos: inspection.photos[key]
                            });
                        }
                    });
                }
                
                if (fotosGerais.length > 0) {
                    children.push(
                        new Paragraph({
                            text: "FOTOS GERAIS DO IM√ìVEL",
                            heading: HeadingLevel.HEADING_2,
                            spacing: { before: 400, after: 200 }
                        })
                    );
                    
                    for (const fotoGeral of fotosGerais) {
                        if (fotoGeral.fotos && fotoGeral.fotos.length > 0) {
                            children.push(
                                new Paragraph({
                                    text: fotoGeral.nome.toUpperCase(),
                                    heading: HeadingLevel.HEADING_3,
                                    spacing: { before: 200, after: 100 }
                                })
                            );
                            
                            for (let i = 0; i < fotoGeral.fotos.length; i++) {
                                try {
                                    const imageData = (typeof fotoGeral.fotos[i] === 'object' && fotoGeral.fotos[i].data) ? 
                                        fotoGeral.fotos[i].data : fotoGeral.fotos[i];
                                    
                                    const imageBytes = await base64ToUint8Array(imageData);
                                    const dimensions = await getImageDimensions(imageData);
                                    
                                    const maxWidth = 500;
                                    const aspectRatio = dimensions.width / dimensions.height;
                                    const width = Math.min(dimensions.width, maxWidth);
                                    const height = width / aspectRatio;
                                    
                                    children.push(
                                        new Paragraph({
                                            children: [
                                                new ImageRun({
                                                    data: imageBytes,
                                                    transformation: {
                                                        width: width * 9525,
                                                        height: height * 9525
                                                    }
                                                })
                                            ],
                                            alignment: AlignmentType.LEFT,
                                            spacing: { after: 200 }
                                        })
                                    );
                                    
                                    children.push(
                                        new Paragraph({
                                            text: `Foto ${i + 1}`,
                                            spacing: { after: 200 }
                                        })
                                    );
                                } catch (error) {
                                    console.error('‚ùå Erro ao adicionar foto geral ao DOCX:', error);
                                    children.push(
                                        new Paragraph({
                                            text: `[Erro ao carregar foto ${i + 1}]`,
                                            spacing: { after: 200 }
                                        })
                                    );
                                }
                            }
                        }
                    }
                }
                
                // PROBLEMAS ENCONTRADOS
                const problemasEncontrados = [];
                
                if (inspection.checklist) {
                    Object.keys(inspection.checklist).forEach(itemId => {
                        const item = inspection.checklist[itemId];
                        
                        if (item.status === 'issue' && isValidInspectionItem(itemId)) {
                            const categoryName = getCategoryNameFromId(itemId);
                            const itemName = getItemNameFromId(itemId);
                            
                            if (item.occurrences && item.occurrences.length > 0) {
                                item.occurrences.forEach((occ, index) => {
                                    const occNum = occ.occurrenceNum || (index + 1);
                                    problemasEncontrados.push({
                                        categoria: categoryName,
                                        item: itemName,
                                        ocorrencia: occNum,
                                        observacao: occ.observation || 'Sem observa√ß√£o',
                                        photoKey: `${itemId}_${occNum}`
                                    });
                                });
                            } else if (item.observation) {
                                problemasEncontrados.push({
                                    categoria: categoryName,
                                    item: itemName,
                                    ocorrencia: 1,
                                    observacao: item.observation,
                                    photoKey: `${itemId}_1`
                                });
                            } else {
                                problemasEncontrados.push({
                                    categoria: categoryName,
                                    item: itemName,
                                    ocorrencia: 1,
                                    observacao: 'Problema identificado',
                                    photoKey: `${itemId}_1`
                                });
                            }
                        }
                    });
                }
                
                if (problemasEncontrados.length > 0) {
                    children.push(
                        new Paragraph({
                            text: "PROBLEMAS ENCONTRADOS",
                            heading: HeadingLevel.HEADING_2,
                            spacing: { before: 400, after: 200 }
                        })
                    );
                    
                    for (let i = 0; i < problemasEncontrados.length; i++) {
                        const problema = problemasEncontrados[i];
                        
                        children.push(
                            new Paragraph({
                                children: [
                                    new TextRun({ 
                                        text: `${i + 1}. ${problema.categoria} - ${problema.item}`, 
                                        bold: true,
                                        size: 22
                                    })
                                ],
                                spacing: { before: 200, after: 100 }
                            })
                        );
                        
                        if (problemasEncontrados.filter(p => p.item === problema.item).length > 1) {
                            children.push(
                                new Paragraph({
                                    text: `(Ocorr√™ncia ${problema.ocorrencia})`,
                                    spacing: { after: 100 }
                                })
                            );
                        }
                        
                        children.push(
                            new Paragraph({
                                children: [
                                    new TextRun({ text: "Observa√ß√£o: ", bold: true }),
                                    new TextRun({ text: problema.observacao })
                                ],
                                spacing: { after: 200 }
                            })
                        );
                        
                        if (inspection.photos && inspection.photos[problema.photoKey]) {
                            const fotos = inspection.photos[problema.photoKey];
                            
                            for (let j = 0; j < fotos.length; j++) {
                                try {
                                    const imageData = (typeof fotos[j] === 'object' && fotos[j].data) ? fotos[j].data : fotos[j];
                                    const imageBytes = await base64ToUint8Array(imageData);
                                    const dimensions = await getImageDimensions(imageData);
                                    
                                    const maxWidth = 500;
                                    const aspectRatio = dimensions.width / dimensions.height;
                                    const width = Math.min(dimensions.width, maxWidth);
                                    const height = width / aspectRatio;
                                    
                                    children.push(
                                        new Paragraph({
                                            children: [
                                                new ImageRun({
                                                    data: imageBytes,
                                                    transformation: {
                                                        width: width * 9525,
                                                        height: height * 9525
                                                    }
                                                })
                                            ],
                                            alignment: AlignmentType.LEFT,
                                            spacing: { after: 200 }
                                        })
                                    );
                                    
                                    children.push(
                                        new Paragraph({
                                            text: `Foto ${j + 1} - ${problema.observacao}`,
                                            spacing: { after: 200 }
                                        })
                                    );
                                } catch (error) {
                                    console.error('‚ùå Erro ao adicionar foto ao DOCX:', error);
                                    children.push(
                                        new Paragraph({
                                            text: `[Erro ao carregar foto ${j + 1}]`,
                                            spacing: { after: 200 }
                                        })
                                    );
                                }
                            }
                        } else {
                            children.push(
                                new Paragraph({
                                    text: "(Sem fotos anexadas)",
                                    spacing: { after: 200 }
                                })
                            );
                        }
                    }
                } else {
                    children.push(
                        new Paragraph({
                            text: "PROBLEMAS ENCONTRADOS",
                            heading: HeadingLevel.HEADING_2,
                            spacing: { before: 400, after: 200 }
                        })
                    );
                    
                    children.push(
                        new Paragraph({
                            text: "‚úì Nenhum problema identificado na inspe√ß√£o.",
                            spacing: { after: 200 }
                        })
                    );
                }
                
                // Criar documento com configura√ß√µes b√°sicas
                const doc = new Document({
                    creator: "Sistema de Inspe√ß√£o Residencial",
                    title: `Relat√≥rio de Inspe√ß√£o - ${inspection.type}`,
                    description: `Relat√≥rio de inspe√ß√£o residencial gerado em ${new Date().toLocaleString('pt-BR')}`,
                    sections: [{
                        properties: {
                            page: {
                                margin: {
                                    top: 1440,    // 1 polegada = 1440 twips
                                    right: 1440,
                                    bottom: 1440,
                                    left: 1440
                                }
                            }
                        },
                        children: children
                    }]
                });
                
                // Gerar blob com tratamento de erro
                let blob;
                try {
                    blob = await Packer.toBlob(doc);
                    console.log('‚úÖ Documento DOCX gerado com sucesso, tamanho:', blob.size, 'bytes');
                } catch (error) {
                    console.error('‚ùå Erro ao gerar blob do documento:', error);
                    throw new Error('Erro ao gerar arquivo DOCX: ' + error.message);
                }
                
                // Nome do arquivo
                const nomeArquivo = `Relatorio_${inspection.type}_${inspection.municipio.replace(/\s+/g, '_')}_${inspection.dataVistoria.replace(/\//g, '-')}.docx`;
                
                // Primeiro, sempre fazer download local para garantir que o arquivo est√° OK
                saveAs(blob, nomeArquivo);
                hideProgress();
                playSound('success');
                
                // Fazer upload para o Drive em background (sem bloquear)
                if (accessToken) {
                    // Upload em background sem bloquear a interface
                    (async () => {
                        try {
                            showProgress('Enviando relat√≥rio para o Google Drive...');
                            
                            // Timeout de 30 segundos para o upload
                            const uploadPromise = (async () => {
                                // Obter ou criar pasta da obra no Drive
                                let folderId = inspection.driveFolderId;
                                
                                if (!folderId) {
                                    if (!SHARED_FOLDER_ID) {
                                        throw new Error('Pasta compartilhada n√£o configurada');
                                    }
                                    
                                    await ensureSharedFolderAccess();
                                    const rootFolderId = SHARED_FOLDER_ID;
                                    
                                    const typeFolderName = inspection.type === 'inicial' ? 'inspecao_inicial' : 'inspecao_completa';
                                    const typeFolderId = await findOrCreateFolder(typeFolderName, rootFolderId);
                                    
                                    const dateFolder = formatDate(inspection.dataVistoria).replace(/\//g, '-');
                                    const dateFolderId = await findOrCreateFolder(dateFolder, typeFolderId);
                                    
                                    const addressFolder = `${inspection.endereco}_${inspection.numero}`.replace(/[^a-zA-Z0-9]/g, '_');
                                    folderId = await findOrCreateFolder(addressFolder, dateFolderId);
                                }
                                
                                // Upload direto do blob
                                await uploadFile(blob, nomeArquivo, folderId, 'application/vnd.openxmlformats-officedocument.wordprocessingml.document');
                            })();
                            
                            // Adicionar timeout
                            const timeoutPromise = new Promise((_, reject) => {
                                setTimeout(() => reject(new Error('Timeout: Upload demorou mais de 30 segundos')), 30000);
                            });
                            
                            await Promise.race([uploadPromise, timeoutPromise]);
                            
                            hideProgress();
                            alert('‚úÖ Relat√≥rio DOCX tamb√©m foi enviado para o Google Drive com sucesso!\n\nüìÑ O arquivo foi salvo na pasta da obra.');
                            
                        } catch (error) {
                            console.error('Erro ao enviar para o Drive:', error);
                            hideProgress();
                            // N√£o mostrar alerta de erro para n√£o incomodar - o arquivo j√° foi baixado
                            console.warn('‚ö†Ô∏è Upload para Drive falhou, mas arquivo foi salvo localmente:', error.message);
                        }
                    })();
                    
                    // Mostrar mensagem de sucesso imediatamente
                    alert('‚úÖ Relat√≥rio DOCX gerado com sucesso!\n\nüìÑ O arquivo foi baixado automaticamente.\n\nüì§ O upload para o Google Drive est√° sendo feito em segundo plano.');
                } else {
                    // Apenas download local se n√£o estiver conectado ao Drive
                    alert('‚úÖ Relat√≥rio DOCX gerado com sucesso!\n\nüìÑ O arquivo foi baixado automaticamente.\n\n‚ö†Ô∏è N√£o conectado ao Google Drive. Para enviar automaticamente, configure o Drive nas Configura√ß√µes.');
                }
                
            } catch (error) {
                hideProgress();
                console.error('Erro ao gerar DOCX:', error);
                alert('‚ùå Erro ao gerar DOCX: ' + error.message);
            }
        }

        function downloadInspectionReport(inspectionId) {
            // Fun√ß√£o antiga mantida para compatibilidade - agora redireciona para DOCX
            downloadInspectionDOCX(inspectionId);
        }

        // Download HTML Report for saved inspection (RECOMENDADO)
        async function downloadInspectionHTML(inspectionId) {
            // Encontrar a inspe√ß√£o
            const inspection = inspections.find(i => i.id === inspectionId);
            
            if (!inspection) {
                alert('‚ùå Inspe√ß√£o n√£o encontrada!');
                return;
            }
            
            try {
                showProgress('Gerando relat√≥rio HTML...');
                
                // Usar a mesma l√≥gica da fun√ß√£o downloadHTMLReport, mas com a inspe√ß√£o salva
                // Criar HTML completo
                let html = `
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relat√≥rio de Inspe√ß√£o - ${inspection.endereco}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; color: #333; max-width: 1200px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .container { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #667eea; text-align: center; font-size: 32px; margin-bottom: 10px; border-bottom: 3px solid #667eea; padding-bottom: 15px; }
        h2 { color: #667eea; font-size: 24px; margin-top: 30px; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #e0e0e0; }
        h3 { color: #764ba2; font-size: 18px; margin-top: 20px; margin-bottom: 10px; }
        .subtitle { text-align: center; color: #666; font-size: 18px; margin-bottom: 30px; }
        .info-grid { display: grid; grid-template-columns: 200px 1fr; gap: 10px; margin-bottom: 20px; }
        .info-label { font-weight: bold; color: #555; }
        .info-value { color: #333; }
        .problem-item { background: #f9f9f9; border-left: 4px solid #ff5722; padding: 20px; margin-bottom: 25px; border-radius: 4px; }
        .problem-title { font-weight: bold; color: #ff5722; font-size: 18px; margin-bottom: 10px; }
        .problem-observation { color: #555; margin: 10px 0; font-style: italic; }
        .photos-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 15px; }
        .photo-item { text-align: center; }
        .photo-item img { max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 8px; }
        .photo-caption { font-size: 14px; color: #666; }
        .no-problems { background: #e8f5e9; border-left: 4px solid #4caf50; padding: 20px; border-radius: 4px; color: #2e7d32; font-weight: 500; }
        .footer { margin-top: 40px; padding-top: 20px; border-top: 2px solid #e0e0e0; text-align: center; color: #666; font-size: 14px; }
        @media print { body { background: white; padding: 0; } .container { box-shadow: none; padding: 20px; } .photo-item img { max-width: 400px; } }
    </style>
</head>
<body>
    <div class="container">
        <h1>RELAT√ìRIO DE INSPE√á√ÉO RESIDENCIAL</h1>
        <p class="subtitle">${inspection.type === 'inicial' ? 'INSPE√á√ÉO INICIAL' : 'INSPE√á√ÉO COMPLETA'}</p>
        
        <h2>üìã DADOS DO IM√ìVEL</h2>
        <div class="info-grid">
            <div class="info-label">Endere√ßo:</div>
            <div class="info-value">${inspection.endereco}, ${inspection.numero}</div>
            <div class="info-label">Complemento:</div>
            <div class="info-value">${inspection.complemento || 'N/A'}</div>
            <div class="info-label">Bairro:</div>
            <div class="info-value">${inspection.bairro}</div>
            <div class="info-label">Munic√≠pio/UF:</div>
            <div class="info-value">${inspection.municipio} - ${inspection.uf}</div>
            <div class="info-label">Data da Vistoria:</div>
            <div class="info-value">${inspection.dataVistoria}</div>
            <div class="info-label">Hora da Vistoria:</div>
            <div class="info-value">${inspection.horaVistoria}</div>
            <div class="info-label">Acompanhante:</div>
            <div class="info-value">${inspection.acompanhante}</div>
            <div class="info-label">Idade do Im√≥vel:</div>
            <div class="info-value">${inspection.idadeImovel} anos</div>
        </div>
        
        <h2>üè† CARACTER√çSTICAS DO IM√ìVEL</h2>
        <div class="info-grid">
            <div class="info-label">Pavimentos:</div>
            <div class="info-value">${inspection.qtdPavimentos || 'N/A'}</div>
            <div class="info-label">Salas:</div>
            <div class="info-value">${inspection.qtdSalas || 'N/A'}</div>
            <div class="info-label">Quartos:</div>
            <div class="info-value">${inspection.qtdQuartos || 'N/A'}</div>
            <div class="info-label">Su√≠tes:</div>
            <div class="info-value">${inspection.qtdSuites || 'N/A'}</div>
            <div class="info-label">Cozinhas:</div>
            <div class="info-value">${inspection.qtdCozinhas || 'N/A'}</div>
            <div class="info-label">Quintal:</div>
            <div class="info-value">${inspection.possuiQuintal || 'N/A'}</div>
            <div class="info-label">Garagem:</div>
            <div class="info-value">${inspection.possuiGaragem || 'N/A'}</div>
        </div>
`;
                
                // FOTOS GERAIS DO IM√ìVEL
                const fotosGerais = [];
                if (inspection.photos) {
                    Object.keys(inspection.photos).forEach(key => {
                        if (key.startsWith('fotos_')) {
                            const nomeLimpo = key.replace('fotos_', '').replace(/\d+$/, '').replace(/_/g, ' ');
                            fotosGerais.push({
                                key: key,
                                nome: nomeLimpo.charAt(0).toUpperCase() + nomeLimpo.slice(1),
                                fotos: inspection.photos[key]
                            });
                        }
                    });
                }
                
                if (fotosGerais.length > 0) {
                    html += `<h2>üì∏ FOTOS GERAIS DO IM√ìVEL</h2>`;
                    
                    for (const fotoGeral of fotosGerais) {
                        if (fotoGeral.fotos && fotoGeral.fotos.length > 0) {
                            html += `<h3>${fotoGeral.nome.toUpperCase()}</h3>`;
                            html += `<div class="photos-grid">`;
                            
                            for (let i = 0; i < fotoGeral.fotos.length; i++) {
                                const imageData = (typeof fotoGeral.fotos[i] === 'object' && fotoGeral.fotos[i].data) ? 
                                    fotoGeral.fotos[i].data : fotoGeral.fotos[i];
                                
                                html += `
                                    <div class="photo-item">
                                        <img src="${imageData}" alt="Foto ${i + 1}">
                                        <div class="photo-caption">Foto ${i + 1}</div>
                                    </div>
                                `;
                            }
                            
                            html += `</div>`;
                        }
                    }
                }
                
                // PROBLEMAS ENCONTRADOS
                const problemasEncontrados = [];
                
                // LOGS DE DEBUG DETALHADOS
                console.log("üìä ===== HTML EXPORT: IN√çCIO =====");
                console.log("üìã Total de chaves no checklist:", inspection.checklist ? Object.keys(inspection.checklist).length : 0);
                console.log("üìã Chaves:", inspection.checklist ? Object.keys(inspection.checklist) : []);
                
                if (inspection.checklist) {
                    Object.keys(inspection.checklist).forEach(itemId => {
                        const item = inspection.checklist[itemId];
                        
                        if (item.status === 'issue' && isValidInspectionItem(itemId)) {
                        
                        console.log(`üîç Processando: ${itemId}, Status: ${item.status}`);
                            const categoryName = getCategoryNameFromId(itemId);
                            const itemName = getItemNameFromId(itemId);
                            
                            if (item.occurrences && item.occurrences.length > 0) {
                                item.occurrences.forEach((occ, index) => {
                                    const occNum = occ.occurrenceNum || (index + 1);
                                    problemasEncontrados.push({
                                        categoria: categoryName,
                                        item: itemName,
                                        ocorrencia: occNum,
                                        observacao: occ.observation || 'Sem observa√ß√£o',
                                        photoKey: `${itemId}_${occNum}`
                                    });
                                });
                            } else if (item.observation) {
                                problemasEncontrados.push({
                                    categoria: categoryName,
                                    item: itemName,
                                    ocorrencia: 1,
                                    observacao: item.observation,
                                    photoKey: `${itemId}_1`
                                });
                            } else {
                                problemasEncontrados.push({
                                    categoria: categoryName,
                                    item: itemName,
                                    ocorrencia: 1,
                                    observacao: 'Problema identificado',
                                    photoKey: `${itemId}_1`
                                });
                            }
                        }
                    });
                }
                
                html += `<h2>‚ö†Ô∏è PROBLEMAS ENCONTRADOS</h2>`;
                
                if (problemasEncontrados.length > 0) {
                
                console.log(`üìä ===== TOTAL: ${problemasEncontrados.length} PROBLEMAS COLETADOS =====`);
                console.log("üìã Lista completa:", problemasEncontrados);
                    for (let i = 0; i < problemasEncontrados.length; i++) {
                        const problema = problemasEncontrados[i];
                        
                        html += `
                            <div class="problem-item">
                                <div class="problem-title">${i + 1}. ${problema.categoria} - ${problema.item}</div>
                                ${problemasEncontrados.filter(p => p.item === problema.item).length > 1 ? 
                                    `<div>(Ocorr√™ncia ${problema.ocorrencia})</div>` : ''}
                                <div class="problem-observation"><strong>Observa√ß√£o:</strong> ${problema.observacao}</div>
                        `;
                        
                        // Adicionar fotos se existirem
                        if (inspection.photos && inspection.photos[problema.photoKey]) {
                            const fotos = inspection.photos[problema.photoKey];
                            
                            html += `<div class="photos-grid">`;
                            
                            for (let j = 0; j < fotos.length; j++) {
                                const imageData = (typeof fotos[j] === 'object' && fotos[j].data) ? fotos[j].data : fotos[j];
                                
                                html += `
                                    <div class="photo-item">
                                        <img src="${imageData}" alt="Foto do problema ${j + 1}">
                                        <div class="photo-caption">Foto ${j + 1}</div>
                                    </div>
                                `;
                            }
                            
                            html += `</div>`;
                        }
                        
                        html += `</div>`;
                    }
                } else {
                    html += `<div class="no-problems">‚úì Nenhum problema identificado na inspe√ß√£o.</div>`;
                }
                
                // Footer
                html += `
        <div class="footer">
            <p><strong>Relat√≥rio gerado em:</strong> ${new Date().toLocaleString('pt-BR')}</p>
            <p><strong>Sistema de Inspe√ß√£o Residencial</strong> - Eng. Bruno Machado</p>
            <p style="margin-top: 10px; font-size: 12px; color: #999;">
                üí° <strong>Dica:</strong> Para imprimir como PDF, pressione Ctrl+P (Windows) ou Cmd+P (Mac) e escolha "Salvar como PDF"<br>
                üí° Para abrir no Word e salvar como DOCX, clique com bot√£o direito no arquivo ‚Üí Abrir com ‚Üí Microsoft Word
            </p>
        </div>
    </div>
</body>
</html>
`;
                
                // Criar blob e fazer download
                const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
                const nomeArquivo = `Relatorio_${inspection.type}_${inspection.municipio.replace(/\s+/g, '_')}_${inspection.dataVistoria.replace(/\//g, '-')}.html`;
                
                saveAs(blob, nomeArquivo);
                hideProgress();
                playSound('success');
                
                alert(`‚úÖ Relat√≥rio HTML gerado com sucesso!

üìÅ Arquivo: ${nomeArquivo}

üí° COMO USAR:
1. Abra o arquivo no navegador para visualizar
2. Para PDF: Abra no navegador ‚Üí Ctrl+P ‚Üí Salvar como PDF
3. Para DOCX: Clique com bot√£o direito ‚Üí Abrir com ‚Üí Word ‚Üí Salvar como DOCX

‚ú® O HTML √© mais confi√°vel e n√£o corrompe!`);
                
            } catch (error) {
                hideProgress();
                console.error('Erro ao gerar HTML:', error);
                alert('‚ùå Erro ao gerar HTML: ' + error.message);
            }
        }

        // Confirmar dele√ß√£o de inspe√ß√£o
        async function confirmDeleteInspection(inspectionId) {
            const inspection = inspections.find(i => i.id === inspectionId);
            if (!inspection) {
                alert('Inspe√ß√£o n√£o encontrada!');
                return;
            }

            const message = `
‚ö†Ô∏è ATEN√á√ÉO - ESTA A√á√ÉO N√ÉO PODE SER DESFEITA! ‚ö†Ô∏è

Voc√™ est√° prestes a DELETAR PERMANENTEMENTE esta inspe√ß√£o:

üìç ${inspection.endereco}, ${inspection.numero}
üìÖ ${formatDate(inspection.dataVistoria)} √†s ${inspection.horaVistoria}
${inspection.type === 'inicial' ? 'üèÅ INSPE√á√ÉO INICIAL' : 'üìä INSPE√á√ÉO COMPLETA'}

‚ö†Ô∏è TODOS OS DADOS SER√ÉO PERDIDOS:
‚Ä¢ Informa√ß√µes do im√≥vel
‚Ä¢ Observa√ß√µes de problemas
‚Ä¢ TODAS AS FOTOS
‚Ä¢ Relat√≥rios gerados

‚ùå ESTA A√á√ÉO N√ÉO PODE SER RECUPERADA! ‚ùå

Digite "DELETAR" em LETRAS MAI√öSCULAS para confirmar:`;

            const confirmation = prompt(message);
            
            if (confirmation === 'DELETAR') {
                try {
                    showProgress('Deletando inspe√ß√£o...');
                    await deleteInspectionFromDrive(inspection);
                    hideProgress();
                    
                    // Verificar se a inspe√ß√£o foi realmente removida
                    const stillExists = inspections.find(i => i.id === inspection.id);
                    if (stillExists) {
                        alert('‚ö†Ô∏è Inspe√ß√£o removida localmente, mas pode ainda existir no Google Drive.\n\nSe voc√™ n√£o tem permiss√£o para deletar no Drive, a inspe√ß√£o permanecer√° l√°, mas n√£o aparecer√° mais na sua lista local.');
                    } else {
                        alert('‚úÖ Inspe√ß√£o deletada com sucesso!');
                        playSound('success');
                    }
                    
                    // Recarregar a lista
                    await loadInspections();
                    loadDatabaseView();
                    
                } catch (error) {
                    hideProgress();
                    console.error('‚ùå Erro ao deletar:', error);
                    // Mesmo com erro, tentar remover localmente
                    const index = inspections.findIndex(i => i.id === inspection.id);
                    if (index > -1) {
                        inspections.splice(index, 1);
                        safeLocalStorageSet('inspections', safeJSONStringify(inspections));
                        alert('‚ö†Ô∏è Erro ao deletar do Google Drive, mas a inspe√ß√£o foi removida localmente.\n\n' + error.message);
                        await loadInspections();
                        loadDatabaseView();
                    } else {
                        alert('‚ùå Erro ao deletar inspe√ß√£o: ' + error.message);
                    }
                }
            } else if (confirmation !== null) {
                alert('‚ùå Texto de confirma√ß√£o incorreto. A inspe√ß√£o N√ÉO foi deletada.');
            }
        }

        // ========================================================================
        // CONFIGURA√á√ïES - JAVASCRIPT COMPLETO
        // ========================================================================

        // Global settings object
        let userSettings = {
            theme: 'light',
            fontSize: 'medium',
            primaryColor: '#667eea',
            compactMode: false,
            hideTooltips: false,
            simpleMode: false,
            photoQuality: 'high',
            folderRootName: 'Inspecoes_Residenciais',
            folderStructure: 'tipo-data-endereco',
            alertDriveDisconnected: true,
            confirmBeforeExit: true,
            soundEffects: true,
            driveOnly: false,
            customFields: []
        };

        // Tutorial steps
        const tutorialSteps = [
            {
                title: 'üè† Bem-vindo ao Sistema!',
                content: 'Este tutorial vai te ensinar a usar todas as funcionalidades do sistema de inspe√ß√£o residencial. Vamos come√ßar?'
            },
            {
                title: 'üìã Criando uma Inspe√ß√£o',
                content: 'No menu principal, clique em "Nova Inspe√ß√£o". Voc√™ pode escolher entre Inspe√ß√£o Inicial (primeira vistoria) ou Inspe√ß√£o Completa (vistoria detalhada).'
            },
            {
                title: '‚úèÔ∏è Preenchendo Dados',
                content: 'Preencha todos os campos obrigat√≥rios marcados com (*). Digite o endere√ßo completo, data, hor√°rio e quem acompanhou a inspe√ß√£o.'
            },
            {
                title: 'üì∏ Tirando Fotos',
                content: 'Ao marcar um problema na inspe√ß√£o, voc√™ pode adicionar fotos. Clique em "Adicionar Foto" e selecione as imagens do problema encontrado.'
            },
            {
                title: '‚ÑπÔ∏è √çcones Informativos',
                content: 'Passe o mouse sobre os √≠cones "i" ao lado dos itens para ver explica√ß√µes t√©cnicas. Exemplo: Trincas s√£o aberturas acima de 0,5mm.'
            },
            {
                title: 'üíæ Salvando',
                content: 'Quando terminar, clique em "Salvar Inspe√ß√£o". Os dados ser√£o salvos no Google Drive automaticamente em pastas organizadas por tipo, data e endere√ßo.'
            },
            {
                title: '‚öôÔ∏è Configura√ß√µes',
                content: 'Nas configura√ß√µes, voc√™ pode personalizar o sistema, ver estat√≠sticas, gerenciar o Google Drive e muito mais!'
            },
            {
                title: '‚úÖ Pronto!',
                content: 'Agora voc√™ est√° pronto para usar o sistema! Qualquer d√∫vida, acesse o suporte em Configura√ß√µes ‚Üí Sobre.'
            }
        ];

        // Show settings
        function showSettings() {
            hideAllScreens();
            const settingsScreen = document.getElementById('settingsScreen');
            settingsScreen.classList.add('active');
            settingsScreen.style.display = 'block';
            loadSettings();
            updateConnectionStatus();
            loadStatistics();
        }

        function switchSettingsTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.settings-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.settings-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById('tab-' + tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Load specific tab data
            if (tabName === 'stats') {
                loadStatistics();
            }
        }

        function loadSettings() {
            const saved = safeLocalStorageGet('userSettings');
            if (saved) {
                const parsedSettings = safeJSONParse(saved, {});
                userSettings = {...userSettings, ...parsedSettings};
            }
            
            // Apply to UI
            document.getElementById('theme').value = userSettings.theme;
            document.getElementById('fontSize').value = userSettings.fontSize;
            document.getElementById('primaryColor').value = userSettings.primaryColor;
            document.getElementById('compactMode').checked = userSettings.compactMode;
            document.getElementById('hideTooltips').checked = userSettings.hideTooltips;
            document.getElementById('simpleMode').checked = userSettings.simpleMode;
            document.getElementById('photoQuality').value = userSettings.photoQuality;
            document.getElementById('folderRootName').value = userSettings.folderRootName;
            document.getElementById('folderStructure').value = userSettings.folderStructure;
            document.getElementById('alertDriveDisconnected').checked = userSettings.alertDriveDisconnected;
            document.getElementById('confirmBeforeExit').checked = userSettings.confirmBeforeExit;
            document.getElementById('soundEffects').checked = userSettings.soundEffects;
            document.getElementById('driveOnly').checked = userSettings.driveOnly;
            
            // Apply current settings
            applyTheme(userSettings.theme);
            applyFontSize(userSettings.fontSize);
            applyPrimaryColor(userSettings.primaryColor);
        }

        function saveSettings() {
            userSettings = {
                theme: document.getElementById('theme').value,
                fontSize: document.getElementById('fontSize').value,
                primaryColor: document.getElementById('primaryColor').value,
                compactMode: document.getElementById('compactMode').checked,
                hideTooltips: document.getElementById('hideTooltips').checked,
                simpleMode: document.getElementById('simpleMode').checked,
                photoQuality: document.getElementById('photoQuality').value,
                folderRootName: document.getElementById('folderRootName').value,
                folderStructure: document.getElementById('folderStructure').value,
                alertDriveDisconnected: document.getElementById('alertDriveDisconnected').checked,
                confirmBeforeExit: document.getElementById('confirmBeforeExit').checked,
                soundEffects: document.getElementById('soundEffects').checked,
                driveOnly: document.getElementById('driveOnly').checked,
                customFields: userSettings.customFields
            };
            
            if (safeLocalStorageSet('userSettings', safeJSONStringify(userSettings))) {
                playSound('success');
                alert('‚úÖ Configura√ß√µes salvas com sucesso!');
            } else {
                alert('‚ö†Ô∏è Erro ao salvar configura√ß√µes. Verifique o espa√ßo dispon√≠vel.');
            }
        }

        // Theme & Appearance
        function applyTheme(theme) {
            if (theme === 'dark') {
                document.body.style.background = 'linear-gradient(135deg, #1a1a2e 0%, #16213e 100%)';
                document.body.style.color = '#e0e0e0';
            } else {
                document.body.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                document.body.style.color = '#333';
            }
        }

        function applyFontSize(size) {
            const sizes = { small: '14px', medium: '16px', large: '18px' };
            document.body.style.fontSize = sizes[size] || '16px';
        }

        function applyPrimaryColor(color) {
            document.documentElement.style.setProperty('--primary-color', color);
        }

        function applyCompactMode(enabled) {
            document.body.classList.toggle('compact-mode', enabled);
        }

        function applyHideTooltips(enabled) {
            document.querySelectorAll('.info-icon').forEach(icon => {
                icon.style.display = enabled ? 'none' : 'inline-block';
            });
        }

        function applySimpleMode(enabled) {
            document.body.classList.toggle('simple-mode', enabled);
        }

        // Google Drive Functions
        function updateConnectionStatus() {
            const dot = document.getElementById('connectionDot');
            const text = document.getElementById('connectionText');
            const email = document.getElementById('connectionEmail');
            
            if (accessToken) {
                dot.className = 'status-dot connected';
                text.textContent = '‚úÖ Conectado ao Google Drive';
                email.textContent = 'Logado automaticamente via Google';
                
                // Buscar informa√ß√µes de armazenamento
                updateStorageInfo();
            } else {
                dot.className = 'status-dot disconnected';
                text.textContent = '‚ùå Desconectado';
                email.textContent = 'Clique em Reconectar para autenticar';
            }
        }
        
        // Buscar e exibir informa√ß√µes de armazenamento do Drive
        async function updateStorageInfo() {
            if (!accessToken) return;
            
            try {
                const response = await gapi.client.drive.about.get({
                    fields: 'storageQuota'
                });
                
                const quota = response.result.storageQuota;
                const usage = parseInt(quota.usage);
                const limit = parseInt(quota.limit);
                
                // Converter para GB
                const usageGB = (usage / (1024 * 1024 * 1024)).toFixed(2);
                const limitGB = (limit / (1024 * 1024 * 1024)).toFixed(2);
                const percentUsed = ((usage / limit) * 100).toFixed(1);
                
                // Exibir informa√ß√µes
                displayStorageBar(usageGB, limitGB, percentUsed);
            } catch (error) {
                console.error('Erro ao buscar informa√ß√µes de armazenamento:', error);
            }
        }
        
        // Exibir barra de armazenamento
        function displayStorageBar(usageGB, limitGB, percentUsed) {
            const storageContainer = document.getElementById('driveStorageInfo');
            if (!storageContainer) return;
            
            const barColor = percentUsed > 90 ? '#f44336' : percentUsed > 75 ? '#FF9800' : '#4CAF50';
            
            storageContainer.innerHTML = `
                <div style="margin-top: 15px; padding: 15px; background: #f8f9ff; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px;">
                        <span style="font-weight: 600; color: #333;">üíæ Armazenamento do Drive</span>
                        <span style="color: #666;">${usageGB} GB / ${limitGB} GB (${percentUsed}%)</span>
                    </div>
                    <div style="width: 100%; height: 12px; background: #e0e0e0; border-radius: 6px; overflow: hidden;">
                        <div style="width: ${percentUsed}%; height: 100%; background: ${barColor}; transition: width 0.3s;"></div>
                    </div>
                    <div style="margin-top: 5px; font-size: 11px; color: #999;">
                        Espa√ßo dispon√≠vel: ${(limitGB - usageGB).toFixed(2)} GB
                    </div>
                </div>
            `;
        }

        function reconnectDrive() {
            requestAccessToken();
            setTimeout(() => {
                updateConnectionStatus();
            }, 2000);
        }

        function disconnectDrive() {
            if (confirm('Deseja realmente desconectar do Google Drive?')) {
                accessToken = null;
                updateConnectionStatus();
                alert('Desconectado com sucesso!');
            }
        }

        function openDriveFolder() {
            window.open('https://drive.google.com/drive/folders/', '_blank');
        }

        async function syncWithDrive() {
            if (!accessToken) {
                alert('‚ùå Voc√™ precisa estar conectado ao Google Drive!');
                return;
            }
            
            showProgress('Sincronizando com Google Drive...');
            
            try {
                const localInspections = safeJSONParse(safeLocalStorageGet('inspections'), []);
                let syncCount = 0;
                let errorCount = 0;
                const errors = [];
                
                for (const inspection of localInspections) {
                    try {
                        // S√≥ sincronizar se n√£o tiver driveFolderId (n√£o foi salva no Drive ainda)
                        if (!inspection.driveFolderId) {
                            await saveToGoogleDrive(inspection);
                            syncCount++;
                        } else {
                            console.log(`‚ÑπÔ∏è Inspe√ß√£o ${inspection.id} j√° est√° no Drive, pulando...`);
                        }
                    } catch (error) {
                        errorCount++;
                        errors.push(`${inspection.endereco}, ${inspection.numero}: ${error.message}`);
                        console.error(`‚ùå Erro ao sincronizar inspe√ß√£o ${inspection.id}:`, error);
                        // Continuar com as outras inspe√ß√µes mesmo se uma falhar
                    }
                }
                
                hideProgress();
                localStorage.setItem('lastSync', new Date().toISOString());
                const lastSyncElement = document.getElementById('lastSyncTime');
                if (lastSyncElement) {
                    lastSyncElement.textContent = new Date().toLocaleString('pt-BR');
                }
                
                if (syncCount > 0) {
                    playSound('success');
                }
                
                let message = '';
                if (syncCount > 0) {
                    message += `‚úÖ ${syncCount} inspe√ß√£o(√µes) sincronizada(s) com sucesso!\n\n`;
                }
                if (errorCount > 0) {
                    message += `‚ö†Ô∏è ${errorCount} inspe√ß√£o(√µes) com erro:\n${errors.slice(0, 3).join('\n')}`;
                    if (errors.length > 3) {
                        message += `\n... e mais ${errors.length - 3} erro(s)`;
                    }
                }
                if (syncCount === 0 && errorCount === 0) {
                    message = '‚ÑπÔ∏è Todas as inspe√ß√µes j√° est√£o sincronizadas!';
                }
                
                alert(message || '‚úÖ Sincroniza√ß√£o conclu√≠da!');
            } catch (error) {
                hideProgress();
                console.error('Erro ao sincronizar:', error);
                alert('‚ùå Erro ao sincronizar: ' + error.message);
            }
        }

        // Salvar configura√ß√£o de pasta compartilhada
        function saveSharedFolderConfig() {
            const folderId = document.getElementById('sharedFolderId').value.trim();
            
            if (!folderId) {
                alert('‚ö†Ô∏è Por favor, insira o ID da pasta compartilhada!');
                return;
            }
            
            // Validar formato do ID (normalmente tem 33 caracteres alfanum√©ricos)
            if (folderId.length < 20) {
                alert('‚ö†Ô∏è ID inv√°lido! O ID deve ter pelo menos 20 caracteres.\n\nVerifique se copiou corretamente da URL do Drive.');
                return;
            }
            
            const confirmed = confirm(
                '‚ö†Ô∏è ATEN√á√ÉO!\n\n' +
                'Ao salvar esta configura√ß√£o:\n\n' +
                '‚úÖ TODAS as inspe√ß√µes futuras ser√£o salvas nesta pasta compartilhada\n' +
                '‚úÖ M√∫ltiplos inspetores poder√£o salvar na mesma pasta\n' +
                '‚úÖ Voc√™ precisar√° ter permiss√£o de edi√ß√£o na pasta\n\n' +
                `üìÅ ID da pasta: ${folderId}\n\n` +
                'Deseja continuar?'
            );
            
            if (!confirmed) return;
            
            // Salvar no localStorage
            localStorage.setItem('SHARED_FOLDER_ID', folderId);
            
            // Atualizar a constante global (recarregar p√°gina para aplicar)
            alert(
                '‚úÖ Configura√ß√£o salva com sucesso!\n\n' +
                'üîÑ A p√°gina ser√° recarregada para aplicar as mudan√ßas.\n\n' +
                'üìå Todas as pr√≥ximas inspe√ß√µes ser√£o salvas na pasta compartilhada!'
            );
            
            playSound('success');
            setTimeout(() => window.location.reload(), 1500);
        }

        // Testar acesso √† pasta compartilhada
        async function testSharedFolder() {
            const folderId = document.getElementById('sharedFolderId').value.trim();
            
            if (!folderId) {
                alert('‚ö†Ô∏è Por favor, insira o ID da pasta compartilhada primeiro!');
                return;
            }
            
            if (!accessToken) {
                alert('‚ùå Voc√™ precisa estar conectado ao Google Drive primeiro!');
                return;
            }
            
            showProgress('Testando acesso √† pasta...');
            
            try {
                // Tentar acessar a pasta
                const response = await gapi.client.drive.files.get({
                    fileId: folderId,
                    fields: 'id, name, mimeType, capabilities'
                });
                
                hideProgress();
                
                const folder = response.result;
                
                if (folder.mimeType !== 'application/vnd.google-apps.folder') {
                    alert('‚ùå ERRO: O ID fornecido n√£o √© de uma pasta!\n\nVerifique se copiou o ID correto.');
                    return;
                }
                
                if (!folder.capabilities || !folder.capabilities.canAddChildren) {
                    alert(
                        '‚ö†Ô∏è AVISO: Voc√™ n√£o tem permiss√£o de EDI√á√ÉO nesta pasta!\n\n' +
                        'Voc√™ consegue visualizar a pasta, mas n√£o poder√° salvar inspe√ß√µes.\n\n' +
                        'Solu√ß√£o:\n' +
                        '1. Pe√ßa ao dono da pasta para dar permiss√£o de EDITOR\n' +
                        '2. Ou configure "Qualquer pessoa com o link pode editar"'
                    );
                    return;
                }
                
                alert(
                    '‚úÖ SUCESSO!\n\n' +
                    `üìÅ Pasta encontrada: "${folder.name}"\n` +
                    `üîë ID: ${folder.id}\n` +
                    `‚úÖ Voc√™ tem permiss√£o de edi√ß√£o\n\n` +
                    'Tudo certo! Voc√™ pode salvar esta configura√ß√£o.'
                );
                
                playSound('success');
                
            } catch (error) {
                hideProgress();
                console.error('Erro ao testar pasta:', error);
                
                if (error.status === 404) {
                    alert(
                        '‚ùå PASTA N√ÉO ENCONTRADA!\n\n' +
                        'Poss√≠veis causas:\n' +
                        '1. O ID est√° incorreto\n' +
                        '2. A pasta n√£o foi compartilhada com voc√™\n' +
                        '3. A pasta foi deletada\n\n' +
                        'Verifique o ID e as permiss√µes.'
                    );
                } else if (error.status === 403) {
                    alert(
                        '‚ùå ACESSO NEGADO!\n\n' +
                        'Voc√™ n√£o tem permiss√£o para acessar esta pasta.\n\n' +
                        'Solu√ß√£o:\n' +
                        'Configure a pasta como "Qualquer pessoa com o link pode editar"'
                    );
                } else {
                    alert('‚ùå Erro ao acessar pasta: ' + error.message);
                }
            }
        }

        // Statistics
        function loadStatistics() {
            const inspections = safeJSONParse(safeLocalStorageGet('inspections'), []);
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const thisMonth = now.toISOString().slice(0, 7);
            
            document.getElementById('totalInspections').textContent = inspections.length;
            
            const monthCount = inspections.filter(i => i.timestamp && i.timestamp.startsWith(thisMonth)).length;
            document.getElementById('monthInspections').textContent = monthCount;
            
            const todayCount = inspections.filter(i => i.timestamp && i.timestamp.startsWith(today)).length;
            document.getElementById('todayInspections').textContent = todayCount;
            
            let totalPhotos = 0;
            inspections.forEach(i => {
                if (i.photos) {
                    Object.values(i.photos).forEach(photos => {
                        totalPhotos += photos.length;
                    });
                }
            });
            document.getElementById('totalPhotos').textContent = totalPhotos;
            
            loadCommonIssues(inspections);
            loadCities(inspections);
        }

        function loadCommonIssues(inspections) {
            const issues = {};
            
            inspections.forEach(inspection => {
                if (inspection.checklist) {
                    Object.entries(inspection.checklist).forEach(([key, value]) => {
                        if (value.status === 'issue') {
                            const category = key.split('_')[0];
                            issues[category] = (issues[category] || 0) + 1;
                        }
                    });
                }
            });
            
            const chartDiv = document.getElementById('commonIssuesChart');
            let html = '<div style="padding: 20px;">';
            
            const sorted = Object.entries(issues).sort((a, b) => b[1] - a[1]).slice(0, 5);
            
            if (sorted.length === 0) {
                html += '<p style="text-align: center; color: #999;">Nenhum problema registrado ainda</p>';
            } else {
                sorted.forEach(([key, count], index) => {
                    const percentage = (count / inspections.length * 100).toFixed(1);
                    html += `
                        <div style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span><strong>${index + 1}.</strong> ${getCategoryName(key)}</span>
                                <span style="color: #667eea; font-weight: bold;">${count} (${percentage}%)</span>
                            </div>
                            <div style="margin-top: 5px; height: 8px; background: #e0e0e0; border-radius: 4px;">
                                <div style="width: ${percentage}%; height: 100%; background: #667eea; border-radius: 4px;"></div>
                            </div>
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            chartDiv.innerHTML = html;
        }

        function loadCities(inspections) {
            const cities = {};
            
            inspections.forEach(i => {
                const city = i.municipio || 'N√£o informado';
                cities[city] = (cities[city] || 0) + 1;
            });
            
            const sorted = Object.entries(cities).sort((a, b) => b[1] - a[1]).slice(0, 10);
            
            let html = '';
            sorted.forEach(([city, count], index) => {
                html += `
                    <div style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e0e0e0;">
                        <span><strong>${index + 1}.</strong> ${city}</span>
                        <span style="color: #667eea; font-weight: bold;">${count} inspe√ß√µes</span>
                    </div>
                `;
            });
            
            document.getElementById('citiesList').innerHTML = html || '<p style="text-align: center; color: #999;">Nenhuma inspe√ß√£o realizada ainda</p>';
        }

        function refreshStatistics() {
            loadStatistics();
            playSound('success');
        }

        function exportStatistics() {
            const inspections = safeJSONParse(safeLocalStorageGet('inspections'), []);
            const stats = {
                total: inspections.length,
                exportDate: new Date().toISOString(),
                inspections: inspections
            };
            
            const blob = new Blob([JSON.stringify(stats, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `estatisticas_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            
            playSound('success');
        }

        // Tutorial
        let currentTutorialStep = 0;

        function showTutorial() {
            currentTutorialStep = 0;
            document.getElementById('tutorialOverlay').classList.add('active');
            renderTutorialStep();
        }

        function closeTutorial() {
            document.getElementById('tutorialOverlay').classList.remove('active');
        }

        function nextTutorialStep() {
            if (currentTutorialStep < tutorialSteps.length - 1) {
                currentTutorialStep++;
                renderTutorialStep();
            } else {
                closeTutorial();
            }
        }

        function previousTutorialStep() {
            if (currentTutorialStep > 0) {
                currentTutorialStep--;
                renderTutorialStep();
            }
        }

        function renderTutorialStep() {
            const step = tutorialSteps[currentTutorialStep];
            const stepsDiv = document.getElementById('tutorialSteps');
            
            stepsDiv.innerHTML = `
                <div class="tutorial-step active">
                    <h3>${step.title}</h3>
                    <p style="font-size: 16px; line-height: 1.6; color: #555;">${step.content}</p>
                </div>
            `;
            
            const progressDiv = document.getElementById('tutorialProgress');
            let dotsHTML = '';
            tutorialSteps.forEach((_, index) => {
                dotsHTML += `<div class="tutorial-progress-dot ${index === currentTutorialStep ? 'active' : ''}"></div>`;
            });
            progressDiv.innerHTML = dotsHTML;
        }

        // Modals
        function showChangelog() {
            alert(`
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         üìã CHANGELOG - HIST√ìRICO DE VERS√ïES
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üÜï Vers√£o V00 - Novembro 2025
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚ú® Lan√ßamento inicial do sistema

Funcionalidades:
‚Ä¢ ‚úÖ Inspe√ß√£o Inicial
‚Ä¢ ‚úÖ Inspe√ß√£o Completa
‚Ä¢ ‚úÖ Upload de fotos ilimitadas
‚Ä¢ ‚úÖ Salvamento autom√°tico no Google Drive
‚Ä¢ ‚úÖ Gera√ß√£o de relat√≥rios
‚Ä¢ ‚úÖ Organiza√ß√£o autom√°tica em pastas
‚Ä¢ ‚úÖ √çcones informativos sobre patologias
‚Ä¢ ‚úÖ Interface responsiva
‚Ä¢ ‚úÖ Tela de configura√ß√µes completa
‚Ä¢ ‚úÖ Estat√≠sticas detalhadas
‚Ä¢ ‚úÖ Tutorial interativo
‚Ä¢ ‚úÖ Personaliza√ß√£o de tema e cores

üîß Melhorias Futuras Planejadas:
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚Ä¢ Modo offline
‚Ä¢ Assinatura digital
‚Ä¢ Envio por email
‚Ä¢ Anota√ß√£o em fotos

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            `);
        }

        function showTermsOfUse() {
            alert(`
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         üìÑ TERMOS DE USO
         Sistema de Inspe√ß√£o Residencial
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

1. ACEITE DOS TERMOS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Ao utilizar este sistema, voc√™ concorda com 
os termos aqui descritos.

2. USO DO SISTEMA
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚Ä¢ O sistema √© fornecido "como est√°"
‚Ä¢ Destinado a uso profissional em inspe√ß√µes
‚Ä¢ Voc√™ √© respons√°vel pelos dados inseridos
‚Ä¢ Mantenha backup de informa√ß√µes importantes

3. ARMAZENAMENTO DE DADOS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚Ä¢ Dados salvos no seu Google Drive pessoal
‚Ä¢ Dados tamb√©m podem ser salvos localmente
‚Ä¢ Voc√™ controla o acesso aos seus dados
‚Ä¢ O desenvolvedor N√ÉO tem acesso aos dados

4. PRIVACIDADE
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚Ä¢ O sistema n√£o coleta dados pessoais
‚Ä¢ Informa√ß√µes de login s√£o do Google OAuth
‚Ä¢ Nenhum dado √© enviado para servidores
‚Ä¢ Todo processamento √© local (navegador)

5. RESPONSABILIDADES
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚Ä¢ O usu√°rio √© respons√°vel pela veracidade
  dos dados inseridos nas inspe√ß√µes
‚Ä¢ O desenvolvedor n√£o se responsabiliza por
  decis√µes tomadas baseadas nas inspe√ß√µes
‚Ä¢ Recomenda-se sempre an√°lise profissional
  qualificada dos resultados

6. SUPORTE
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚Ä¢ Contato: engenheirobrunomachado@gmail.com
‚Ä¢ WhatsApp: (21) 99497-2971
‚Ä¢ Suporte limitado a d√∫vidas t√©cnicas

7. LIMITA√á√ÉO DE RESPONSABILIDADE
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚Ä¢ O sistema √© uma ferramenta auxiliar
‚Ä¢ N√£o substitui laudo t√©cnico profissional
‚Ä¢ Use com responsabilidade e bom senso

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Vers√£o V00 - Novembro 2025
¬© Eng. Bruno Machado - Todos os direitos reservados
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

Ao continuar usando, voc√™ aceita estes termos.
            `);
        }

        // Sounds
        function playSound(type) {
            if (!userSettings.soundEffects) return;
            
            try {
                const context = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = context.createOscillator();
                const gainNode = context.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(context.destination);
                
                if (type === 'success') {
                    oscillator.frequency.value = 800;
                    gainNode.gain.setValueAtTime(0.3, context.currentTime);
                    oscillator.start(context.currentTime);
                    oscillator.stop(context.currentTime + 0.1);
                }
            } catch (e) {
                // Silence audio errors
            }
        }

        // Custom Fields
        function showAddCustomFieldModal() {
            alert('Funcionalidade de campos personalizados ser√° implementada em breve!');
        }

        // Monitor de conex√£o online/offline
        function updateOnlineStatus() {
            const indicator = document.getElementById('onlineIndicator');
            const text = document.getElementById('onlineText');
            
            if (navigator.onLine) {
                indicator.textContent = 'üü¢';
                text.textContent = 'Online';
            } else {
                indicator.textContent = 'üî¥';
                text.textContent = 'Offline';
            }
        }

        // Eventos de conex√£o
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);

        // Initialize on page load
        window.addEventListener('load', async () => {
            // Atualizar status de conex√£o
            updateOnlineStatus();
            
            // Inicializar sistema de autentica√ß√£o
            initializeAuthSystem();
            
            // Carregar configura√ß√£o de pasta compartilhada
            loadSharedFolderConfig();
            
            // Load user settings
            loadSettings();
            
            // SEMPRE inicializar Google Drive API (necess√°rio para carregar bibliotecas)
            console.log('üîÑ Inicializando APIs do Google Drive...');
            initializeGoogleDrive();
            
            // Verificar se h√° usu√°rio logado
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    
                    // VALIDAR SE O USU√ÅRIO AINDA EXISTE NO SISTEMA
                    const users = JSON.parse(localStorage.getItem('systemUsers')) || [];
                    const userExists = users.find(u => u.username === currentUser.username);
                    
                    if (!userExists) {
                        console.warn('‚ö†Ô∏è Usu√°rio salvo n√£o existe mais no sistema. Fazendo logout...');
                        localStorage.removeItem('currentUser');
                        currentUser = null;
                        // Garantir que tela de login est√° vis√≠vel
                        document.getElementById('loginScreen').classList.add('active');
                        alert('‚ö†Ô∏è Sua sess√£o expirou. Por favor, fa√ßa login novamente.');
                        return;
                    }
                    
                    console.log('‚úÖ Sess√£o ativa encontrada:', currentUser.name);
                    
                    // Ocultar tela de login
                    document.getElementById('loginScreen').classList.remove('active');
                    
                    // Atualizar interface
                    document.getElementById('currentUserDisplay').textContent = currentUser.name;
                    if (currentUser.isAdmin) {
                        document.getElementById('adminMenuButton').style.display = 'block';
                    }
                    
                    // Aguardar APIs carregarem e solicitar autoriza√ß√£o automaticamente
                    showProgress('Conectando ao Google Drive...');
                    
                    const waitForInitAndConnect = setInterval(() => {
                        if (gapiInited && gisInited) {
                            clearInterval(waitForInitAndConnect);
                            hideProgress();
                            
                            // Verificar se j√° tem accessToken v√°lido
                            if (accessToken) {
                                console.log('‚úÖ Token existente encontrado, conectando ao Drive...');
                                // Verificar acesso √† pasta compartilhada
                                ensureSharedFolderAccess().then(() => {
                                    console.log('‚úÖ Acesso √† pasta compartilhada confirmado');
                                }).catch(error => {
                                    console.warn('‚ö†Ô∏è Aviso:', error.message);
                                    console.warn('‚ö†Ô∏è Configure a pasta compartilhada em Configura√ß√µes ‚Üí Google Drive ‚Üí Pasta Centralizada');
                                });
                                showMainMenu();
                            } else {
                                console.log('üîê Solicitando autoriza√ß√£o do Google...');
                                requestAccessToken();
                            }
                        }
                    }, 100);
                    
                    // Timeout de seguran√ßa
                    setTimeout(() => {
                        clearInterval(waitForInitAndConnect);
                        if (!gapiInited || !gisInited) {
                            hideProgress();
                            console.warn('‚ö†Ô∏è Timeout ao inicializar APIs do Google. Continuando em modo local.');
                            showMainMenu(); // Mostrar menu mesmo sem Drive
                        }
                    }, 10000);
                    
                } catch (e) {
                    console.error('Erro ao restaurar sess√£o:', e);
                    localStorage.removeItem('currentUser');
                    currentUser = null;
                    // Garantir que tela de login est√° vis√≠vel
                    document.getElementById('loginScreen').classList.add('active');
                    alert('‚ö†Ô∏è Erro ao restaurar sess√£o. Por favor, fa√ßa login novamente.');
                }
            } else {
                console.log('üîê Nenhuma sess√£o ativa. Aguardando login...');
                // GARANTIR que a tela de login est√° vis√≠vel
                document.getElementById('loginScreen').classList.add('active');
            }
        });
    </script>
</body>
</html>